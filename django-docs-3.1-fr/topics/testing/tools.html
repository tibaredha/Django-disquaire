
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="fr">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Outils de test &#8212; Documentation Django 3.1.3.dev</title>
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Recherche" href="../../search.html" />
    <link rel="next" title="Thématiques de tests avancées" href="advanced.html" />
    <link rel="prev" title="Écriture et lancement de tests" href="overview.html" />



 
<script src="../../templatebuiltins.js"></script>
<script>
(function($) {
    if (!django_template_builtins) {
       // templatebuiltins.js missing, do nothing.
       return;
    }
    $(document).ready(function() {
        // Hyperlink Django template tags and filters
        var base = "../../ref/templates/builtins.html";
        if (base == "#") {
            // Special case for builtins.html itself
            base = "";
        }
        // Tags are keywords, class '.k'
        $("div.highlight\\-html\\+django span.k").each(function(i, elem) {
             var tagname = $(elem).text();
             if ($.inArray(tagname, django_template_builtins.ttags) != -1) {
                 var fragment = tagname.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + tagname + "</a>");
             }
        });
        // Filters are functions, class '.nf'
        $("div.highlight\\-html\\+django span.nf").each(function(i, elem) {
             var filtername = $(elem).text();
             if ($.inArray(filtername, django_template_builtins.tfilters) != -1) {
                 var fragment = filtername.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + filtername + "</a>");
             }
        });
    });
})(jQuery);(function($) {
    $(document).ready(function() {
        $(".c-tab-unix").on("click", function() {
            $("section.c-content-unix").show();
            $("section.c-content-win").hide();
            $(".c-tab-unix").prop("checked", true);
        });
        $(".c-tab-win").on("click", function() {
            $("section.c-content-win").show();
            $("section.c-content-unix").hide();
            $(".c-tab-win").prop("checked", true);
        });
    });
})(jQuery);</script>
<link rel="stylesheet" href="../../_static/console-tabs.css" type="text/css" />
  </head><body>

    <div class="document">
  <div id="custom-doc" class="yui-t6">
    <div id="hd">
      <h1><a href="../../index.html">Documentation Django 3.1.3.dev</a></h1>
      <div id="global-nav">
        <a title="Home page" href="../../index.html">Home</a>  |
        <a title="Table of contents" href="../../contents.html">Table of contents</a>  |
        <a title="Global index" href="../../genindex.html">Index</a>  |
        <a title="Module index" href="../../py-modindex.html">Modules</a>
      </div>
      <div class="nav">
    &laquo; <a href="overview.html" title="Écriture et lancement de tests">previous</a>
     |
    <a href="../index.html" title="Utilisation de Django" accesskey="U">up</a>
   |
    <a href="advanced.html" title="Thématiques de tests avancées">next</a> &raquo;</div>
    </div>

    <div id="bd">
      <div id="yui-main">
        <div class="yui-b">
          <div class="yui-g" id="topics-testing-tools">
            
  <div class="section" id="s-testing-tools">
<span id="testing-tools"></span><h1>Outils de test<a class="headerlink" href="#testing-tools" title="Lien permanent vers ce titre">¶</a></h1>
<p>Django propose un petit set d’outils bien pratiques lors de l’écriture de tests.</p>
<div class="section" id="s-the-test-client">
<span id="s-test-client"></span><span id="the-test-client"></span><span id="test-client"></span><h2>Le client de test<a class="headerlink" href="#the-test-client" title="Lien permanent vers ce titre">¶</a></h2>
<p>Le client de test est une classe Python se comportant comme un navigateur Web simpliste, permettant de tester les vues et d’interagir par programmation avec votre application Django.</p>
<p>Voici plusieurs choses que vous pouvez faire avec le client de test&nbsp;:</p>
<ul class="simple">
<li>Simuler des requêtes GET et POST sur une URL et examiner la réponse, que ce soit les détails HTTP de bas niveau (en-têtes de la réponse et codes d’état) ou le contenu de la page renvoyée.</li>
<li>Voir la chaîne des redirections (le cas échéant) et contrôler l’URL et le code de statut à chaque étape.</li>
<li>Tester qu’une requête données est rendue par un gabarit Django donné, et que le contexte du gabarit contient certaines valeurs.</li>
</ul>
<p>Notez que le client de test n’est pas conçu pour remplacer <a class="reference external" href="http://seleniumhq.org/">Selenium</a> ou d’autres systèmes utilisant un navigateur réel. Le client de test de Django a un objectif différent. En bref&nbsp;:</p>
<ul class="simple">
<li>Utiliser le client de test de Django pour confirmer que le gabarit correct a été utilisé pour le rendu et que ce gabarit à reçu les bonnes données de contexte.</li>
<li>Utilisez des systèmes basés sur de vrais navigateurs comme <a class="reference external" href="http://seleniumhq.org/">Selenium</a> pour tester le HTML <em>produit</em> et le <em>comportement</em> des pages Web, en particulier les fonctionnalités JavaScript. Django offre aussi une prise en charge spéciale pour ces systèmes&nbsp;; consultez la section sur <a class="reference internal" href="#django.test.LiveServerTestCase" title="django.test.LiveServerTestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">LiveServerTestCase</span></code></a> pour plus de détails.</li>
</ul>
<p>Une suite de tests complète devrait utiliser une combinaison de ces deux types.</p>
<div class="section" id="s-overview-and-a-quick-example">
<span id="overview-and-a-quick-example"></span><h3>Aperçu et exemple rapide<a class="headerlink" href="#overview-and-a-quick-example" title="Lien permanent vers ce titre">¶</a></h3>
<p>Pour utiliser le client de test, créez une instance de <code class="docutils literal notranslate"><span class="pre">django.test.Client</span></code> et récupérez des pages Web&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">django.test</span> <span class="k">import</span> <span class="n">Client</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">response</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/login/&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;john&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;smith&#39;</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
<span class="go">200</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">response</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/customer/details/&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">response</span><span class="o">.</span><span class="n">content</span>
<span class="go">b&#39;&lt;!DOCTYPE html...&#39;</span>
</pre></div>
</div>
<p>Comme cet exemple le suggère, vous pouvez créer des instances de <code class="docutils literal notranslate"><span class="pre">Client</span></code> à partir d’une session de l’interpréteur Python interactif.</p>
<p>Signalons quelques éléments importants au sujet du fonctionnement du client de test&nbsp;:</p>
<ul>
<li><p class="first">Le client de test n’a <em>pas</em> besoin que le serveur Web soit lancé. En fait, il fonctionne tout à fait correctement sans aucun serveur Web actif&nbsp;! Et cela parce qu’il s’adresse directement à l’infrastructure Django sans passer par la couche HTTP. Cela permet d’accélérer le fonctionnement des tests unitaires.</p>
</li>
<li><p class="first">Lors de la récupération des pages, n’oubliez pas de n’indiquer que le <em>chemin</em> de l’URL, sans mentionner tout le nom de domaine. Par exemple, ceci est correct&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/login/&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Mais pas ceci&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://www.example.com/login/&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Le client de test n’est pas capable de récupérer des pages Web qui ne sont pas basées sur votre projet Django. Si vous avez besoin de récupérer d’autres pages Web, utilisez un module standard de la bibliothèque Python, comme <a class="reference external" href="https://docs.python.org/3/library/urllib.html#module-urllib" title="(disponible dans Python v3.9)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">urllib</span></code></a>.</p>
</li>
<li><p class="first">Pour résoudre des URL, le client de test utilise la configuration d’URL qui est désignée par le réglage <a class="reference internal" href="../../ref/settings.html#std:setting-ROOT_URLCONF"><code class="xref std std-setting docutils literal notranslate"><span class="pre">ROOT_URLCONF</span></code></a>.</p>
</li>
<li><p class="first">Même si l’exemple ci-dessus fonctionne dans un interpréteur Python interactif, certaines fonctionnalités du client de test, notamment celles liées aux gabarits, ne sont disponibles que <em>lorsque les tests sont lancés</em>.</p>
<p>Ceci s’explique par le fait que le lanceur de tests de Django fait sa propre cuisine pour déterminer quel gabarit a été chargé pour une vue donnée. Cette «&nbsp;cuisine&nbsp;» (essentiellement un correctif en mémoire du système de gabarits de Django) n’est opérée que durant le fonctionnement des tests.</p>
</li>
<li><p class="first">Par défaut, le client de test désactive tous les contrôles CSRF effectués par votre site.</p>
<p>Si pour une raison quelconque vous * voulez* que le client de test effectue les contrôles CSRF, vous pouvez créer une instance du client de test avec les contrôles CSRF actifs. Pour cela, passez le paramètre <code class="docutils literal notranslate"><span class="pre">enforce_csrf_checks</span></code> au moment de créer le client&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">django.test</span> <span class="k">import</span> <span class="n">Client</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">csrf_client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">enforce_csrf_checks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="s-making-requests">
<span id="making-requests"></span><h3>Lancement de requêtes<a class="headerlink" href="#making-requests" title="Lien permanent vers ce titre">¶</a></h3>
<p>La classe <code class="docutils literal notranslate"><span class="pre">django.test.Client</span></code> permet de simuler des requêtes HTTP.</p>
<dl class="class">
<dt id="django.test.Client">
<em class="property">class </em><code class="descname">Client</code>(<em>enforce_csrf_checks=False</em>, <em>json_encoder=DjangoJSONEncoder</em>, <em>**defaults</em>)<a class="headerlink" href="#django.test.Client" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Aucun paramètre n’est obligatoire au moment de la création de l’instance. Vous pouvez cependant indiquer des paramètres nommés pour définir des en-têtes par défaut. Dans l’exemple suivant, un en-tête HTTP <code class="docutils literal notranslate"><span class="pre">User-Agent</span></code> est envoyé avec chaque requête&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">HTTP_USER_AGENT</span><span class="o">=</span><span class="s1">&#39;Mozilla/5.0&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Les valeurs de paramètres nommés passés dans <code class="docutils literal notranslate"><span class="pre">extra</span></code> aux méthodes <a class="reference internal" href="#django.test.Client.get" title="django.test.Client.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get()</span></code></a>, <a class="reference internal" href="#django.test.Client.post" title="django.test.Client.post"><code class="xref py py-meth docutils literal notranslate"><span class="pre">post()</span></code></a>, etc. ont la priorité sur les valeurs par défaut transmises au constructeur de la classe.</p>
<p>Le paramètre <code class="docutils literal notranslate"><span class="pre">enforce_csrf_checks</span></code> peut être utilisé pour tester la protection CSRF (voir au-dessus).</p>
<p>Le paramètre <code class="docutils literal notranslate"><span class="pre">json_encoder</span></code> permet de définir un codeur JSON personnalisé pour la sérialisation JSON décrite dans <a class="reference internal" href="#django.test.Client.post" title="django.test.Client.post"><code class="xref py py-meth docutils literal notranslate"><span class="pre">post()</span></code></a>.</p>
<p>Le paramètre <code class="docutils literal notranslate"><span class="pre">raise_request_exception</span></code> permet de contrôler si les exceptions générées pendant la requête doivent aussi être générées dans le test. Vaut <code class="docutils literal notranslate"><span class="pre">True</span></code> par défaut.</p>
<div class="versionadded">
<span class="title">New in Django 3.0:</span> <p>Le paramètre <code class="docutils literal notranslate"><span class="pre">raise_request_exception</span></code> a été ajouté.</p>
</div>
<p>Dès que vous avez à disposition une instance de <code class="docutils literal notranslate"><span class="pre">Client</span></code>, vous pouvez appeler au choix l’une des méthodes suivantes&nbsp;:</p>
<dl class="method">
<dt id="django.test.Client.get">
<code class="descname">get</code>(<em>path</em>, <em>data=None</em>, <em>follow=False</em>, <em>secure=False</em>, <em>**extra</em>)<a class="headerlink" href="#django.test.Client.get" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Procède à une requête GET utilisant le chemin <code class="docutils literal notranslate"><span class="pre">path</span></code> indiqué et renvoie un objet <code class="docutils literal notranslate"><span class="pre">Response</span></code>, qui est documenté plus bas.</p>
<p>Les paires clé-valeur dans le dictionnaire <code class="docutils literal notranslate"><span class="pre">data</span></code> servent à créer les données utiles de GET. Par exemple&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/customers/details/&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;fred&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">})</span>
</pre></div>
</div>
<p>…aboutit à l’évaluation d’une requête GET équivalente à&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/customers/details/?name=fred&amp;age=7
</pre></div>
</div>
<p>Le paramètre nommé <code class="docutils literal notranslate"><span class="pre">extra</span></code> peut être utilisé pour indiquer les en-têtes envoyés avec la requête. Par exemple&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/customers/details/&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;fred&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">},</span>
<span class="gp">... </span>      <span class="n">HTTP_ACCEPT</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>…envoie l’en-tête HTTP <code class="docutils literal notranslate"><span class="pre">HTTP_ACCEPT</span></code> à la vue de détail, ce qui constitue une bonne manière de tester des chemins de code utilisant la méthode <a class="reference internal" href="../../ref/request-response.html#django.http.HttpRequest.accepts" title="django.http.HttpRequest.accepts"><code class="xref py py-meth docutils literal notranslate"><span class="pre">django.http.HttpRequest.accepts()</span></code></a>.</p>
<div class="admonition-cgi-specification admonition">
<p class="first admonition-title">Spécification CGI</p>
<p class="last">Les en-têtes envoyés par <code class="docutils literal notranslate"><span class="pre">**extra</span></code> doivent respecter la spécification <a class="reference external" href="https://www.w3.org/CGI/">CGI</a>. Par exemple, pour émuler un en-tête «&nbsp;Host&nbsp;» différent de celui envoyé dans la requête HTTP du navigateur vers le serveur, il faut transmettre <code class="docutils literal notranslate"><span class="pre">HTTP_HOST</span></code>.</p>
</div>
<p>Si vous disposez déjà des paramètres GET sous une forme déjà codée pour l’URL, vous pouvez utiliser cette forme au lieu du paramètre <code class="docutils literal notranslate"><span class="pre">data</span></code>. Par exemple, la requête GET précédente pourrait aussi être émise par&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/customers/details/?name=fred&amp;age=7&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Si vous fournissez à la fois une URL contenant des données GET codée et un paramètre <code class="docutils literal notranslate"><span class="pre">data</span></code>, ce dernier a la priorité.</p>
<p>Si vous définissez <code class="docutils literal notranslate"><span class="pre">follow</span></code> à <code class="docutils literal notranslate"><span class="pre">True</span></code>, le client suit d’éventuelles redirections et l’objet réponse possédera un attribut <code class="docutils literal notranslate"><span class="pre">redirect_chain</span></code> contenant des tuples formés des URL intermédiaires et de leur code d’état.</p>
<p>Si vous aviez une URL <code class="docutils literal notranslate"><span class="pre">/redirect_me/</span></code> redirigeant vers <code class="docutils literal notranslate"><span class="pre">/next/</span></code>, redirigeant lui-même vers <code class="docutils literal notranslate"><span class="pre">/final/</span></code>, voici ce que vous obtiendriez&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">response</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/redirect_me/&#39;</span><span class="p">,</span> <span class="n">follow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">response</span><span class="o">.</span><span class="n">redirect_chain</span>
<span class="go">[(&#39;http://testserver/next/&#39;, 302), (&#39;http://testserver/final/&#39;, 302)]</span>
</pre></div>
</div>
<p>Si vous définissez <code class="docutils literal notranslate"><span class="pre">secure</span></code> à <code class="docutils literal notranslate"><span class="pre">True</span></code>, le client émule une requête HTTPS.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.Client.post">
<code class="descname">post</code>(<em>path</em>, <em>data=None</em>, <em>content_type=MULTIPART_CONTENT</em>, <em>follow=False</em>, <em>secure=False</em>, <em>**extra</em>)<a class="headerlink" href="#django.test.Client.post" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Procède à une requête POST utilisant le chemin <code class="docutils literal notranslate"><span class="pre">path</span></code> indiqué et renvoie un objet <code class="docutils literal notranslate"><span class="pre">Response</span></code>, qui est documenté plus bas.</p>
<p>Les paires clé-valeur dans le dictionnaire <code class="docutils literal notranslate"><span class="pre">data</span></code> servent à créer les données de soumission POST. Par exemple&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/login/&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;fred&#39;</span><span class="p">,</span> <span class="s1">&#39;passwd&#39;</span><span class="p">:</span> <span class="s1">&#39;secret&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>…aboutit à l’évaluation d’une requête POST vers cette URL&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">login</span><span class="o">/</span>
</pre></div>
</div>
<p>…contenant ces données POST&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">name</span><span class="o">=</span><span class="n">fred</span><span class="o">&amp;</span><span class="n">passwd</span><span class="o">=</span><span class="n">secret</span>
</pre></div>
</div>
<p>Si vous indiquez <em class="mimetype">application/json</em> dans <code class="docutils literal notranslate"><span class="pre">content_type</span></code>, les données <code class="docutils literal notranslate"><span class="pre">data</span></code> sont sérialisées en utilisant <a class="reference external" href="https://docs.python.org/3/library/json.html#json.dumps" title="(disponible dans Python v3.9)"><code class="xref py py-func docutils literal notranslate"><span class="pre">json.dumps()</span></code></a> s’il s’agit d’un dict, d’une liste ou d’un tuple. La sérialisation est appliquée par défaut avec <a class="reference internal" href="../serialization.html#django.core.serializers.json.DjangoJSONEncoder" title="django.core.serializers.json.DjangoJSONEncoder"><code class="xref py py-class docutils literal notranslate"><span class="pre">DjangoJSONEncoder</span></code></a>, mais cette classe peut être remplacée en fournissant le paramètre <code class="docutils literal notranslate"><span class="pre">json_encoder</span></code> à <a class="reference internal" href="#django.test.Client" title="django.test.Client"><code class="xref py py-class docutils literal notranslate"><span class="pre">Client</span></code></a>. Cette sérialisation se produit également pour les requêtes <a class="reference internal" href="#django.test.Client.put" title="django.test.Client.put"><code class="xref py py-meth docutils literal notranslate"><span class="pre">put()</span></code></a>, <a class="reference internal" href="#django.test.Client.patch" title="django.test.Client.patch"><code class="xref py py-meth docutils literal notranslate"><span class="pre">patch()</span></code></a> et <a class="reference internal" href="#django.test.Client.delete" title="django.test.Client.delete"><code class="xref py py-meth docutils literal notranslate"><span class="pre">delete()</span></code></a>.</p>
<p>Si vous renseignez tout autre <code class="docutils literal notranslate"><span class="pre">content_type</span></code> (par ex. <em class="mimetype">text/xml</em> pour des données utiles XML), le contenu de <code class="docutils literal notranslate"><span class="pre">data</span></code> est envoyé tel quel dans la requête POST, en plaçant le contenu de <code class="docutils literal notranslate"><span class="pre">content_type</span></code> dans l’en-tête HTTP <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code>.</p>
<p>Si le paramètre <code class="docutils literal notranslate"><span class="pre">content_type</span></code> n’est pas renseigné, les valeurs contenues dans <code class="docutils literal notranslate"><span class="pre">data</span></code> sont transmises avec un type de contenu <em class="mimetype">multipart/form-data</em>. Dans ce cas, les paires clé-valeur de <code class="docutils literal notranslate"><span class="pre">data</span></code> sont codées sous forme de message composite (<code class="docutils literal notranslate"><span class="pre">multipart</span></code>) et servent à créer les données utiles de POST.</p>
<p>Pour envoyer plusieurs valeurs pour un même clé, par exemple pour indiquer les sélections d’un élément <code class="docutils literal notranslate"><span class="pre">&lt;select</span> <span class="pre">multiple&gt;</span></code>, indiquez les valeurs de la clé sous forme de liste ou de tuple. Par exemple, le contenu suivant de <code class="docutils literal notranslate"><span class="pre">data</span></code> envoie trois valeurs sélectionnées pour le champ nommé <code class="docutils literal notranslate"><span class="pre">choices</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;choices&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)}</span>
</pre></div>
</div>
<p>L’envoi de fichiers est un cas particulier. Pour envoyer un fichier par POST, il suffit d’indiquer comme clé le nom du champ de fichier et comme valeur un pointeur de fichier référençant le fichier à envoyer. Par exemple&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;wishlist.doc&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">c</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/customers/wishes/&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;fred&#39;</span><span class="p">,</span> <span class="s1">&#39;attachment&#39;</span><span class="p">:</span> <span class="n">fp</span><span class="p">})</span>
</pre></div>
</div>
<p>(Le nom <code class="docutils literal notranslate"><span class="pre">attachment</span></code> n’a ici aucune signification particulière&nbsp;; utilisez le nom de champ attendu par votre code de traitement de fichier.)</p>
<p>Il est aussi possible de fournir un objet de type fichier (par ex. <a class="reference external" href="https://docs.python.org/3/library/io.html#io.StringIO" title="(disponible dans Python v3.9)"><code class="xref py py-class docutils literal notranslate"><span class="pre">StringIO</span></code></a> ou <a class="reference external" href="https://docs.python.org/3/library/io.html#io.BytesIO" title="(disponible dans Python v3.9)"><code class="xref py py-class docutils literal notranslate"><span class="pre">BytesIO</span></code></a>) comme pointeur de fichier. Si le fichier est destiné à un champ <a class="reference internal" href="../../ref/models/fields.html#django.db.models.ImageField" title="django.db.models.ImageField"><code class="xref py py-class docutils literal notranslate"><span class="pre">ImageField</span></code></a>, l’objet a besoin d’un attribut  <code class="docutils literal notranslate"><span class="pre">name</span></code> passant la validation de <a class="reference internal" href="../../ref/validators.html#django.core.validators.validate_image_file_extension" title="django.core.validators.validate_image_file_extension"><code class="xref py py-data docutils literal notranslate"><span class="pre">validate_image_file_extension</span></code></a>. Par exemple&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">BytesIO</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">img</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;mybinarydata&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">img</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;myimage.jpg&#39;</span>
</pre></div>
</div>
<p>Notez que si vous souhaitez utiliser le même pointeur de fichier pour plusieurs appels à <code class="docutils literal notranslate"><span class="pre">post()</span></code>, vous devrez manuellement réinitialiser ce pointeur entre les requêtes. La façon la plus simple de le faire manuellement est de fermer le fichier après qu’il a été fourni à <code class="docutils literal notranslate"><span class="pre">post()</span></code>, comme cela est fait dans l’exemple ci-dessus.</p>
<p>Vous devez aussi être certain que le fichier est ouvert d’une manière autorisant les données à être lues. Si votre fichier contient des données binaires telles qu’une image, cela signifie que vous devrez ouvrir le fichier en mode <code class="docutils literal notranslate"><span class="pre">rb</span></code> (read binary).</p>
<p>Le paramètre <code class="docutils literal notranslate"><span class="pre">extra</span></code> joue le même rôle que pour <a class="reference internal" href="#django.test.Client.get" title="django.test.Client.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Client.get()</span></code></a>.</p>
<p>Si l’URL indiquée pour la requête POST contient des paramètres codés, ceux-ci sont placés dans les données <code class="docutils literal notranslate"><span class="pre">request.GET</span></code>. Par exemple, si vous effectuez la requête&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/login/?visitor=true&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;fred&#39;</span><span class="p">,</span> <span class="s1">&#39;passwd&#39;</span><span class="p">:</span> <span class="s1">&#39;secret&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>…la vue traitant la requête peut consulter <code class="docutils literal notranslate"><span class="pre">request.POST</span></code> pour obtenir les données du nom et du mot de passe, et <code class="docutils literal notranslate"><span class="pre">request.GET</span></code> pour savoir si l’utilisateur est un visiteur.</p>
<p>Si vous définissez <code class="docutils literal notranslate"><span class="pre">follow</span></code> à <code class="docutils literal notranslate"><span class="pre">True</span></code>, le client suit d’éventuelles redirections et l’objet réponse possédera un attribut <code class="docutils literal notranslate"><span class="pre">redirect_chain</span></code> contenant des tuples formés des URL intermédiaires et de leur code d’état.</p>
<p>Si vous définissez <code class="docutils literal notranslate"><span class="pre">secure</span></code> à <code class="docutils literal notranslate"><span class="pre">True</span></code>, le client émule une requête HTTPS.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.Client.head">
<code class="descname">head</code>(<em>path</em>, <em>data=None</em>, <em>follow=False</em>, <em>secure=False</em>, <em>**extra</em>)<a class="headerlink" href="#django.test.Client.head" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Procède à une requête HEAD utilisant le chemin <code class="docutils literal notranslate"><span class="pre">path</span></code> indiqué et renvoie un objet <code class="docutils literal notranslate"><span class="pre">Response</span></code>. Cette méthode fonctionne comme <a class="reference internal" href="#django.test.Client.get" title="django.test.Client.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Client.get()</span></code></a>, y compris les paramètres <code class="docutils literal notranslate"><span class="pre">follow</span></code>, <code class="docutils literal notranslate"><span class="pre">secure</span></code> et <code class="docutils literal notranslate"><span class="pre">extra</span></code> à la seule exception qu’aucun corps de message n’est renvoyé.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.Client.options">
<code class="descname">options</code>(<em>path</em>, <em>data=''</em>, <em>content_type='application/octet-stream'</em>, <em>follow=False</em>, <em>secure=False</em>, <em>**extra</em>)<a class="headerlink" href="#django.test.Client.options" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Procède à une requête OPTIONS utilisant le chemin <code class="docutils literal notranslate"><span class="pre">path</span></code> indiqué et renvoie un objet <code class="docutils literal notranslate"><span class="pre">Response</span></code>. Utile pour tester les interfaces de type «&nbsp;REST&nbsp;».</p>
<p>Lorsque <code class="docutils literal notranslate"><span class="pre">data</span></code> est renseigné, il est utilisé comme corps de requête et un en-tête <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> est défini avec le contenu de <code class="docutils literal notranslate"><span class="pre">content_type</span></code>.</p>
<p>Les paramètres <code class="docutils literal notranslate"><span class="pre">follow</span></code>, <code class="docutils literal notranslate"><span class="pre">secure</span></code> et <code class="docutils literal notranslate"><span class="pre">extra</span></code> jouent le même rôle que pour <a class="reference internal" href="#django.test.Client.get" title="django.test.Client.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Client.get()</span></code></a>.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.Client.put">
<code class="descname">put</code>(<em>path</em>, <em>data=''</em>, <em>content_type='application/octet-stream'</em>, <em>follow=False</em>, <em>secure=False</em>, <em>**extra</em>)<a class="headerlink" href="#django.test.Client.put" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Procède à une requête PUT utilisant le chemin <code class="docutils literal notranslate"><span class="pre">path</span></code> indiqué et renvoie un objet <code class="docutils literal notranslate"><span class="pre">Response</span></code>. Utile pour tester les interfaces de type «&nbsp;REST&nbsp;».</p>
<p>Lorsque <code class="docutils literal notranslate"><span class="pre">data</span></code> est renseigné, il est utilisé comme corps de requête et un en-tête <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> est défini avec le contenu de <code class="docutils literal notranslate"><span class="pre">content_type</span></code>.</p>
<p>Les paramètres <code class="docutils literal notranslate"><span class="pre">follow</span></code>, <code class="docutils literal notranslate"><span class="pre">secure</span></code> et <code class="docutils literal notranslate"><span class="pre">extra</span></code> jouent le même rôle que pour <a class="reference internal" href="#django.test.Client.get" title="django.test.Client.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Client.get()</span></code></a>.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.Client.patch">
<code class="descname">patch</code>(<em>path</em>, <em>data=''</em>, <em>content_type='application/octet-stream'</em>, <em>follow=False</em>, <em>secure=False</em>, <em>**extra</em>)<a class="headerlink" href="#django.test.Client.patch" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Procède à une requête PATCH utilisant le chemin <code class="docutils literal notranslate"><span class="pre">path</span></code> indiqué et renvoie un objet <code class="docutils literal notranslate"><span class="pre">Response</span></code>. Utile pour tester les interfaces de type «&nbsp;REST&nbsp;».</p>
<p>Les paramètres <code class="docutils literal notranslate"><span class="pre">follow</span></code>, <code class="docutils literal notranslate"><span class="pre">secure</span></code> et <code class="docutils literal notranslate"><span class="pre">extra</span></code> jouent le même rôle que pour <a class="reference internal" href="#django.test.Client.get" title="django.test.Client.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Client.get()</span></code></a>.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.Client.delete">
<code class="descname">delete</code>(<em>path</em>, <em>data=''</em>, <em>content_type='application/octet-stream'</em>, <em>follow=False</em>, <em>secure=False</em>, <em>**extra</em>)<a class="headerlink" href="#django.test.Client.delete" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Procède à une requête DELETE utilisant le chemin <code class="docutils literal notranslate"><span class="pre">path</span></code> indiqué et renvoie un objet <code class="docutils literal notranslate"><span class="pre">Response</span></code>. Utile pour tester les interfaces de type «&nbsp;REST&nbsp;».</p>
<p>Lorsque <code class="docutils literal notranslate"><span class="pre">data</span></code> est renseigné, il est utilisé comme corps de requête et un en-tête <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> est défini avec le contenu de <code class="docutils literal notranslate"><span class="pre">content_type</span></code>.</p>
<p>Les paramètres <code class="docutils literal notranslate"><span class="pre">follow</span></code>, <code class="docutils literal notranslate"><span class="pre">secure</span></code> et <code class="docutils literal notranslate"><span class="pre">extra</span></code> jouent le même rôle que pour <a class="reference internal" href="#django.test.Client.get" title="django.test.Client.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Client.get()</span></code></a>.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.Client.trace">
<code class="descname">trace</code>(<em>path</em>, <em>follow=False</em>, <em>secure=False</em>, <em>**extra</em>)<a class="headerlink" href="#django.test.Client.trace" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Procède à une requête TRACE utilisant le chemin <code class="docutils literal notranslate"><span class="pre">path</span></code> indiqué et renvoie un objet <code class="docutils literal notranslate"><span class="pre">Response</span></code>. Utile pour simuler les tests diagnostics.</p>
<p>Au contraire des autres méthodes de requête, <code class="docutils literal notranslate"><span class="pre">data</span></code> n’est pas fourni comme paramètre nommé afin de respecter la <span class="target" id="index-6"></span><a class="rfc reference external" href="https://tools.ietf.org/html/rfc7231.html#section-4.3.8"><strong>RFC 7231#section-4.3.8</strong></a>, qui interdit aux requêtes TRACE de posséder un corps.</p>
<p>Les paramètres <code class="docutils literal notranslate"><span class="pre">follow</span></code>, <code class="docutils literal notranslate"><span class="pre">secure</span></code> et <code class="docutils literal notranslate"><span class="pre">extra</span></code> jouent le même rôle que pour <a class="reference internal" href="#django.test.Client.get" title="django.test.Client.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Client.get()</span></code></a>.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.Client.login">
<code class="descname">login</code>(<em>**credentials</em>)<a class="headerlink" href="#django.test.Client.login" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Si un projet utilise le <a class="reference internal" href="../auth/index.html"><span class="doc">système d’authentification</span></a> de Django et que les tests connectent des utilisateurs, il est possible d’utiliser la méthode <code class="docutils literal notranslate"><span class="pre">login()</span></code> du client de test pour simuler la connexion d’un utilisateur au site concerné.</p>
<p>Après l’appel à cette méthode, le client de test contiendra tous les cookies et les données de session nécessaires pour passer les tests dans lesquels des vues comptent sur des utilisateurs connectés.</p>
<p>Le format du paramètre <code class="docutils literal notranslate"><span class="pre">credentials</span></code> dépend du <a class="reference internal" href="../auth/customizing.html#authentication-backends"><span class="std std-ref">moteur d’authentification</span></a> utilisé (configuré dans le réglage <a class="reference internal" href="../../ref/settings.html#std:setting-AUTHENTICATION_BACKENDS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">AUTHENTICATION_BACKENDS</span></code></a>). Dans le cas du moteur d’authentification standard de Django (<code class="docutils literal notranslate"><span class="pre">ModelBackend</span></code>), <code class="docutils literal notranslate"><span class="pre">credentials</span></code> doit contenir le nom d’utilisateur et le mot de passe de l’utilisateur, fournis sous la forme de paramètres nommés&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;fred&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;secret&#39;</span><span class="p">)</span>

<span class="go"># Now you can access a view that&#39;s only available to logged-in users.</span>
</pre></div>
</div>
<p>Si un autre moteur d’authentification est utilisé, cette méthode peut nécessiter un autre format de données d’authentification. Cela dépend des paramètres nécessaires à la méthode <code class="docutils literal notranslate"><span class="pre">authenticate()</span></code> du moteur en question.</p>
<p><code class="docutils literal notranslate"><span class="pre">login()</span></code> renvoie <code class="docutils literal notranslate"><span class="pre">True</span></code> si les données d’authentification ont été acceptées et que la connexion s’est terminée avec succès.</p>
<p>Pour finir, il ne faut pas oublier de créer des comptes utilisateurs avant de pouvoir utiliser cette méthode. Comme expliqué ci-dessus, le lanceur de tests fonctionne avec une base de données de test, sans aucun utilisateur par défaut. Par conséquent, les comptes utilisateurs actifs sur un site de production ne sont pas pris en compte dans des conditions de test. Les utilisateurs doivent être créés dans le cadre de la suite de tests, soit manuellement (par l’API de modèle Django), soit par un instantané de test. N’oubliez pas non plus que pour qu’un utilisateur de test dispose d’un mot de passe, il ne suffit pas de définir directement l’attribut <code class="docutils literal notranslate"><span class="pre">password</span></code> de l’utilisateur, mais il faut passer par la fonction <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User.set_password" title="django.contrib.auth.models.User.set_password"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_password()</span></code></a> pour que soit stockée une empreinte correcte de mot de passe. Il est aussi possible d’employer la méthode utilitaire <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.UserManager.create_user" title="django.contrib.auth.models.UserManager.create_user"><code class="xref py py-meth docutils literal notranslate"><span class="pre">create_user()</span></code></a> pour créer un nouvel utilisateur ainsi qu’une empreinte de mot de passe utilisable.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.Client.force_login">
<code class="descname">force_login</code>(<em>user</em>, <em>backend=None</em>)<a class="headerlink" href="#django.test.Client.force_login" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Si un projet utilise le <a class="reference internal" href="../auth/index.html"><span class="doc">système d’authentification</span></a> de Django, il est possible d’utiliser la méthode <code class="docutils literal notranslate"><span class="pre">force_login()</span></code> pour simuler la connexion d’un utilisateur du site concerné. Il est avantageux d’utiliser cette méthode à la place de <a class="reference internal" href="#django.test.Client.login" title="django.test.Client.login"><code class="xref py py-meth docutils literal notranslate"><span class="pre">login()</span></code></a> lorsqu’un test a besoin d’un utilisateur connecté mais que les détails de la manière dont l’utilisateur s’est connecté importent peu.</p>
<p>Au contraire de <code class="docutils literal notranslate"><span class="pre">login()</span></code>, cette méthode omet les étapes d’authentification et de vérification&nbsp;: les utilisateurs inactifs (<a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User.is_active" title="django.contrib.auth.models.User.is_active"><code class="xref py py-attr docutils literal notranslate"><span class="pre">is_active=False</span></code></a>) peuvent se connecter et il n’est pas nécessaire de fournir les informations d’authentification.</p>
<p>L’attribut <code class="docutils literal notranslate"><span class="pre">backend</span></code> de l’utilisateur sera défini à la valeur du paramètre <code class="docutils literal notranslate"><span class="pre">backend</span></code> (qui devrait être un chemin Python pointé) ou à <code class="docutils literal notranslate"><span class="pre">settings.AUTHENTICATION_BACKENDS[0]</span></code> si ce paramètre n’est pas fourni. La fonction <a class="reference internal" href="../auth/default.html#django.contrib.auth.authenticate" title="django.contrib.auth.authenticate"><code class="xref py py-func docutils literal notranslate"><span class="pre">authenticate()</span></code></a> appelée par <a class="reference internal" href="#django.test.Client.login" title="django.test.Client.login"><code class="xref py py-meth docutils literal notranslate"><span class="pre">login()</span></code></a> annote normalement l’utilisateur de cette manière.</p>
<p>Cette méthode est plus rapide que <code class="docutils literal notranslate"><span class="pre">login()</span></code> dans la mesure où les coûteux algorithmes de hachage de mot de passe sont ignorés. Notez qu’il est aussi possible d’accélérer <code class="docutils literal notranslate"><span class="pre">login()</span></code> en <a class="reference internal" href="overview.html#speeding-up-tests-auth-hashers"><span class="std std-ref">utilisant une méthode de hachage plus faible durant les tests</span></a>.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.Client.logout">
<code class="descname">logout</code>()<a class="headerlink" href="#django.test.Client.logout" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Si un projet utilise le <a class="reference internal" href="../auth/index.html"><span class="doc">système d’authentification</span></a> de Django, il est possible d’utiliser la méthode <code class="docutils literal notranslate"><span class="pre">logout()</span></code> du client de test pour simuler la déconnexion d’un utilisateur du site concerné.</p>
<p>Après l’appel à cette méthode, le client de test verra toutes ses données de cookies et de session réinitialisées à leurs valeurs par défaut. Les requêtes suivantes apparaîtront comme si elles provenaient d’un utilisateur anonyme (<a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.AnonymousUser" title="django.contrib.auth.models.AnonymousUser"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnonymousUser</span></code></a>).</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="s-testing-responses">
<span id="testing-responses"></span><h3>Test des réponses<a class="headerlink" href="#testing-responses" title="Lien permanent vers ce titre">¶</a></h3>
<p>Les méthodes <code class="docutils literal notranslate"><span class="pre">get()</span></code> et <code class="docutils literal notranslate"><span class="pre">post()</span></code> renvoient les deux un objet <code class="docutils literal notranslate"><span class="pre">Response</span></code>. Cet objet n’est <em>pas</em> le même que les objets <code class="docutils literal notranslate"><span class="pre">HttpResponse</span></code> renvoyés par les vues Django&nbsp;; l’objet de réponse de test possède des données supplémentaires bien utiles pour certaines vérifications dans le code des tests.</p>
<p>Plus précisément, un objet <code class="docutils literal notranslate"><span class="pre">Response</span></code> possède les attributs suivants&nbsp;:</p>
<dl class="class">
<dt id="django.test.Response">
<em class="property">class </em><code class="descname">Response</code><a class="headerlink" href="#django.test.Response" title="Lien permanent vers cette définition">¶</a></dt>
<dd><dl class="attribute">
<dt id="django.test.Response.client">
<code class="descname">client</code><a class="headerlink" href="#django.test.Response.client" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Le client de test utilisé pour effectuer la requête qui a renvoyé cette réponse.</p>
</dd></dl>

<dl class="attribute">
<dt id="django.test.Response.content">
<code class="descname">content</code><a class="headerlink" href="#django.test.Response.content" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Le corps de la réponse sous forme de chaîne d’octets. Il s’agit du contenu final de la page produite par la vue, ou d’un éventuel message d’erreur.</p>
</dd></dl>

<dl class="attribute">
<dt id="django.test.Response.context">
<code class="descname">context</code><a class="headerlink" href="#django.test.Response.context" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>L’instance <code class="docutils literal notranslate"><span class="pre">Context</span></code> du gabarit utilisé pour effectuer le rendu de gabarit qui a produit le contenu de la réponse.</p>
<p>Si le rendu de la page à utilisé plusieurs gabarits, <code class="docutils literal notranslate"><span class="pre">context</span></code> contient une liste d’objets <code class="docutils literal notranslate"><span class="pre">Context</span></code> dans l’ordre de leur rendu.</p>
<p>Quel que soit le nombre de gabarits utilisés dans le processus de rendu, vous pouvez récupérer les valeurs de contexte en utilisant l’opérateur <code class="docutils literal notranslate"><span class="pre">[]</span></code>. Par exemple, la variable de contexte <code class="docutils literal notranslate"><span class="pre">name</span></code> peut être récupérée ainsi&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/foo/&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">response</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
<span class="go">&#39;Arthur&#39;</span>
</pre></div>
</div>
<div class="admonition-not-using-django-templates admonition">
<p class="first admonition-title">Vous n’utilisez pas les gabarits Django&nbsp;?</p>
<p class="last">Cet attribut n’est présent que lorsque le moteur de gabarit est <a class="reference internal" href="../templates.html#django.template.backends.django.DjangoTemplates" title="django.template.backends.django.DjangoTemplates"><code class="xref py py-class docutils literal notranslate"><span class="pre">DjangoTemplates</span></code></a>. Si vous utilisez un autre moteur, <a class="reference internal" href="../../ref/template-response.html#django.template.response.SimpleTemplateResponse.context_data" title="django.template.response.SimpleTemplateResponse.context_data"><code class="xref py py-attr docutils literal notranslate"><span class="pre">context_data</span></code></a> peut constituer une alternative viable pour les réponses possédant cet attribut.</p>
</div>
</dd></dl>

<dl class="attribute">
<dt id="django.test.Response.exc_info">
<code class="descname">exc_info</code><a class="headerlink" href="#django.test.Response.exc_info" title="Lien permanent vers cette définition">¶</a></dt>
<dd><div class="versionadded">
<span class="title">New in Django 3.0.</span> </div>
<p>Un tuple de trois valeurs fournissant des informations sur l’exception non traitée, le cas échéant, qui est apparue durant la vue.</p>
<p>Les valeurs sont (type, valeur, trace d’erreur), tout comme ce que Python renvoie dans <a class="reference external" href="https://docs.python.org/3/library/sys.html#sys.exc_info" title="(disponible dans Python v3.9)"><code class="xref py py-func docutils literal notranslate"><span class="pre">sys.exc_info()</span></code></a>. Leur signification est :</p>
<ul class="simple">
<li><em>type</em> : le type de l’exception.</li>
<li><em>valeur</em> : l’instance de l’exception.</li>
<li><em>trace d’erreur</em> : Un objet <code class="docutils literal notranslate"><span class="pre">Traceback</span></code> qui englobe la pile d’appels au moment où l’exception a été initialement déclenchée.</li>
</ul>
<p>Si aucune exception ne s’est produite, <code class="docutils literal notranslate"><span class="pre">exc_info</span></code> contient <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.Response.json">
<code class="descname">json</code>(<em>**kwargs</em>)<a class="headerlink" href="#django.test.Response.json" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Le corps de la réponse, analysée en JSON. Les paramètres nommés supplémentaires sont transmis à <a class="reference external" href="https://docs.python.org/3/library/json.html#json.loads" title="(disponible dans Python v3.9)"><code class="xref py py-func docutils literal notranslate"><span class="pre">json.loads()</span></code></a>. Par exemple&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/foo/&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
<span class="go">&#39;Arthur&#39;</span>
</pre></div>
</div>
<p>Si l’en-tête <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> n’est pas <code class="docutils literal notranslate"><span class="pre">&quot;application/json&quot;</span></code>, une erreur <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#ValueError" title="(disponible dans Python v3.9)"><code class="xref py py-exc docutils literal notranslate"><span class="pre">ValueError</span></code></a> sera signalée au moment d’analyser la réponse.</p>
</dd></dl>

<dl class="attribute">
<dt id="django.test.Response.request">
<code class="descname">request</code><a class="headerlink" href="#django.test.Response.request" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Les données de requête à l’origine de la réponse.</p>
</dd></dl>

<dl class="attribute">
<dt id="django.test.Response.wsgi_request">
<code class="descname">wsgi_request</code><a class="headerlink" href="#django.test.Response.wsgi_request" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>L’instance <code class="docutils literal notranslate"><span class="pre">WSGIRequest</span></code> générée par le gestionnaire de test qui a produit la réponse.</p>
</dd></dl>

<dl class="attribute">
<dt id="django.test.Response.status_code">
<code class="descname">status_code</code><a class="headerlink" href="#django.test.Response.status_code" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Le statut HTTP de la réponse sous forme de nombre entier. Pour une liste exhaustive des codes définis, voir le <a class="reference external" href="https://www.iana.org/assignments/http-status-codes/http-status-codes.xhtml">registre IANA des codes de statut</a>.</p>
</dd></dl>

<dl class="attribute">
<dt id="django.test.Response.templates">
<code class="descname">templates</code><a class="headerlink" href="#django.test.Response.templates" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Une liste d’instances de gabarits (<code class="docutils literal notranslate"><span class="pre">Template</span></code>) ayant servi à rendre le contenu final, dans l’ordre de leur utilisation. Pour chaque gabarit de la liste, utilisez <code class="docutils literal notranslate"><span class="pre">template.name</span></code> pour obtenir le nom de fichier du gabarit si celui-ci a été chargé à partir d’un fichier (le nom est une chaîne du genre <code class="docutils literal notranslate"><span class="pre">'admin/index.html'</span></code>).</p>
<div class="admonition-not-using-django-templates admonition">
<p class="first admonition-title">Vous n’utilisez pas les gabarits Django&nbsp;?</p>
<p class="last">Cet attribut n’est présent que lorsque le moteur de gabarit est <a class="reference internal" href="../templates.html#django.template.backends.django.DjangoTemplates" title="django.template.backends.django.DjangoTemplates"><code class="xref py py-class docutils literal notranslate"><span class="pre">DjangoTemplates</span></code></a>. Si vous utilisez un autre moteur, <a class="reference internal" href="../../ref/template-response.html#django.template.response.SimpleTemplateResponse.template_name" title="django.template.response.SimpleTemplateResponse.template_name"><code class="xref py py-attr docutils literal notranslate"><span class="pre">template_name</span></code></a> peut constituer une alternative viable si vous n’avez besoin que du nom du gabarit utilisé pour le rendu.</p>
</div>
</dd></dl>

<dl class="attribute">
<dt id="django.test.Response.resolver_match">
<code class="descname">resolver_match</code><a class="headerlink" href="#django.test.Response.resolver_match" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Une instance de <a class="reference internal" href="../../ref/urlresolvers.html#django.urls.ResolverMatch" title="django.urls.ResolverMatch"><code class="xref py py-class docutils literal notranslate"><span class="pre">ResolverMatch</span></code></a> pour la réponse. Vous pouvez utiliser l’attribut <a class="reference internal" href="../../ref/urlresolvers.html#django.urls.ResolverMatch.func" title="django.urls.ResolverMatch.func"><code class="xref py py-attr docutils literal notranslate"><span class="pre">func</span></code></a>, par exemple, pour vérifier la vue qui a servi la réponse&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># my_view here is a function based view</span>
<span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">resolver_match</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">my_view</span><span class="p">)</span>

<span class="c1"># class-based views need to be compared by name, as the functions</span>
<span class="c1"># generated by as_view() won&#39;t be equal</span>
<span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">resolver_match</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">MyView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</pre></div>
</div>
<p>Si l’URL indiquée n’est pas trouvée, l’accès à cet attribut génère l’exception <a class="reference internal" href="../../ref/exceptions.html#django.urls.Resolver404" title="django.urls.Resolver404"><code class="xref py py-exc docutils literal notranslate"><span class="pre">Resolver404</span></code></a>.</p>
</dd></dl>

</dd></dl>

<p>Il est aussi possible d’utiliser la syntaxe de dictionnaire sur l’objet réponse pour interroger n’importe quelle valeur d’en-tête HTTP. Par exemple, vous pouvez retrouver le type de contenu d’une réponse avec <code class="docutils literal notranslate"><span class="pre">response['Content-Type']</span></code>.</p>
</div>
<div class="section" id="s-exceptions">
<span id="exceptions"></span><h3>Exceptions<a class="headerlink" href="#exceptions" title="Lien permanent vers ce titre">¶</a></h3>
<p>Si le client de test fait appel à une vue qui génère une exception et que <code class="docutils literal notranslate"><span class="pre">Client.raise_request_exception</span></code> vaut <code class="docutils literal notranslate"><span class="pre">True</span></code>, celle-ci est propagée dans le cas de test. Vous pouvez dès lors utiliser un bloc <code class="docutils literal notranslate"><span class="pre">try</span> <span class="pre">...</span> <span class="pre">except</span></code> standard ou <a class="reference external" href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.assertRaises" title="(disponible dans Python v3.9)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">assertRaises()</span></code></a> pour tester l’exception générée.</p>
<p>Les seules exceptions qui ne sont pas visibles pour le client de test sont <a class="reference internal" href="../http/views.html#django.http.Http404" title="django.http.Http404"><code class="xref py py-class docutils literal notranslate"><span class="pre">Http404</span></code></a>, <a class="reference internal" href="../../ref/exceptions.html#django.core.exceptions.PermissionDenied" title="django.core.exceptions.PermissionDenied"><code class="xref py py-class docutils literal notranslate"><span class="pre">PermissionDenied</span></code></a>, <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#SystemExit" title="(disponible dans Python v3.9)"><code class="xref py py-exc docutils literal notranslate"><span class="pre">SystemExit</span></code></a> et <a class="reference internal" href="../../ref/exceptions.html#django.core.exceptions.SuspiciousOperation" title="django.core.exceptions.SuspiciousOperation"><code class="xref py py-class docutils literal notranslate"><span class="pre">SuspiciousOperation</span></code></a>. Django intercepte en interne ces exceptions et les convertit en code de réponse HTTP adéquat. Dans ces situations, vous pouvez tester la valeur <code class="docutils literal notranslate"><span class="pre">response.status_code</span></code>.</p>
<p>Si <code class="docutils literal notranslate"><span class="pre">Client.raise_request_exception</span></code> vaut <code class="docutils literal notranslate"><span class="pre">False</span></code>, le client de test renverra une erreur 500 comme le ferait un navigateur. La réponse possède l’attribut <a class="reference internal" href="#django.test.Response.exc_info" title="django.test.Response.exc_info"><code class="xref py py-attr docutils literal notranslate"><span class="pre">exc_info</span></code></a> pour fournir des informations sur l’exception non traitée.</p>
</div>
<div class="section" id="s-persistent-state">
<span id="persistent-state"></span><h3>État persistant<a class="headerlink" href="#persistent-state" title="Lien permanent vers ce titre">¶</a></h3>
<p>L’état du client de test est persistant. Si une réponse renvoie un cookie, celui-ci est stocké dans le client de test et il sera ensuite envoyé dans les requêtes <code class="docutils literal notranslate"><span class="pre">get()</span></code> et <code class="docutils literal notranslate"><span class="pre">post()</span></code> subséquentes.</p>
<p>Les politiques d’expiration de ces cookies ne sont pas respectées. Si vous souhaitez faire expirer un cookie, supprimez-le manuellement ou créez une nouvelle instance de <code class="docutils literal notranslate"><span class="pre">Client</span></code> (ce qui aura comme conséquence de supprimer tous les cookies).</p>
<p>Un client de test possède deux attributs qui stockent les informations d’état persistantes. Vous pouvez accéder à ces propriétés dans le cadre d’une condition de test.</p>
<dl class="attribute">
<dt id="django.test.Client.cookies">
<code class="descclassname">Client.</code><code class="descname">cookies</code><a class="headerlink" href="#django.test.Client.cookies" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Un objet Python <a class="reference external" href="https://docs.python.org/3/library/http.cookies.html#http.cookies.SimpleCookie" title="(disponible dans Python v3.9)"><code class="xref py py-class docutils literal notranslate"><span class="pre">SimpleCookie</span></code></a> contenant les valeurs actuelles de tous les cookies du client. Consultez la documentation du module <a class="reference external" href="https://docs.python.org/3/library/http.cookies.html#module-http.cookies" title="(disponible dans Python v3.9)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">http.cookies</span></code></a> pour en savoir plus.</p>
</dd></dl>

<dl class="attribute">
<dt id="django.test.Client.session">
<code class="descclassname">Client.</code><code class="descname">session</code><a class="headerlink" href="#django.test.Client.session" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Un objet de type dictionnaire contenant les informations de session. Consultez la <a class="reference internal" href="../http/sessions.html"><span class="doc">documentation des sessions</span></a> pour plus de détails.</p>
<p>Pour modifier la session et l’enregistrer, elle doit être d’abord stockée dans une variable (car un nouveau <code class="docutils literal notranslate"><span class="pre">SessionStore</span></code> est créé chaque fois qu’on accède à cette propriété)&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_something</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">session</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;somekey&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;test&#39;</span>
    <span class="n">session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="s-setting-the-language">
<span id="setting-the-language"></span><h3>Définition de la langue<a class="headerlink" href="#setting-the-language" title="Lien permanent vers ce titre">¶</a></h3>
<p>Lors des tests d’applications qui prennent en charge l’internationalisation et la localisation, il peut être souhaitable de définir la langue de la requête du client de test. La méthode à employer dépend de l’activation ou non de <a class="reference internal" href="../../ref/middleware.html#django.middleware.locale.LocaleMiddleware" title="django.middleware.locale.LocaleMiddleware"><code class="xref py py-class docutils literal notranslate"><span class="pre">LocaleMiddleware</span></code></a>.</p>
<p>Si l’intergiciel est activé, la langue peut être définie en créant un cookie nommé <a class="reference internal" href="../../ref/settings.html#std:setting-LANGUAGE_COOKIE_NAME"><code class="xref std std-setting docutils literal notranslate"><span class="pre">LANGUAGE_COOKIE_NAME</span></code></a> et une valeur contenant le code de langue&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf</span> <span class="k">import</span> <span class="n">settings</span>

<span class="k">def</span> <span class="nf">test_language_using_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="n">settings</span><span class="o">.</span><span class="n">LANGUAGE_COOKIE_NAME</span><span class="p">:</span> <span class="s1">&#39;fr&#39;</span><span class="p">})</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;Bienvenue sur mon site.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>ou en incluant l’en-tête HTTP <code class="docutils literal notranslate"><span class="pre">Accept-Language</span></code> dans la requête&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_language_using_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">HTTP_ACCEPT_LANGUAGE</span><span class="o">=</span><span class="s1">&#39;fr&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;Bienvenue sur mon site.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Voir <a class="reference internal" href="../i18n/translation.html#how-django-discovers-language-preference"><span class="std std-ref">Processus de découverte de la préférence de langue par Django</span></a> pour plus de détails.</p>
<p>Si l’intergiciel n’est pas activé, la langue active peut être définie en utilisant <a class="reference internal" href="../../ref/utils.html#django.utils.translation.override" title="django.utils.translation.override"><code class="xref py py-func docutils literal notranslate"><span class="pre">translation.override()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.utils</span> <span class="k">import</span> <span class="n">translation</span>

<span class="k">def</span> <span class="nf">test_language_using_override</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">translation</span><span class="o">.</span><span class="n">override</span><span class="p">(</span><span class="s1">&#39;fr&#39;</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;Bienvenue sur mon site.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Voir <a class="reference internal" href="../i18n/translation.html#explicitly-setting-the-active-language"><span class="std std-ref">Définition explicite de la langue active</span></a> pour plus de détails.</p>
</div>
<div class="section" id="s-example">
<span id="example"></span><h3>Exemple<a class="headerlink" href="#example" title="Lien permanent vers ce titre">¶</a></h3>
<p>L’exemple suivant est un test unitaire exploitant le client de test&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="k">import</span> <span class="n">Client</span>

<span class="k">class</span> <span class="nc">SimpleTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Every test needs a client.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_details</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Issue a GET request.</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/customer/details/&#39;</span><span class="p">)</span>

        <span class="c1"># Check that the response is 200 OK.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

        <span class="c1"># Check that the rendered context contains 5 customers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;customers&#39;</span><span class="p">]),</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">Voir aussi</p>
<p class="last"><a class="reference internal" href="advanced.html#django.test.RequestFactory" title="django.test.RequestFactory"><code class="xref py py-class docutils literal notranslate"><span class="pre">django.test.RequestFactory</span></code></a></p>
</div>
</div>
</div>
<div class="section" id="s-provided-test-case-classes">
<span id="s-django-testcase-subclasses"></span><span id="provided-test-case-classes"></span><span id="django-testcase-subclasses"></span><h2>Classes de cas de test disponibles<a class="headerlink" href="#provided-test-case-classes" title="Lien permanent vers ce titre">¶</a></h2>
<p>Les classes de test unitaire normales de Python étendent la classe de base <a class="reference external" href="https://docs.python.org/3/library/unittest.html#unittest.TestCase" title="(disponible dans Python v3.9)"><code class="xref py py-class docutils literal notranslate"><span class="pre">unittest.TestCase</span></code></a>. Django fournit plusieurs extensions de cette classe de base&nbsp;:</p>
<div class="figure" id="id4">
<span id="testcase-hierarchy-diagram"></span><a class="reference internal image-reference" href="../../_images/django_unittest_classes_hierarchy.svg"><img alt="Hierarchy of Django unit testing classes (TestCase subclasses)" height="328" src="../../_images/django_unittest_classes_hierarchy.svg" width="508" /></a>
<p class="caption"><span class="caption-text">Hiérarchie des classes de tests unitaires de Django</span></p>
</div>
<p>Il est possible de convertir une classe <a class="reference external" href="https://docs.python.org/3/library/unittest.html#unittest.TestCase" title="(disponible dans Python v3.9)"><code class="xref py py-class docutils literal notranslate"><span class="pre">unittest.TestCase</span></code></a> normale en une des sous-classes&nbsp;: remplacez la classe de base des tests <code class="docutils literal notranslate"><span class="pre">unittest.TestCase</span></code> par la sous-classe. Toutes les fonctionnalités standard de Python pour les tests unitaires sont toujours disponibles, et vous obtenez en plus quelques éléments utiles tels que documentés dans chaque section ci-dessous.</p>
<div class="section" id="s-simpletestcase">
<span id="simpletestcase"></span><h3><code class="docutils literal notranslate"><span class="pre">SimpleTestCase</span></code><a class="headerlink" href="#simpletestcase" title="Lien permanent vers ce titre">¶</a></h3>
<dl class="class">
<dt id="django.test.SimpleTestCase">
<em class="property">class </em><code class="descname">SimpleTestCase</code><a class="headerlink" href="#django.test.SimpleTestCase" title="Lien permanent vers cette définition">¶</a></dt>
<dd></dd></dl>

<p>Une sous-classe de <a class="reference external" href="https://docs.python.org/3/library/unittest.html#unittest.TestCase" title="(disponible dans Python v3.9)"><code class="xref py py-class docutils literal notranslate"><span class="pre">unittest.TestCase</span></code></a> qui ajoute cette fonctionnalité&nbsp;:</p>
<ul class="simple">
<li>Certaines assertions utiles comme&nbsp;:<ul>
<li>Vérification qu’un objet exécutable <a class="reference internal" href="#django.test.SimpleTestCase.assertRaisesMessage" title="django.test.SimpleTestCase.assertRaisesMessage"><code class="xref py py-meth docutils literal notranslate"><span class="pre">génère</span> <span class="pre">une</span> <span class="pre">exception</span> <span class="pre">donnée</span></code></a>.</li>
<li>Vérification qu’un objet exécutable <a class="reference internal" href="#django.test.SimpleTestCase.assertWarnsMessage" title="django.test.SimpleTestCase.assertWarnsMessage"><code class="xref py py-meth docutils literal notranslate"><span class="pre">génère</span> <span class="pre">un</span> <span class="pre">avertissement</span> <span class="pre">donné</span></code></a>.</li>
<li>Le test de <a class="reference internal" href="#django.test.SimpleTestCase.assertFieldOutput" title="django.test.SimpleTestCase.assertFieldOutput"><code class="xref py py-meth docutils literal notranslate"><span class="pre">rendu</span> <span class="pre">et</span> <span class="pre">de</span> <span class="pre">traitement</span> <span class="pre">d'erreur</span></code></a> des champs de formulaire.</li>
<li>Le test de <a class="reference internal" href="#django.test.SimpleTestCase.assertContains" title="django.test.SimpleTestCase.assertContains"><code class="xref py py-meth docutils literal notranslate"><span class="pre">présence</span> <span class="pre">ou</span> <span class="pre">d'absence</span> <span class="pre">d'un</span> <span class="pre">fragment</span> <span class="pre">donné</span> <span class="pre">dans</span> <span class="pre">des</span> <span class="pre">réponses</span> <span class="pre">HTML</span></code></a>.</li>
<li>La vérification qu’un gabarit <a class="reference internal" href="#django.test.SimpleTestCase.assertTemplateUsed" title="django.test.SimpleTestCase.assertTemplateUsed"><code class="xref py py-meth docutils literal notranslate"><span class="pre">a</span> <span class="pre">été</span> <span class="pre">ou</span> <span class="pre">n'a</span> <span class="pre">pas</span> <span class="pre">été</span> <span class="pre">utilisé</span> <span class="pre">pour</span> <span class="pre">générer</span> <span class="pre">un</span> <span class="pre">contenu</span> <span class="pre">de</span> <span class="pre">réponse</span> <span class="pre">donné</span></code></a>.</li>
<li>La vérification que deux meth:URL &lt;SimpleTestCase.assertURLEqual&gt; sont égales.</li>
<li>La vérification qu’une <a class="reference internal" href="#django.test.SimpleTestCase.assertRedirects" title="django.test.SimpleTestCase.assertRedirects"><code class="xref py py-meth docutils literal notranslate"><span class="pre">redirection</span> <span class="pre">HTTP</span></code></a> a été effectuée par une application.</li>
<li>La comparaison robuste entre deux <a class="reference internal" href="#django.test.SimpleTestCase.assertHTMLEqual" title="django.test.SimpleTestCase.assertHTMLEqual"><code class="xref py py-meth docutils literal notranslate"><span class="pre">fragments</span> <span class="pre">HTML</span></code></a> ou la présence ou absence d’un <a class="reference internal" href="#django.test.SimpleTestCase.assertInHTML" title="django.test.SimpleTestCase.assertInHTML"><code class="xref py py-meth docutils literal notranslate"><span class="pre">fragment</span> <span class="pre">HTML</span> <span class="pre">dans</span> <span class="pre">un</span> <span class="pre">autre</span></code></a>.</li>
<li>La comparaison robuste entre deux <a class="reference internal" href="#django.test.SimpleTestCase.assertXMLEqual" title="django.test.SimpleTestCase.assertXMLEqual"><code class="xref py py-meth docutils literal notranslate"><span class="pre">fragments</span> <span class="pre">XML</span></code></a>.</li>
<li>La comparaison robuste entre deux <a class="reference internal" href="#django.test.SimpleTestCase.assertJSONEqual" title="django.test.SimpleTestCase.assertJSONEqual"><code class="xref py py-meth docutils literal notranslate"><span class="pre">fragments</span> <span class="pre">JSON</span></code></a>.</li>
</ul>
</li>
<li>La capacité de lancer des tests avec des <a class="reference internal" href="#overriding-settings"><span class="std std-ref">réglages modifiés</span></a>.</li>
<li>L’utilisation du <a class="reference internal" href="#django.test.Client" title="django.test.Client"><code class="xref py py-class docutils literal notranslate"><span class="pre">Client</span></code></a> <a class="reference internal" href="#django.test.SimpleTestCase.client" title="django.test.SimpleTestCase.client"><code class="xref py py-attr docutils literal notranslate"><span class="pre">client</span></code></a>.</li>
</ul>
<p>Si les tests effectuent des requêtes de base de données, utilisez les sous-classes  <a class="reference internal" href="#django.test.TransactionTestCase" title="django.test.TransactionTestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">TransactionTestCase</span></code></a> ou <a class="reference internal" href="#django.test.TestCase" title="django.test.TestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">TestCase</span></code></a>.</p>
<dl class="attribute">
<dt id="django.test.SimpleTestCase.databases">
<code class="descclassname">SimpleTestCase.</code><code class="descname">databases</code><a class="headerlink" href="#django.test.SimpleTestCase.databases" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p><a class="reference internal" href="#django.test.SimpleTestCase" title="django.test.SimpleTestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">SimpleTestCase</span></code></a> n’autorise pas de requête de base de données par défaut. Ceci permet d’éviter l’exécution de requêtes d’écriture qui pourraient affecter d’autres tests dans la mesure où chaque test d’une suite <code class="docutils literal notranslate"><span class="pre">SimpleTestCase</span></code> n’est pas lancé dans une transaction. Si ce problème ne vous concerne pas, vous pouvez désactiver ce comportement en définissant l’attribut de classe <code class="docutils literal notranslate"><span class="pre">databases</span></code> à <code class="docutils literal notranslate"><span class="pre">'__all__'</span></code> sur la classe de test.</p>
</dd></dl>

<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p><code class="docutils literal notranslate"><span class="pre">SimpleTestCase</span></code> et ses sous-classes (par ex. <code class="docutils literal notranslate"><span class="pre">TestCase</span></code>, …) se basent sur <code class="docutils literal notranslate"><span class="pre">setUpClass()</span></code> et <code class="docutils literal notranslate"><span class="pre">tearDownClass()</span></code> pour effectuer des initialisations liées à la classe entière (par exemple la surcharge de réglages). Si vous avez besoin de surcharger ces méthodes, n’oubliez pas d’appeler l’implémentation de <code class="docutils literal notranslate"><span class="pre">super</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">()</span>
        <span class="o">...</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">tearDownClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">tearDownClass</span><span class="p">()</span>
</pre></div>
</div>
<p class="last">Prenez garde de prendre en compte le comportement Python quand une exception est générée durant <code class="docutils literal notranslate"><span class="pre">setUpClass()</span></code>. Quand cela se produit, aucun test de la classe n’est exécuté et <code class="docutils literal notranslate"><span class="pre">tearDownClass()</span></code> n’est pas non plus appelée. Dans le cas de <a class="reference internal" href="#django.test.TestCase" title="django.test.TestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">django.test.TestCase</span></code></a>, la transaction créée dans <code class="docutils literal notranslate"><span class="pre">super()</span></code> n’est pas proprement traitée ce qui peut produire divers symptômes, y compris une faute de segmentation sur certaines plates-formes (signalé sur macOS). Si vous souhaitez provoquer intentionnellement une exception telle que <a class="reference external" href="https://docs.python.org/3/library/unittest.html#unittest.SkipTest" title="(disponible dans Python v3.9)"><code class="xref py py-exc docutils literal notranslate"><span class="pre">unittest.SkipTest</span></code></a> dans <code class="docutils literal notranslate"><span class="pre">setUpClass()</span></code>, faites-le avant d’appeler <code class="docutils literal notranslate"><span class="pre">super()</span></code> pour éviter ces problèmes.</p>
</div>
<div class="versionchanged">
<span class="title">Changed in Django 3.1:</span> <p>La méthode <code class="docutils literal notranslate"><span class="pre">debug()</span></code> a été implémentée pour permettre de lancer un test sans collecter le résultat et intercepter les exceptions.</p>
</div>
</div>
<div class="section" id="s-transactiontestcase">
<span id="transactiontestcase"></span><h3><code class="docutils literal notranslate"><span class="pre">TransactionTestCase</span></code><a class="headerlink" href="#transactiontestcase" title="Lien permanent vers ce titre">¶</a></h3>
<dl class="class">
<dt id="django.test.TransactionTestCase">
<em class="property">class </em><code class="descname">TransactionTestCase</code><a class="headerlink" href="#django.test.TransactionTestCase" title="Lien permanent vers cette définition">¶</a></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">TransactionTestCase</span></code> hérite de <a class="reference internal" href="#django.test.SimpleTestCase" title="django.test.SimpleTestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">SimpleTestCase</span></code></a> et y ajoute quelques fonctionnalités spécifiques aux bases de données&nbsp;:</p>
<ul class="simple">
<li>Réinitialisation de la base de données à un état connu au commencement de chaque test pour faciliter les tests et l’utilisation de l’ORM.</li>
<li>Les instantanés (<a class="reference internal" href="#django.test.TransactionTestCase.fixtures" title="django.test.TransactionTestCase.fixtures"><code class="xref py py-attr docutils literal notranslate"><span class="pre">fixtures</span></code></a>) de base de données.</li>
<li>Omission de tests <a class="reference internal" href="#skipping-tests"><span class="std std-ref">en fonction de fonctionnalités du moteur de base de données</span></a>.</li>
<li>Les méthodes spécialisées restantes du type <a class="reference internal" href="#django.test.TransactionTestCase.assertQuerysetEqual" title="django.test.TransactionTestCase.assertQuerysetEqual"><code class="xref py py-meth docutils literal notranslate"><span class="pre">assert*</span></code></a>.</li>
</ul>
<p>La classe <a class="reference internal" href="#django.test.TestCase" title="django.test.TestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">TestCase</span></code></a> de Django est une sous-classe plus couramment utilisée de <code class="docutils literal notranslate"><span class="pre">TransactionTestCase</span></code> qui emploie les utilitaires de transaction de base de données pour accélérer le processus de réinitialisation de la base de données à un état connu au début de chaque test. Cependant, une des conséquences de ceci est que certains comportements de base de données ne peuvent pas être testés avec une classe <code class="docutils literal notranslate"><span class="pre">TestCase</span></code> de Django. Par exemple, vous ne pouvez pas tester qu’un bloc de code s’exécute dans une transaction, comme c’est exigé par l’utilisation de <a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.select_for_update" title="django.db.models.query.QuerySet.select_for_update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">select_for_update()</span></code></a>. Dans de tels cas, il vous faut utiliser la classe <code class="docutils literal notranslate"><span class="pre">TransactionTestCase</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">TransactionTestCase</span></code> et <code class="docutils literal notranslate"><span class="pre">TestCase</span></code> sont identiques à l’exception de la manière dont la base de données est réinitialisée à un état connu et de la capacité de tester les effets de «&nbsp;commit&nbsp;» et de «&nbsp;rollback&nbsp;» dans le code&nbsp;:</p>
<ul class="simple">
<li>La classe <code class="docutils literal notranslate"><span class="pre">TransactionTestCase</span></code> réinitialise la base de données après le lancement des tests en tronquant toutes les tables. Le code de ces tests peut valider et annuler des transactions et observer les effets de ces appels sur la base de données.</li>
<li>D’un autre côté, un <code class="docutils literal notranslate"><span class="pre">TestCase</span></code> ne tronque pas les tables après un test. Il enveloppe plutôt le code de test dans une transaction de base de données qui est ensuite annulée lorsque le test est terminé. Cela permet de garantir que l’annulation («&nbsp;rollback&nbsp;») à la fin des tests restaure la base de données à son état initial.</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p>Les tests <code class="docutils literal notranslate"><span class="pre">TestCase</span></code> s’exécutant avec une base de données ne prenant pas en charge l’annulation («&nbsp;rollback&nbsp;»), par exemple MySQL avec le moteur MyISAM, ainsi que toutes les instances de tests <code class="docutils literal notranslate"><span class="pre">TransactionTestCase</span></code> annulent la transaction à la fin du test en supprimant toutes les données de la base de données de test.</p>
<p class="last">Les applications <a class="reference internal" href="overview.html#test-case-serialized-rollback"><span class="std std-ref">ne verront pas leurs données rechargées</span></a>. Si vous avez besoin de cette fonctionnalité (typiquement dans le cas des applications tierces), vous pouvez définir <code class="docutils literal notranslate"><span class="pre">serialized_rollback</span> <span class="pre">=</span> <span class="pre">True</span></code> dans le corps de la classe <code class="docutils literal notranslate"><span class="pre">TestCase</span></code>.</p>
</div>
</div>
<div class="section" id="s-testcase">
<span id="testcase"></span><h3><code class="docutils literal notranslate"><span class="pre">TestCase</span></code><a class="headerlink" href="#testcase" title="Lien permanent vers ce titre">¶</a></h3>
<dl class="class">
<dt id="django.test.TestCase">
<em class="property">class </em><code class="descname">TestCase</code><a class="headerlink" href="#django.test.TestCase" title="Lien permanent vers cette définition">¶</a></dt>
<dd></dd></dl>

<p>Il s’agit de la classe la plus courante pour l’écriture de tests dans Django. Elle hérite de <a class="reference internal" href="#django.test.TransactionTestCase" title="django.test.TransactionTestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">TransactionTestCase</span></code></a> (et par extension de <a class="reference internal" href="#django.test.SimpleTestCase" title="django.test.SimpleTestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">SimpleTestCase</span></code></a>). Si votre application Django n’utilise pas de base de données, utilisez <a class="reference internal" href="#django.test.SimpleTestCase" title="django.test.SimpleTestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">SimpleTestCase</span></code></a>.</p>
<p>La classe&nbsp;:</p>
<ul class="simple">
<li>Enveloppe les tests dans deux blocs <a class="reference internal" href="../db/transactions.html#django.db.transaction.atomic" title="django.db.transaction.atomic"><code class="xref py py-func docutils literal notranslate"><span class="pre">atomic()</span></code></a> imbriqués&nbsp;: un pour la classe entière et un pour chaque test. Ainsi, si vous souhaitez tester un comportement transactionnel précis de la base de données, utilisez <a class="reference internal" href="#django.test.TransactionTestCase" title="django.test.TransactionTestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">TransactionTestCase</span></code></a>.</li>
<li>Vérifie les contraintes de base de données différées à la fin de chaque test.</li>
</ul>
<p>Elle fournit également une méthode supplémentaire&nbsp;:</p>
<dl class="classmethod">
<dt id="django.test.TestCase.setUpTestData">
<em class="property">classmethod </em><code class="descclassname">TestCase.</code><code class="descname">setUpTestData</code>()<a class="headerlink" href="#django.test.TestCase.setUpTestData" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Le bloc <code class="docutils literal notranslate"><span class="pre">atomic</span></code> au niveau de la classe mentionné ci-dessus permet la création de données initiales au niveau de la classe, une seule fois pour l’ensemble de <code class="docutils literal notranslate"><span class="pre">TestCase</span></code>. Cette technique permet d’accélérer les tests en comparaison du travail équivalent effectué au niveau de <code class="docutils literal notranslate"><span class="pre">setUp()</span></code>.</p>
<p>Par exemple&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.test</span> <span class="k">import</span> <span class="n">TestCase</span>

<span class="k">class</span> <span class="nc">MyTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpTestData</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="c1"># Set up data for the whole TestCase</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="n">Foo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">bar</span><span class="o">=</span><span class="s2">&quot;Test&quot;</span><span class="p">)</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">test1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Some test using self.foo</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">test2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Some other test using self.foo</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>Notez que si les tests sont exécutés pour une base de données sans prise en charge des transactions (par exemple MySQL avec le moteur MyISAM), <code class="docutils literal notranslate"><span class="pre">setUpTestData()</span></code> sera appelée avant chaque test, ce qui annulera le bénéfice en terme de vitesse.</p>
<p>Prenez soin de ne pas modifier les objets créés dans <code class="docutils literal notranslate"><span class="pre">setUpTestData()</span></code> dans vos méthodes de test. Les modifications en mémoire des objets préparés au niveau de la classe persistent entre les méthodes de test. Si vous avez besoin de les modifier, vous pouvez les recharger dans la méthode <code class="docutils literal notranslate"><span class="pre">setUp()</span></code> avec <a class="reference internal" href="../../ref/models/instances.html#django.db.models.Model.refresh_from_db" title="django.db.models.Model.refresh_from_db"><code class="xref py py-meth docutils literal notranslate"><span class="pre">refresh_from_db()</span></code></a>, par exemple.</p>
</dd></dl>

</div>
<div class="section" id="s-liveservertestcase">
<span id="s-live-test-server"></span><span id="liveservertestcase"></span><span id="live-test-server"></span><h3><code class="docutils literal notranslate"><span class="pre">LiveServerTestCase</span></code><a class="headerlink" href="#liveservertestcase" title="Lien permanent vers ce titre">¶</a></h3>
<dl class="class">
<dt id="django.test.LiveServerTestCase">
<em class="property">class </em><code class="descname">LiveServerTestCase</code><a class="headerlink" href="#django.test.LiveServerTestCase" title="Lien permanent vers cette définition">¶</a></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">LiveServerTestCase</span></code> est à la base identique à <a class="reference internal" href="#django.test.TransactionTestCase" title="django.test.TransactionTestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">TransactionTestCase</span></code></a> avec une fonction supplémentaire&nbsp;: elle lance un serveur Django en arrière-plan lors de la préparation («&nbsp;setUp&nbsp;») des tests et l’arrête lors du nettoyage («&nbsp;tearDown&nbsp;»). Cela permet l’utilisation de clients de tests automatisés autres que le <a class="reference internal" href="#test-client"><span class="std std-ref">client élémentaire de Django</span></a>, comme par exemple le client <a class="reference external" href="http://seleniumhq.org/">Selenium</a>, afin d’exécuter une série de tests fonctionnels dans un navigateur et de simuler ainsi des actions d’un utilisateur réel.</p>
<p>Le serveur «&nbsp;live&nbsp;» écoute sur <code class="docutils literal notranslate"><span class="pre">localhost</span></code> et se lie au port 0, ce qui utilise un port libre attribué par le système d’exploitation. L’URL du serveur est accessible dans <code class="docutils literal notranslate"><span class="pre">self.live_server_url</span></code> pendant les tests.</p>
<p>Pour démontrer comment utiliser <code class="docutils literal notranslate"><span class="pre">LiveServerTestCase</span></code>, écrivons un test Selenium. Premièrement, il s’agit d’installer le <a class="reference external" href="https://pypi.org/project/selenium/">paquet selenium</a> dans le chemin Python&nbsp;:</p>
<div class="console-block" id="console-block-0">
<input class="c-tab-unix" id="c-tab-0-unix" type="radio" name="console-0" checked>
<label for="c-tab-0-unix" title="Linux/macOS">&#xf17c/&#xf179</label>
<input class="c-tab-win" id="c-tab-0-win" type="radio" name="console-0">
<label for="c-tab-0-win" title="Windows">&#xf17a</label>
<section class="c-content-unix" id="c-content-0-unix">
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> python -m pip install selenium
</pre></div>
</div>
</section>
<section class="c-content-win" id="c-content-0-win">
<div class="highlight"><pre><span></span><span class="gp">...\&gt;</span> py -m pip install selenium
</pre></div>
</section>
</div>
<p>Puis, ajoutez un test basé sur <code class="docutils literal notranslate"><span class="pre">LiveServerTestCase</span></code> au module tests de votre application (par exemple <code class="docutils literal notranslate"><span class="pre">myapp/tests.py</span></code>). Pour cet exemple, nous supposons que vous utilisez l’application <a class="reference internal" href="../../ref/contrib/staticfiles.html#module-django.contrib.staticfiles" title="django.contrib.staticfiles: An app for handling static files."><code class="xref py py-mod docutils literal notranslate"><span class="pre">staticfiles</span></code></a> et que vous souhaitez disposez des fichiers statiques servis durant l’exécution des tests tout comme ce qu’on a en développement avec <code class="docutils literal notranslate"><span class="pre">DEBUG=True</span></code>, c’est-à-dire sans devoir les collecter avec <a class="reference internal" href="../../ref/contrib/staticfiles.html#django-admin-collectstatic"><code class="xref std std-djadmin docutils literal notranslate"><span class="pre">collectstatic</span></code></a>. Nous allons utiliser la sous-classe <a class="reference internal" href="../../ref/contrib/staticfiles.html#django.contrib.staticfiles.testing.StaticLiveServerTestCase" title="django.contrib.staticfiles.testing.StaticLiveServerTestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">StaticLiveServerTestCase</span></code></a> qui fournit cette fonctionnalité. Remplacez-la par <code class="docutils literal notranslate"><span class="pre">django.test.LiveServerTestCase</span></code> si vous n’en avez pas besoin.</p>
<p>Le code de ce test pourrait ressembler à ceci&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.staticfiles.testing</span> <span class="k">import</span> <span class="n">StaticLiveServerTestCase</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.firefox.webdriver</span> <span class="k">import</span> <span class="n">WebDriver</span>

<span class="k">class</span> <span class="nc">MySeleniumTests</span><span class="p">(</span><span class="n">StaticLiveServerTestCase</span><span class="p">):</span>
    <span class="n">fixtures</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user-data.json&#39;</span><span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">selenium</span> <span class="o">=</span> <span class="n">WebDriver</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">selenium</span><span class="o">.</span><span class="n">implicitly_wait</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">tearDownClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">selenium</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">tearDownClass</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selenium</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">live_server_url</span><span class="p">,</span> <span class="s1">&#39;/login/&#39;</span><span class="p">))</span>
        <span class="n">username_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selenium</span><span class="o">.</span><span class="n">find_element_by_name</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">)</span>
        <span class="n">username_input</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s1">&#39;myuser&#39;</span><span class="p">)</span>
        <span class="n">password_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selenium</span><span class="o">.</span><span class="n">find_element_by_name</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">)</span>
        <span class="n">password_input</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s1">&#39;secret&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selenium</span><span class="o">.</span><span class="n">find_element_by_xpath</span><span class="p">(</span><span class="s1">&#39;//input[@value=&quot;Log in&quot;]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
</pre></div>
</div>
<p>Finalement, lancez le test comme ceci&nbsp;:</p>
<div class="console-block" id="console-block-1">
<input class="c-tab-unix" id="c-tab-1-unix" type="radio" name="console-1" checked>
<label for="c-tab-1-unix" title="Linux/macOS">&#xf17c/&#xf179</label>
<input class="c-tab-win" id="c-tab-1-win" type="radio" name="console-1">
<label for="c-tab-1-win" title="Windows">&#xf17a</label>
<section class="c-content-unix" id="c-content-1-unix">
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ./manage.py <span class="nb">test</span> myapp.tests.MySeleniumTests.test_login
</pre></div>
</div>
</section>
<section class="c-content-win" id="c-content-1-win">
<div class="highlight"><pre><span></span><span class="gp">...\&gt;</span> manage.py test myapp.tests.MySeleniumTests.test_login
</pre></div>
</section>
</div>
<p>Cet exemple ouvre Firefox automatiquement puis se rend à la page de connexion, saisit les données d’authentification et appuie sur le bouton «&nbsp;Log in&nbsp;». Selenium propose d’autres pilotes dans le cas où Firefox n’est pas installé ou que vous voudriez tester avec un autre navigateur. L’exemple ci-dessus n’est qu’une fraction de ce que le client Selenium est capable de faire&nbsp;; consultez la <a class="reference external" href="https://selenium-python.readthedocs.io/api.html">référence complète</a> pour plus de détails.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Lorsque les tests utilisent une base de données SQLite en mémoire, une même connexion de base de données sera partagée par deux fils d’exécution en parallèle&nbsp;: le fil dans lequel tourne le serveur «&nbsp;live&nbsp;» et le fil utilisé pour faire fonctionner le cas de test. Il est important de prévenir les requêtes de base de données simultanées au travers de cette connexion partagée, car cela pourrait provoquer l’échec aléatoire de certains tests. Vous devez donc vous assurer que les deux fils d’exécution n’accèdent pas à la base de données au même moment. En particulier, cela signifie que dans certains cas (par exemple juste après avoir cliqué sur un lien ou soumis un formulaire), il est nécessaire de contrôler qu’une réponse a été reçue par Selenium et que la page suivante a été chargée avant de continuer avec la suite de l’exécution des tests. Cela peur par exemple se faire en faisant attendre Selenium jusqu’à ce que la balise HTML <code class="docutils literal notranslate"><span class="pre">&lt;body&gt;</span></code> soit présente dans la réponse (nécessite Selenium &gt; 2.13)&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">selenium.webdriver.support.wait</span> <span class="k">import</span> <span class="n">WebDriverWait</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="o">...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">selenium</span><span class="o">.</span><span class="n">find_element_by_xpath</span><span class="p">(</span><span class="s1">&#39;//input[@value=&quot;Log in&quot;]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
    <span class="c1"># Wait until the response is received</span>
    <span class="n">WebDriverWait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selenium</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span><span class="o">.</span><span class="n">until</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">driver</span><span class="p">:</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element_by_tag_name</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p class="last">L’élément délicat ici est que le concept de «&nbsp;chargement de page&nbsp;» n’existe pas, particulièrement dans les applications Web modernes qui produisent du code HTML dynamique après la génération du document initial par le serveur. Ceci fait que le contrôle de la présence de <code class="docutils literal notranslate"><span class="pre">&lt;body&gt;</span></code> dans la réponse n’est pas forcément approprié dans tous les cas de figure. Consultez la <a class="reference external" href="https://www.selenium.dev/documentation/en/webdriver/waits/#explicit-wait">FAQ Selenium</a> ainsi que la <a class="reference external" href="https://web.archive.org/web/20160129132110/http://code.google.com/p/selenium/wiki/FrequentlyAskedQuestions#Q:_WebDriver_fails_to_find_elements_/_Does_not_block_on_page_loa">documentation Selenium</a> pour obtenir davantage d’informations.</p>
</div>
</div>
</div>
<div class="section" id="s-test-cases-features">
<span id="test-cases-features"></span><h2>Fonctionnalités des cas de test<a class="headerlink" href="#test-cases-features" title="Lien permanent vers ce titre">¶</a></h2>
<div class="section" id="s-default-test-client">
<span id="default-test-client"></span><h3>Client de test par défaut<a class="headerlink" href="#default-test-client" title="Lien permanent vers ce titre">¶</a></h3>
<dl class="attribute">
<dt id="django.test.SimpleTestCase.client">
<code class="descclassname">SimpleTestCase.</code><code class="descname">client</code><a class="headerlink" href="#django.test.SimpleTestCase.client" title="Lien permanent vers cette définition">¶</a></dt>
<dd></dd></dl>

<p>Chaque cas de test dans une instance de <code class="docutils literal notranslate"><span class="pre">django.test.*TestCase</span></code> peut accéder à une instance du client de test de Django. Ce client est disponible dans self.client. Il est recréé pour chaque test, il n’y a donc pas besoin de se soucier de son état (comme les cookies) qui pourrait se propager d’un test à l’autre.</p>
<p>Cela signifie qu’au lieu de créer une instance de <code class="docutils literal notranslate"><span class="pre">Client</span></code> dans chaque test&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="k">import</span> <span class="n">Client</span>

<span class="k">class</span> <span class="nc">SimpleTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_details</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/customer/details/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/customer/index/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
<p>…vous pouvez faire appel à <code class="docutils literal notranslate"><span class="pre">self.client</span></code>, comme ceci&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.test</span> <span class="k">import</span> <span class="n">TestCase</span>

<span class="k">class</span> <span class="nc">SimpleTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_details</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/customer/details/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/customer/index/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="s-customizing-the-test-client">
<span id="customizing-the-test-client"></span><h3>Personnalisation du client de test<a class="headerlink" href="#customizing-the-test-client" title="Lien permanent vers ce titre">¶</a></h3>
<dl class="attribute">
<dt id="django.test.SimpleTestCase.client_class">
<code class="descclassname">SimpleTestCase.</code><code class="descname">client_class</code><a class="headerlink" href="#django.test.SimpleTestCase.client_class" title="Lien permanent vers cette définition">¶</a></dt>
<dd></dd></dl>

<p>Si vous souhaitez utiliser une classe <code class="docutils literal notranslate"><span class="pre">Client</span></code> différente (par exemple une sous-classe avec un comportement adapté), utilisez l’attribut de classe <a class="reference internal" href="#django.test.SimpleTestCase.client_class" title="django.test.SimpleTestCase.client_class"><code class="xref py py-attr docutils literal notranslate"><span class="pre">client_class</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.test</span> <span class="k">import</span> <span class="n">Client</span><span class="p">,</span> <span class="n">TestCase</span>

<span class="k">class</span> <span class="nc">MyTestClient</span><span class="p">(</span><span class="n">Client</span><span class="p">):</span>
    <span class="c1"># Specialized methods for your environment</span>
    <span class="o">...</span>

<span class="k">class</span> <span class="nc">MyTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">client_class</span> <span class="o">=</span> <span class="n">MyTestClient</span>

    <span class="k">def</span> <span class="nf">test_my_stuff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Here self.client is an instance of MyTestClient...</span>
        <span class="n">call_some_test_code</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="s-fixture-loading">
<span id="s-topics-testing-fixtures"></span><span id="fixture-loading"></span><span id="topics-testing-fixtures"></span><h3>Chargement des instantanés<a class="headerlink" href="#fixture-loading" title="Lien permanent vers ce titre">¶</a></h3>
<dl class="attribute">
<dt id="django.test.TransactionTestCase.fixtures">
<code class="descclassname">TransactionTestCase.</code><code class="descname">fixtures</code><a class="headerlink" href="#django.test.TransactionTestCase.fixtures" title="Lien permanent vers cette définition">¶</a></dt>
<dd></dd></dl>

<p>Un cas de test pour un site Web adossé à une base de données n’est pas très utile s’il n’y a pas de données en base de données. Les tests sont plus lisibles et la maintenabilité est meilleure si les objets sont créés avec l’ORM, par exemple dans <a class="reference internal" href="#django.test.TestCase.setUpTestData" title="django.test.TestCase.setUpTestData"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TestCase.setUpTestData()</span></code></a>. Cependant, vous pouvez aussi utiliser des instantanés.</p>
<p>Un instantané est une série de données que Django sait importer dans la base de données. Par exemple, si votre site contient des comptes utilisateurs, il peut être utile de créer un instantané de comptes utilisateurs afin de remplir la base de données pendant les tests.</p>
<p>La façon la plus directe de créer un instantané est d’utiliser la commande <a class="reference internal" href="../../ref/django-admin.html#django-admin-dumpdata"><code class="xref std std-djadmin docutils literal notranslate"><span class="pre">manage.py</span> <span class="pre">dumpdata</span></code></a>, en partant du principe que le base de données contient déjà les données nécessaires. Consultez la <a class="reference internal" href="../../ref/django-admin.html#django-admin-dumpdata"><code class="xref std std-djadmin docutils literal notranslate"><span class="pre">documentation</span> <span class="pre">de</span> <span class="pre">dumpdata</span></code></a> pour plus de détails.</p>
<p>Après avoir créé un instantané et l’avoir placé dans un répertoire <code class="docutils literal notranslate"><span class="pre">fixtures</span></code> dans l’une des applications de <a class="reference internal" href="../../ref/settings.html#std:setting-INSTALLED_APPS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">INSTALLED_APPS</span></code></a>, vous pouvez l’utiliser dans vos tests unitaires en définissant un attribut de classe <code class="docutils literal notranslate"><span class="pre">fixtures</span></code> dans votre sous-classe de <a class="reference internal" href="#django.test.TestCase" title="django.test.TestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">django.test.TestCase</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.test</span> <span class="k">import</span> <span class="n">TestCase</span>
<span class="kn">from</span> <span class="nn">myapp.models</span> <span class="k">import</span> <span class="n">Animal</span>

<span class="k">class</span> <span class="nc">AnimalTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">fixtures</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mammals.json&#39;</span><span class="p">,</span> <span class="s1">&#39;birds&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Test definitions as before.</span>
        <span class="n">call_setup_methods</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_fluffy_animals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># A test that uses the fixtures.</span>
        <span class="n">call_some_test_code</span><span class="p">()</span>
</pre></div>
</div>
<p>Voici ce qui se passe en pratique&nbsp;:</p>
<ul class="simple">
<li>Au début de chaque test, avant l’exécution de <code class="docutils literal notranslate"><span class="pre">setUp()</span></code>, Django réinitialise la base de données telle qu’elle se trouvait juste après avoir exécuté <a class="reference internal" href="../../ref/django-admin.html#django-admin-migrate"><code class="xref std std-djadmin docutils literal notranslate"><span class="pre">migrate</span></code></a>.</li>
<li>Puis, tous les instantanés nommés sont installés. Dans cet exemple, Django installe tout instantané JSON nommé <code class="docutils literal notranslate"><span class="pre">mammals</span></code>, suivi par tout instantané nommé <code class="docutils literal notranslate"><span class="pre">birds</span></code>. Consultez la documentation de <a class="reference internal" href="../../ref/django-admin.html#django-admin-loaddata"><code class="xref std std-djadmin docutils literal notranslate"><span class="pre">loaddata</span></code></a> pour plus de détails sur la définition et l’installation d’instantanés.</li>
</ul>
<p>Pour des raisons de performance, <a class="reference internal" href="#django.test.TestCase" title="django.test.TestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">TestCase</span></code></a> charge les instantanés une seule fois pour toute la classe de tests, avant <a class="reference internal" href="#django.test.TestCase.setUpTestData" title="django.test.TestCase.setUpTestData"><code class="xref py py-meth docutils literal notranslate"><span class="pre">setUpTestData()</span></code></a>, au lieu de le faire avant chaque test. Elle utilise les transactions pour réinitialiser la base de données avant chaque test. Dans tous les cas, vous pouvez être sûr que le résultat d’un test ne sera pas affecté par un autre test ou par l’ordre d’exécution des tests.</p>
<p>Par défaut, les instantanés ne sont chargés que dans la base de données <code class="docutils literal notranslate"><span class="pre">default</span></code>. Si vous utilisez plusieurs bases de données et que vous définissez :<a class="reference internal" href="#django.test.TransactionTestCase.databases" title="django.test.TransactionTestCase.databases"><code class="xref py py-attr docutils literal notranslate"><span class="pre">TransactionTestCase.databases</span></code></a>, les instantanés seront chargés dans toutes les bases de données indiquées.</p>
</div>
<div class="section" id="s-urlconf-configuration">
<span id="urlconf-configuration"></span><h3>Configuration des URL<a class="headerlink" href="#urlconf-configuration" title="Lien permanent vers ce titre">¶</a></h3>
<p>Si une application contient des vues, il peut être souhaitable d’inclure des tests où le client de test éprouve ces vues. Cependant, un utilisateur de l’application est libre de déployer les vues d’une application à l’URL de son choix. Cela signifie que les tests ne peuvent pas compter sur des URL figées pour accéder aux vues. Décorez vos classes ou méthodes de test avec <code class="docutils literal notranslate"><span class="pre">&#64;override_settings(ROOT_URLCONF=...)</span></code> pour imposer des configurations d’URL.</p>
</div>
<div class="section" id="s-multi-database-support">
<span id="s-testing-multi-db"></span><span id="multi-database-support"></span><span id="testing-multi-db"></span><h3>Prise en charge de plusieurs bases de données<a class="headerlink" href="#multi-database-support" title="Lien permanent vers ce titre">¶</a></h3>
<dl class="attribute">
<dt id="django.test.TransactionTestCase.databases">
<code class="descclassname">TransactionTestCase.</code><code class="descname">databases</code><a class="headerlink" href="#django.test.TransactionTestCase.databases" title="Lien permanent vers cette définition">¶</a></dt>
<dd></dd></dl>

<p>Django met en place une base de données de test pour chaque base de données définie dans la définition de <a class="reference internal" href="../../ref/settings.html#std:setting-DATABASES"><code class="xref std std-setting docutils literal notranslate"><span class="pre">DATABASES</span></code></a> dans vos réglages et qui est référencée par au moins un test au travers de <code class="docutils literal notranslate"><span class="pre">databases</span></code>.</p>
<p>Cependant, une bonne partie du temps nécessaire à exécuter un cas de test Django est passé dans l’appel à <code class="docutils literal notranslate"><span class="pre">flush</span></code> (réinitialisation des données) permettant de retrouver une base de données propre au début de chaque test. Pour un projet avec plusieurs bases de données, plusieurs commandes <code class="docutils literal notranslate"><span class="pre">flush</span></code> sont nécessaires (une par base de données), ce qui peut représenter un temps non négligeable, particulièrement si les tests n’ont pas pour but de tester l’activité entre plusieurs bases de données.</p>
<p>Dans une optique d’optimisation, Django ne réinitialise que la base de données <code class="docutils literal notranslate"><span class="pre">default</span></code> au début de chaque test. Si votre configuration contient plusieurs bases de données et que certains tests nécessitent que toutes les bases de données soient propres, vous pouvez définir l’attribut <code class="docutils literal notranslate"><span class="pre">databases</span></code> de la suite de tests pour provoquer la réinitialisation des bases de données supplémentaires.</p>
<p>Par exemple&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestMyViews</span><span class="p">(</span><span class="n">TransactionTestCase</span><span class="p">):</span>
    <span class="n">databases</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">test_index_page_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">call_some_test_code</span><span class="p">()</span>
</pre></div>
</div>
<p>Ce cas de test réinitialise les bases de données de test <code class="docutils literal notranslate"><span class="pre">default</span></code> et <code class="docutils literal notranslate"><span class="pre">other</span></code> avant d’exécuter <code class="docutils literal notranslate"><span class="pre">test_index_page_view</span></code>. Vous pouvez aussi indiquer <code class="docutils literal notranslate"><span class="pre">'__all__'</span></code> qui demande à ce que toutes les bases de données de test soient réinitialisées.</p>
<p>L’option <code class="docutils literal notranslate"><span class="pre">databases</span></code> contrôle également les bases données dans lesquelles sont chargés les instantanés (<a class="reference internal" href="#django.test.TransactionTestCase.fixtures" title="django.test.TransactionTestCase.fixtures"><code class="xref py py-attr docutils literal notranslate"><span class="pre">TransactionTestCase.fixtures</span></code></a>). Par défaut, les instantanés ne sont chargés que dans la base de données <code class="docutils literal notranslate"><span class="pre">default</span></code>.</p>
<p>Les requêtes ciblant des bases de données absentes de <code class="docutils literal notranslate"><span class="pre">databases</span></code> produiront des erreurs d’assertion pour éviter des fuites d’état entre les tests.</p>
<dl class="attribute">
<dt id="django.test.TestCase.databases">
<code class="descclassname">TestCase.</code><code class="descname">databases</code><a class="headerlink" href="#django.test.TestCase.databases" title="Lien permanent vers cette définition">¶</a></dt>
<dd></dd></dl>

<p>Par défaut, seule la base de données <code class="docutils literal notranslate"><span class="pre">default</span></code> est enveloppée dans une transaction durant l’exécution d’un cas de test ; toute tentative d’interroger une autre base de données produira une erreur d’assertion pour empêcher toute fuite d’état entre les tests.</p>
<p>Utilisez l’attribut de classe <code class="docutils literal notranslate"><span class="pre">databases</span></code> sur la classe de test pour demander l’emploi des transactions pour les bases de données autres que <code class="docutils literal notranslate"><span class="pre">default</span></code>.</p>
<p>Par exemple&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OtherDBTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">databases</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;other&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">test_other_db_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>Ce test n’autorisera que les requêtes vers las base de données <code class="docutils literal notranslate"><span class="pre">other</span></code>. Comme pour <a class="reference internal" href="#django.test.SimpleTestCase.databases" title="django.test.SimpleTestCase.databases"><code class="xref py py-attr docutils literal notranslate"><span class="pre">SimpleTestCase.databases</span></code></a> et <a class="reference internal" href="#django.test.TransactionTestCase.databases" title="django.test.TransactionTestCase.databases"><code class="xref py py-attr docutils literal notranslate"><span class="pre">TransactionTestCase.databases</span></code></a>, la constante <code class="docutils literal notranslate"><span class="pre">'__all__'</span></code> peut être employée pour indiquer que le test doit autoriser les requêtes vers toutes les bases de données.</p>
</div>
<div class="section" id="s-overriding-settings">
<span id="s-id1"></span><span id="overriding-settings"></span><span id="id1"></span><h3>Surcharge des réglages<a class="headerlink" href="#overriding-settings" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Utilisez les fonctions ci-dessous pour modifier temporairement la valeur de certains réglages pendant les tests. Ne manipulez pas directement <code class="docutils literal notranslate"><span class="pre">django.conf.settings</span></code> car Django ne s’occupe pas de restaurer les valeurs d’origine après de telles manipulations.</p>
</div>
<dl class="method">
<dt id="django.test.SimpleTestCase.settings">
<code class="descclassname">SimpleTestCase.</code><code class="descname">settings</code>()<a class="headerlink" href="#django.test.SimpleTestCase.settings" title="Lien permanent vers cette définition">¶</a></dt>
<dd></dd></dl>

<p>À des fins de tests, il est souvent utile de modifier temporairement un réglage puis de retrouver la valeur d’origine après l’exécution du code des tests. Pour cette situation, Django offre un gestionnaire de contexte de style Python (voir <span class="target" id="index-7"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0343"><strong>PEP 343</strong></a>) nommé <a class="reference internal" href="#django.test.SimpleTestCase.settings" title="django.test.SimpleTestCase.settings"><code class="xref py py-meth docutils literal notranslate"><span class="pre">settings()</span></code></a> qui peut être utilisé comme ceci&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.test</span> <span class="k">import</span> <span class="n">TestCase</span>

<span class="k">class</span> <span class="nc">LoginTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># First check for the default behavior</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/sekrit/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRedirects</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;/accounts/login/?next=/sekrit/&#39;</span><span class="p">)</span>

        <span class="c1"># Then override the LOGIN_URL setting</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">(</span><span class="n">LOGIN_URL</span><span class="o">=</span><span class="s1">&#39;/other/login/&#39;</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/sekrit/&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRedirects</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;/other/login/?next=/sekrit/&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Cet exemple surcharge le réglage <a class="reference internal" href="../../ref/settings.html#std:setting-LOGIN_URL"><code class="xref std std-setting docutils literal notranslate"><span class="pre">LOGIN_URL</span></code></a> pour le code contenu dans le bloc <code class="docutils literal notranslate"><span class="pre">with</span></code> et réapplique la valeur originale à la fin du bloc.</p>
<dl class="method">
<dt id="django.test.SimpleTestCase.modify_settings">
<code class="descclassname">SimpleTestCase.</code><code class="descname">modify_settings</code>()<a class="headerlink" href="#django.test.SimpleTestCase.modify_settings" title="Lien permanent vers cette définition">¶</a></dt>
<dd></dd></dl>

<p>La redéfinition de réglages contenant une liste de valeurs peut se révéler ardue. En pratique, l’ajout ou la suppression de valeurs est souvent suffisante. Django fournit le gestionnaire de contexte <a class="reference internal" href="#django.test.SimpleTestCase.modify_settings" title="django.test.SimpleTestCase.modify_settings"><code class="xref py py-meth docutils literal notranslate"><span class="pre">modify_settings()</span></code></a> pour changer plus facilement les réglages&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.test</span> <span class="k">import</span> <span class="n">TestCase</span>

<span class="k">class</span> <span class="nc">MiddlewareTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_cache_middleware</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify_settings</span><span class="p">(</span><span class="n">MIDDLEWARE</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;append&#39;</span><span class="p">:</span> <span class="s1">&#39;django.middleware.cache.FetchFromCacheMiddleware&#39;</span><span class="p">,</span>
            <span class="s1">&#39;prepend&#39;</span><span class="p">:</span> <span class="s1">&#39;django.middleware.cache.UpdateCacheMiddleware&#39;</span><span class="p">,</span>
            <span class="s1">&#39;remove&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;django.contrib.sessions.middleware.SessionMiddleware&#39;</span><span class="p">,</span>
                <span class="s1">&#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;</span><span class="p">,</span>
                <span class="s1">&#39;django.contrib.messages.middleware.MessageMiddleware&#39;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">}):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="c1"># ...</span>
</pre></div>
</div>
<p>Pour chaque action, vous pouvez indiquer soit une liste de valeurs, soit une chaîne. Lorsque la valeur existe déjà dans la liste, <code class="docutils literal notranslate"><span class="pre">append</span></code> et <code class="docutils literal notranslate"><span class="pre">prepend</span></code> n’ont pas d’effet&nbsp;; de même que <code class="docutils literal notranslate"><span class="pre">remove</span></code> lorsque la valeur n’existe pas.</p>
<dl class="function">
<dt id="django.test.override_settings">
<code class="descname">override_settings</code>()<a class="headerlink" href="#django.test.override_settings" title="Lien permanent vers cette définition">¶</a></dt>
<dd></dd></dl>

<p>Dans le cas où vous souhaitez remplacer un réglage pour une méthode de test, Django met à disposition le décorateur <a class="reference internal" href="#django.test.override_settings" title="django.test.override_settings"><code class="xref py py-func docutils literal notranslate"><span class="pre">override_settings()</span></code></a> (voir <span class="target" id="index-8"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0318"><strong>PEP 318</strong></a>). Voici comment l’utiliser&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.test</span> <span class="k">import</span> <span class="n">TestCase</span><span class="p">,</span> <span class="n">override_settings</span>

<span class="k">class</span> <span class="nc">LoginTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">LOGIN_URL</span><span class="o">=</span><span class="s1">&#39;/other/login/&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/sekrit/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRedirects</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;/other/login/?next=/sekrit/&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Le décorateur peut aussi être appliqué à des classes <a class="reference internal" href="#django.test.TestCase" title="django.test.TestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">TestCase</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.test</span> <span class="k">import</span> <span class="n">TestCase</span><span class="p">,</span> <span class="n">override_settings</span>

<span class="nd">@override_settings</span><span class="p">(</span><span class="n">LOGIN_URL</span><span class="o">=</span><span class="s1">&#39;/other/login/&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LoginTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/sekrit/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRedirects</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;/other/login/?next=/sekrit/&#39;</span><span class="p">)</span>
</pre></div>
</div>
<dl class="function">
<dt id="django.test.modify_settings">
<code class="descname">modify_settings</code>()<a class="headerlink" href="#django.test.modify_settings" title="Lien permanent vers cette définition">¶</a></dt>
<dd></dd></dl>

<p>Dans le même ordre d’idée, Django fournit le décorateur <a class="reference internal" href="#django.test.modify_settings" title="django.test.modify_settings"><code class="xref py py-func docutils literal notranslate"><span class="pre">modify_settings()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.test</span> <span class="k">import</span> <span class="n">TestCase</span><span class="p">,</span> <span class="n">modify_settings</span>

<span class="k">class</span> <span class="nc">MiddlewareTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="nd">@modify_settings</span><span class="p">(</span><span class="n">MIDDLEWARE</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;append&#39;</span><span class="p">:</span> <span class="s1">&#39;django.middleware.cache.FetchFromCacheMiddleware&#39;</span><span class="p">,</span>
        <span class="s1">&#39;prepend&#39;</span><span class="p">:</span> <span class="s1">&#39;django.middleware.cache.UpdateCacheMiddleware&#39;</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="k">def</span> <span class="nf">test_cache_middleware</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="c1"># ...</span>
</pre></div>
</div>
<p>Le décorateur peut aussi être appliqué à des classes de cas de test&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.test</span> <span class="k">import</span> <span class="n">TestCase</span><span class="p">,</span> <span class="n">modify_settings</span>

<span class="nd">@modify_settings</span><span class="p">(</span><span class="n">MIDDLEWARE</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">&#39;append&#39;</span><span class="p">:</span> <span class="s1">&#39;django.middleware.cache.FetchFromCacheMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;prepend&#39;</span><span class="p">:</span> <span class="s1">&#39;django.middleware.cache.UpdateCacheMiddleware&#39;</span><span class="p">,</span>
<span class="p">})</span>
<span class="k">class</span> <span class="nc">MiddlewareTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_cache_middleware</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="c1"># ...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Lorsqu’ils reçoivent une classe, ces décorateurs modifient directement la classe et la renvoie&nbsp;; la classe renvoyée n’est pas une copie. Ainsi si vous essayez de manipuler les exemples ci-dessus pour que la valeur renvoyée soit nommée différemment que <code class="docutils literal notranslate"><span class="pre">LoginTestCase</span></code> ou <code class="docutils literal notranslate"><span class="pre">MiddlewareTestCase</span></code>, vous pourriez être surpris de constater que les classes de cas de test originales sont tout de même affectées par le décorateur. Pour une classe donnée, <a class="reference internal" href="#django.test.modify_settings" title="django.test.modify_settings"><code class="xref py py-func docutils literal notranslate"><span class="pre">modify_settings()</span></code></a> est toujours appliqué après <a class="reference internal" href="#django.test.override_settings" title="django.test.override_settings"><code class="xref py py-func docutils literal notranslate"><span class="pre">override_settings()</span></code></a>.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p>Le fichier de réglages contient certains réglages qui ne sont consultés que lors de l’initialisation de paramètres internes à Django. Si vous les modifier avec <code class="docutils literal notranslate"><span class="pre">override_settings</span></code>, ces réglages sont bien modifiés si vous les appelez depuis le module <code class="docutils literal notranslate"><span class="pre">django.conf.settings</span></code>, mais les éléments internes de Django accèdent différemment à ces réglages. En pratique, l’utilisation de <a class="reference internal" href="#django.test.override_settings" title="django.test.override_settings"><code class="xref py py-func docutils literal notranslate"><span class="pre">override_settings()</span></code></a> ou de <a class="reference internal" href="#django.test.modify_settings" title="django.test.modify_settings"><code class="xref py py-func docutils literal notranslate"><span class="pre">modify_settings()</span></code></a> avec ces réglages ne va probablement pas avoir l’effet que vous attendez.</p>
<p>Il n’est pas recommandé de modifier le réglage <a class="reference internal" href="../../ref/settings.html#std:setting-DATABASES"><code class="xref std std-setting docutils literal notranslate"><span class="pre">DATABASES</span></code></a>. La modification du réglage <a class="reference internal" href="../../ref/settings.html#std:setting-CACHES"><code class="xref std std-setting docutils literal notranslate"><span class="pre">CACHES</span></code></a> est possible, mais un peu délicat si vous utilisez des éléments internes qui s’appuient sur du cache, comme <a class="reference internal" href="../http/sessions.html#module-django.contrib.sessions" title="django.contrib.sessions: Provides session management for Django projects."><code class="xref py py-mod docutils literal notranslate"><span class="pre">django.contrib.sessions</span></code></a>. Par exemple, il faut réinitialiser le moteur de sessions dans un test qui utilise les sessions en cache et qui surcharge <a class="reference internal" href="../../ref/settings.html#std:setting-CACHES"><code class="xref std std-setting docutils literal notranslate"><span class="pre">CACHES</span></code></a>.</p>
<p class="last">Pour terminer, évitez de créer des alias de réglages comme constantes de niveau module, car <code class="docutils literal notranslate"><span class="pre">override_settings()</span></code> ne fonctionnera pas avec de telles valeurs qui ne sont évaluées que lors de la première importation du module.</p>
</div>
<p>Il est aussi possible de simuler l’absence d’un réglage en supprimant celui-ci après que les réglages aient été surchargés, comme ceci&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@override_settings</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">test_something</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">del</span> <span class="n">settings</span><span class="o">.</span><span class="n">LOGIN_URL</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Lors de la surcharge de réglages, prenez soin de gérer les cas où le code de votre application utilise du cache ou un mécanisme similaire conservant l’état même quand le réglage a changé. Django fournit le signal <a class="reference internal" href="../../ref/signals.html#django.test.signals.setting_changed" title="django.test.signals.setting_changed"><code class="xref py py-data docutils literal notranslate"><span class="pre">django.test.signals.setting_changed</span></code></a> permettant d’inscrire des fonctions de rappel qui serviront à réinitialiser l’état lorsque les réglages ont changé.</p>
<p>Django utilise lui-même ce signal pour réinitialiser différentes données&nbsp;:</p>
<table class="docutils">
<colgroup>
<col width="43%" />
<col width="57%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Réglages surchargés</th>
<th class="head">Données réinitialisées</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>USE_TZ, TIME_ZONE</td>
<td>Fuseau horaire de la base de données</td>
</tr>
<tr class="row-odd"><td>TEMPLATES</td>
<td>Moteurs de gabarits</td>
</tr>
<tr class="row-even"><td>SERIALIZATION_MODULES</td>
<td>Cache des sérialiseurs</td>
</tr>
<tr class="row-odd"><td>LOCALE_PATHS, LANGUAGE_CODE</td>
<td>Traduction par défaut et traductions chargées</td>
</tr>
<tr class="row-even"><td>MEDIA_ROOT, DEFAULT_FILE_STORAGE</td>
<td>Stockage de fichiers par défaut</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="s-emptying-the-test-outbox">
<span id="s-emptying-test-outbox"></span><span id="emptying-the-test-outbox"></span><span id="emptying-test-outbox"></span><h3>Vidage de la boîte de messagerie de test<a class="headerlink" href="#emptying-the-test-outbox" title="Lien permanent vers ce titre">¶</a></h3>
<p>Si vous utilisez l’une des classes <code class="docutils literal notranslate"><span class="pre">TestCase</span></code> personnalisées de Django, l’exécuteur de tests efface le contenu de la boîte de messagerie de test au début de chaque cas de test.</p>
<p>Pour plus de détails sur les services de messagerie durant les tests, consultez <a class="reference internal" href="#email-services">Services de messagerie</a> plus bas dans ce document.</p>
</div>
<div class="section" id="s-assertions">
<span id="s-id2"></span><span id="assertions"></span><span id="id2"></span><h3>Assertions<a class="headerlink" href="#assertions" title="Lien permanent vers ce titre">¶</a></h3>
<p>De la même manière que la classe <a class="reference external" href="https://docs.python.org/3/library/unittest.html#unittest.TestCase" title="(disponible dans Python v3.9)"><code class="xref py py-class docutils literal notranslate"><span class="pre">unittest.TestCase</span></code></a> normale de Python implément des méthodes d’assertion telles que <a class="reference external" href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.assertTrue" title="(disponible dans Python v3.9)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">assertTrue()</span></code></a> et <a class="reference external" href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.assertEqual" title="(disponible dans Python v3.9)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">assertEqual()</span></code></a>, la classe <a class="reference internal" href="#django.test.TestCase" title="django.test.TestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">TestCase</span></code></a> propre à Django fournit un certain nombre de méthodes d’assertion utiles pour tester les applications Web&nbsp;:</p>
<p>Les messages d’échec produits par la plupart de ces méthodes d’assertion peuvent être personnalisés par le paramètre <code class="docutils literal notranslate"><span class="pre">msg_prefix</span></code>. Cette chaîne préfixe tout message d’échec généré par l’assertion. Ceci permet d’ajouter des détails pouvant aider à identifier l’emplacement et la cause d’un échec dans une suite de tests.</p>
<dl class="method">
<dt id="django.test.SimpleTestCase.assertRaisesMessage">
<code class="descclassname">SimpleTestCase.</code><code class="descname">assertRaisesMessage</code>(<em>expected_exception</em>, <em>expected_message</em>, <em>callable</em>, <em>*args</em>, <em>**kwargs</em>)<a class="headerlink" href="#django.test.SimpleTestCase.assertRaisesMessage" title="Lien permanent vers cette définition">¶</a></dt>
<dt>
<code class="descclassname">SimpleTestCase.</code><code class="descname">assertRaisesMessage</code>(<em>expected_exception</em>, <em>expected_message</em>)</dt>
<dd><p>Confirme que l’appel à l’exécutable <code class="docutils literal notranslate"><span class="pre">callable</span></code> génère l’exception <code class="docutils literal notranslate"><span class="pre">expected_exception</span></code> et que <code class="docutils literal notranslate"><span class="pre">expected_message</span></code> est trouvé dans le message de l’exception. Tout autre résultat est signalé comme un échec. Il s’agit d’une version simplifiée de <a class="reference external" href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.assertRaisesRegex" title="(disponible dans Python v3.9)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">unittest.TestCase.assertRaisesRegex()</span></code></a>, à la différence près que <code class="docutils literal notranslate"><span class="pre">expected_message</span></code> n’est ici pas traité comme une expression régulière.</p>
<p>Si seuls les paramètres <code class="docutils literal notranslate"><span class="pre">expected_exception</span></code> et <code class="docutils literal notranslate"><span class="pre">expected_message</span></code> sont donnés, renvoie un gestionnaire de contexte afin que le code en cours de test puisse être écrit en ligne plutôt que sous la forme d’une fonction&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;invalid literal for int()&#39;</span><span class="p">):</span>
    <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="django.test.SimpleTestCase.assertWarnsMessage">
<code class="descclassname">SimpleTestCase.</code><code class="descname">assertWarnsMessage</code>(<em>expected_warning</em>, <em>expected_message</em>, <em>callable</em>, <em>*args</em>, <em>**kwargs</em>)<a class="headerlink" href="#django.test.SimpleTestCase.assertWarnsMessage" title="Lien permanent vers cette définition">¶</a></dt>
<dt>
<code class="descclassname">SimpleTestCase.</code><code class="descname">assertWarnsMessage</code>(<em>expected_warning</em>, <em>expected_message</em>)</dt>
<dd><p>Analogue à <a class="reference internal" href="#django.test.SimpleTestCase.assertRaisesMessage" title="django.test.SimpleTestCase.assertRaisesMessage"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SimpleTestCase.assertRaisesMessage()</span></code></a> mais pour <a class="reference external" href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.assertWarnsRegex" title="(disponible dans Python v3.9)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">assertWarnsRegex()</span></code></a> au lieu de <a class="reference external" href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.assertRaisesRegex" title="(disponible dans Python v3.9)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">assertRaisesRegex()</span></code></a>.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.SimpleTestCase.assertFieldOutput">
<code class="descclassname">SimpleTestCase.</code><code class="descname">assertFieldOutput</code>(<em>fieldclass</em>, <em>valid</em>, <em>invalid</em>, <em>field_args=None</em>, <em>field_kwargs=None</em>, <em>empty_value=''</em>)<a class="headerlink" href="#django.test.SimpleTestCase.assertFieldOutput" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Confirme qu’un champ de formulaire se comporte correctement avec différentes valeurs soumises.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Paramètres:</th><td class="field-body"><ul class="first last simple">
<li><strong>fieldclass</strong> – la classe du champ à tester.</li>
<li><strong>valid</strong> – un dictionnaire faisant correspondre des valeurs de saisies valides aux valeurs nettoyées attendues.</li>
<li><strong>invalid</strong> – un dictionnaire faisant correspondre des valeurs de saisies non valides à un ou plusieurs messages d’erreur attendus.</li>
<li><strong>field_args</strong> – les paramètres positionnels transmis pour la création du champ.</li>
<li><strong>field_kwargs</strong> – les paramètres nommés transmis pour la création du champ.</li>
<li><strong>empty_value</strong> – le résultat nettoyé attendu pour les valeurs saisies contenues dans <code class="docutils literal notranslate"><span class="pre">empty_values</span></code>.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Par exemple, le code suivant teste qu’un champ <code class="docutils literal notranslate"><span class="pre">EmailField</span></code> accepte <code class="docutils literal notranslate"><span class="pre">a&#64;a.com</span></code> comme adresse électronique valide, mais rejette <code class="docutils literal notranslate"><span class="pre">aaa</span></code> avec un message d’erreur adéquat&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">assertFieldOutput</span><span class="p">(</span><span class="n">EmailField</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;a@a.com&#39;</span><span class="p">:</span> <span class="s1">&#39;a@a.com&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;aaa&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Enter a valid email address.&#39;</span><span class="p">]})</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="django.test.SimpleTestCase.assertFormError">
<code class="descclassname">SimpleTestCase.</code><code class="descname">assertFormError</code>(<em>response</em>, <em>form</em>, <em>field</em>, <em>errors</em>, <em>msg_prefix=''</em>)<a class="headerlink" href="#django.test.SimpleTestCase.assertFormError" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Confirme qu’un champ de formulaire génère la liste d’erreurs fournie lorsqu’il est affiché dans son formulaire.</p>
<p><code class="docutils literal notranslate"><span class="pre">form</span></code> est le nom de l’instance <code class="docutils literal notranslate"><span class="pre">Form</span></code> dans le contexte de gabarit.</p>
<p><code class="docutils literal notranslate"><span class="pre">field</span></code> est le nom du champ dans le formulaire à contrôler. Si <code class="docutils literal notranslate"><span class="pre">field</span></code> possède la valeur <code class="docutils literal notranslate"><span class="pre">None</span></code>, ce sont les erreurs non liées aux formulaires (accessibles via <a class="reference internal" href="../../ref/forms/api.html#django.forms.Form.non_field_errors" title="django.forms.Form.non_field_errors"><code class="xref py py-meth docutils literal notranslate"><span class="pre">form.non_field_errors()</span></code></a>) qui seront vérifiées.</p>
<p><code class="docutils literal notranslate"><span class="pre">errors</span></code> est un texte d’erreur ou une liste de textes d’erreur qui sont censés être produits en réponse à la validation du formulaire.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.SimpleTestCase.assertFormsetError">
<code class="descclassname">SimpleTestCase.</code><code class="descname">assertFormsetError</code>(<em>response</em>, <em>formset</em>, <em>form_index</em>, <em>field</em>, <em>errors</em>, <em>msg_prefix=''</em>)<a class="headerlink" href="#django.test.SimpleTestCase.assertFormsetError" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Confirme que <code class="docutils literal notranslate"><span class="pre">formset</span></code> génère la liste d’erreurs fournie lorsqu’il est affiché.</p>
<p><code class="docutils literal notranslate"><span class="pre">formset</span></code> est le nom de l’instance <code class="docutils literal notranslate"><span class="pre">Formset</span></code> dans le contexte de gabarit.</p>
<p><code class="docutils literal notranslate"><span class="pre">form_index</span></code> est le numéro du formulaire dans <code class="docutils literal notranslate"><span class="pre">Formset</span></code>. Si <code class="docutils literal notranslate"><span class="pre">form_index</span></code> possède la valeur <code class="docutils literal notranslate"><span class="pre">None</span></code>, ce sont les erreurs non liées aux formulaires (accessibles via <code class="docutils literal notranslate"><span class="pre">formset.non_form_errors()</span></code>) qui seront vérifiées.</p>
<p><code class="docutils literal notranslate"><span class="pre">field</span></code> est le nom du champ dans le formulaire à contrôler. Si <code class="docutils literal notranslate"><span class="pre">field</span></code> possède la valeur <code class="docutils literal notranslate"><span class="pre">None</span></code>, ce sont les erreurs non liées aux formulaires (accessibles via <a class="reference internal" href="../../ref/forms/api.html#django.forms.Form.non_field_errors" title="django.forms.Form.non_field_errors"><code class="xref py py-meth docutils literal notranslate"><span class="pre">form.non_field_errors()</span></code></a>) qui seront vérifiées.</p>
<p><code class="docutils literal notranslate"><span class="pre">errors</span></code> est un texte d’erreur ou une liste de textes d’erreur qui sont censés être produits en réponse à la validation du formulaire.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.SimpleTestCase.assertContains">
<code class="descclassname">SimpleTestCase.</code><code class="descname">assertContains</code>(<em>response</em>, <em>text</em>, <em>count=None</em>, <em>status_code=200</em>, <em>msg_prefix=''</em>, <em>html=False</em>)<a class="headerlink" href="#django.test.SimpleTestCase.assertContains" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Confirme qu’une instance de <code class="docutils literal notranslate"><span class="pre">Response</span></code> produit le code <code class="docutils literal notranslate"><span class="pre">status_code</span></code> indiqué et que le contenu <code class="docutils literal notranslate"><span class="pre">text</span></code> apparaît dans le contenu de la réponse. Si <code class="docutils literal notranslate"><span class="pre">count</span></code> est renseigné, <code class="docutils literal notranslate"><span class="pre">text</span></code> doit apparaître exactement <code class="docutils literal notranslate"><span class="pre">count</span></code> fois dans la réponse.</p>
<p>Définissez <code class="docutils literal notranslate"><span class="pre">html</span></code> à <code class="docutils literal notranslate"><span class="pre">True</span></code> pour que <code class="docutils literal notranslate"><span class="pre">text</span></code> soit géré comme du code HTML. La comparaison avec le contenu de la réponse prend alors en compte la sémantique HTML au lieu d’une comparaison caractère par caractère. Les espaces blancs sont majoritairement ignorés et l’ordre des attributs ne joue pas de rôle. Voir <a class="reference internal" href="#django.test.SimpleTestCase.assertHTMLEqual" title="django.test.SimpleTestCase.assertHTMLEqual"><code class="xref py py-meth docutils literal notranslate"><span class="pre">assertHTMLEqual()</span></code></a> pour plus de détails.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.SimpleTestCase.assertNotContains">
<code class="descclassname">SimpleTestCase.</code><code class="descname">assertNotContains</code>(<em>response</em>, <em>text</em>, <em>status_code=200</em>, <em>msg_prefix=''</em>, <em>html=False</em>)<a class="headerlink" href="#django.test.SimpleTestCase.assertNotContains" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Confirme qu’une instance de <code class="docutils literal notranslate"><span class="pre">Response</span></code> produit le code <code class="docutils literal notranslate"><span class="pre">status_code</span></code> indiqué et que le contenu <code class="docutils literal notranslate"><span class="pre">text</span></code> n’apparaît <em>pas</em> dans le contenu de la réponse.</p>
<p>Définissez <code class="docutils literal notranslate"><span class="pre">html</span></code> à <code class="docutils literal notranslate"><span class="pre">True</span></code> pour que <code class="docutils literal notranslate"><span class="pre">text</span></code> soit géré comme du code HTML. La comparaison avec le contenu de la réponse prend alors en compte la sémantique HTML au lieu d’une comparaison caractère par caractère. Les espaces blancs sont majoritairement ignorés et l’ordre des attributs ne joue pas de rôle. Voir <a class="reference internal" href="#django.test.SimpleTestCase.assertHTMLEqual" title="django.test.SimpleTestCase.assertHTMLEqual"><code class="xref py py-meth docutils literal notranslate"><span class="pre">assertHTMLEqual()</span></code></a> pour plus de détails.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.SimpleTestCase.assertTemplateUsed">
<code class="descclassname">SimpleTestCase.</code><code class="descname">assertTemplateUsed</code>(<em>response</em>, <em>template_name</em>, <em>msg_prefix=''</em>, <em>count=None</em>)<a class="headerlink" href="#django.test.SimpleTestCase.assertTemplateUsed" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Confirme que le gabarit du nom indiqué a été utilisé pour produire la réponse.</p>
<p>Le nom est une chaîne du genre <code class="docutils literal notranslate"><span class="pre">'admin/index.html'</span></code>.</p>
<p>Le paramètre <code class="docutils literal notranslate"><span class="pre">count</span></code> est un nombre entier indiquant le nombre de fois qu’un gabarit doit être produit. La valeur par défaut est <code class="docutils literal notranslate"><span class="pre">None</span></code>, ce qui signifie que le gabarit doit être produit une ou plusieurs fois.</p>
<p>Vous pouvez l’utiliser comme un gestionnaire de contexte, comme ceci&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertTemplateUsed</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">):</span>
    <span class="n">render_to_string</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertTemplateUsed</span><span class="p">(</span><span class="n">template_name</span><span class="o">=</span><span class="s1">&#39;index.html&#39;</span><span class="p">):</span>
    <span class="n">render_to_string</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="django.test.SimpleTestCase.assertTemplateNotUsed">
<code class="descclassname">SimpleTestCase.</code><code class="descname">assertTemplateNotUsed</code>(<em>response</em>, <em>template_name</em>, <em>msg_prefix=''</em>)<a class="headerlink" href="#django.test.SimpleTestCase.assertTemplateNotUsed" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Confirme que le gabarit du nom indiqué n’a <em>pas</em> été utilisé pour produire la réponse.</p>
<p>Vous pouvez l’utiliser comme un gestionnaire de contexte de la même façon qu’avec <a class="reference internal" href="#django.test.SimpleTestCase.assertTemplateUsed" title="django.test.SimpleTestCase.assertTemplateUsed"><code class="xref py py-meth docutils literal notranslate"><span class="pre">assertTemplateUsed()</span></code></a>.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.SimpleTestCase.assertURLEqual">
<code class="descclassname">SimpleTestCase.</code><code class="descname">assertURLEqual</code>(<em>url1</em>, <em>url2</em>, <em>msg_prefix=''</em>)<a class="headerlink" href="#django.test.SimpleTestCase.assertURLEqual" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Confirme que deux URL sont identiques, en ignorant l’ordre des paramètres de requête à l’exception des paramètres de même nom. Par exemple, <code class="docutils literal notranslate"><span class="pre">/chemin/?x=1&amp;y=2</span></code> est égal à <code class="docutils literal notranslate"><span class="pre">/chemin/?y=2&amp;x=1</span></code>, mais <code class="docutils literal notranslate"><span class="pre">/chemin/?a=1&amp;a=2</span></code> n’est pas égal à <code class="docutils literal notranslate"><span class="pre">/chemin/?a=2&amp;a=1</span></code>.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.SimpleTestCase.assertRedirects">
<code class="descclassname">SimpleTestCase.</code><code class="descname">assertRedirects</code>(<em>response</em>, <em>expected_url</em>, <em>status_code=302</em>, <em>target_status_code=200</em>, <em>msg_prefix=''</em>, <em>fetch_redirect_response=True</em>)<a class="headerlink" href="#django.test.SimpleTestCase.assertRedirects" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Confirme que la réponse renvoie un statut de redirection <code class="docutils literal notranslate"><span class="pre">status_code</span></code>, qu’elle redirige vers <code class="docutils literal notranslate"><span class="pre">expected_url</span></code> (y compris avec d’éventuelles données <code class="docutils literal notranslate"><span class="pre">GET</span></code>) et que la page finale a renvoyé le code <code class="docutils literal notranslate"><span class="pre">target_status_code</span></code>.</p>
<p>Si la requête a utilisé le paramètre <code class="docutils literal notranslate"><span class="pre">follow</span></code>, les valeurs de <code class="docutils literal notranslate"><span class="pre">expected_url</span></code> et de <code class="docutils literal notranslate"><span class="pre">target_status_code</span></code> doivent être celles de la page finale de la chaîne de redirection.</p>
<p>Si <code class="docutils literal notranslate"><span class="pre">fetch_redirect_response</span></code> vaut <code class="docutils literal notranslate"><span class="pre">False</span></code>, la page finale n’est pas chargée. Comme le client de test ne peut pas récupérer des URL externes, c’est particulièrement utile quand <code class="docutils literal notranslate"><span class="pre">expected_url</span></code> ne fait pas partie de votre application Django.</p>
<p>Le protocole est géré correctement lors de comparaisons entre deux URL. Si aucun protocole n’est indiqué à l’emplacement de redirection, le protocole de la requête d’origine est utilisé. S’il est présent, le protocole dans <code class="docutils literal notranslate"><span class="pre">expected_url</span></code> est celui qui sera utilisé pour effectuer des comparaisons.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.SimpleTestCase.assertHTMLEqual">
<code class="descclassname">SimpleTestCase.</code><code class="descname">assertHTMLEqual</code>(<em>html1</em>, <em>html2</em>, <em>msg=None</em>)<a class="headerlink" href="#django.test.SimpleTestCase.assertHTMLEqual" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Confirme que les chaînes <code class="docutils literal notranslate"><span class="pre">html1</span></code> et <code class="docutils literal notranslate"><span class="pre">html2</span></code> sont équivalentes. La comparaison prend en compte la sémantique HTML. La comparaison tient compte des éléments suivants&nbsp;:</p>
<ul class="simple">
<li>Les blancs avant et après les balises HTML sont ignorés.</li>
<li>Tous les types de blancs (espaces, tabulateurs, etc.) sont équivalents.</li>
<li>Toutes les balises ouvertes sont fermées implicitement, par exemple quand une balise de niveau supérieur est fermée ou quand le document HTML est fini.</li>
<li>Les balises vides sont équivalentes à leur version auto-fermante.</li>
<li>L’ordre des attributs d’un élément HTML n’est pas signifiant.</li>
<li>Les attributs sans paramètre sont équivalents aux attributs dont le nom et la valeur sont identiques (voir les exemples).</li>
<li>Le texte, les références de caractères et les références d’entité qui se réfèrent au même caractère sont équivalents.</li>
</ul>
<p>Les exemples suivants sont des tests valides et ne génèrent pas d’exception <code class="docutils literal notranslate"><span class="pre">AssertionError</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">assertHTMLEqual</span><span class="p">(</span>
    <span class="s1">&#39;&lt;p&gt;Hello &lt;b&gt;&amp;#x27;world&amp;#x27;!&lt;/p&gt;&#39;</span><span class="p">,</span>
    <span class="sd">&#39;&#39;&#39;&lt;p&gt;</span>
<span class="sd">        Hello   &lt;b&gt;&amp;#39;world&amp;#39;! &lt;/b&gt;</span>
<span class="sd">    &lt;/p&gt;&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">assertHTMLEqual</span><span class="p">(</span>
    <span class="s1">&#39;&lt;input type=&quot;checkbox&quot; checked=&quot;checked&quot; id=&quot;id_accept_terms&quot; /&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;input id=&quot;id_accept_terms&quot; type=&quot;checkbox&quot; checked&gt;&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">html1</span></code> et <code class="docutils literal notranslate"><span class="pre">html2</span></code> doivent contenir du code HTML valide. Une exception <code class="docutils literal notranslate"><span class="pre">AssertionError</span></code> est générée si l’une de ces deux valeurs ne peut pas être analysée comme du code HTML.</p>
<p>L’affichage en cas d’erreur peut être personnalisé avec le paramètre <code class="docutils literal notranslate"><span class="pre">msg</span></code>.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.SimpleTestCase.assertHTMLNotEqual">
<code class="descclassname">SimpleTestCase.</code><code class="descname">assertHTMLNotEqual</code>(<em>html1</em>, <em>html2</em>, <em>msg=None</em>)<a class="headerlink" href="#django.test.SimpleTestCase.assertHTMLNotEqual" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Confirme que les chaînes <code class="docutils literal notranslate"><span class="pre">html1</span></code> et <code class="docutils literal notranslate"><span class="pre">html2</span></code> ne sont <em>pas</em> équivalentes. La comparaison prend en compte la sémantique HTML. Voir <a class="reference internal" href="#django.test.SimpleTestCase.assertHTMLEqual" title="django.test.SimpleTestCase.assertHTMLEqual"><code class="xref py py-meth docutils literal notranslate"><span class="pre">assertHTMLEqual()</span></code></a> pour plus de détails.</p>
<p><code class="docutils literal notranslate"><span class="pre">html1</span></code> et <code class="docutils literal notranslate"><span class="pre">html2</span></code> doivent contenir du code HTML valide. Une exception <code class="docutils literal notranslate"><span class="pre">AssertionError</span></code> est générée si l’une de ces deux valeurs ne peut pas être analysée comme du code HTML.</p>
<p>L’affichage en cas d’erreur peut être personnalisé avec le paramètre <code class="docutils literal notranslate"><span class="pre">msg</span></code>.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.SimpleTestCase.assertXMLEqual">
<code class="descclassname">SimpleTestCase.</code><code class="descname">assertXMLEqual</code>(<em>xml1</em>, <em>xml2</em>, <em>msg=None</em>)<a class="headerlink" href="#django.test.SimpleTestCase.assertXMLEqual" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Asserts that the strings <code class="docutils literal notranslate"><span class="pre">xml1</span></code> and <code class="docutils literal notranslate"><span class="pre">xml2</span></code> are equal. The
comparison is based on XML semantics. Similarly to
<a class="reference internal" href="#django.test.SimpleTestCase.assertHTMLEqual" title="django.test.SimpleTestCase.assertHTMLEqual"><code class="xref py py-meth docutils literal notranslate"><span class="pre">assertHTMLEqual()</span></code></a>, the comparison is
made on parsed content, hence only semantic differences are considered, not
syntax differences. When invalid XML is passed in any parameter, an
<code class="docutils literal notranslate"><span class="pre">AssertionError</span></code> is always raised, even if both strings are identical.</p>
<p>La déclaration XML, le type de document, les instructions de traitement et les commentaires sont ignorés. Seul l’élément racine (root) et ses descendants sont comparés.</p>
<p>L’affichage en cas d’erreur peut être personnalisé avec le paramètre <code class="docutils literal notranslate"><span class="pre">msg</span></code>.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.SimpleTestCase.assertXMLNotEqual">
<code class="descclassname">SimpleTestCase.</code><code class="descname">assertXMLNotEqual</code>(<em>xml1</em>, <em>xml2</em>, <em>msg=None</em>)<a class="headerlink" href="#django.test.SimpleTestCase.assertXMLNotEqual" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Confirme que les chaînes <code class="docutils literal notranslate"><span class="pre">xml1</span></code> et <code class="docutils literal notranslate"><span class="pre">xml2</span></code> ne sont <em>pas</em> équivalentes. La comparaison prend en compte la sémantique xML. Voir <a class="reference internal" href="#django.test.SimpleTestCase.assertXMLEqual" title="django.test.SimpleTestCase.assertXMLEqual"><code class="xref py py-meth docutils literal notranslate"><span class="pre">assertXMLEqual()</span></code></a> pour plus de détails.</p>
<p>L’affichage en cas d’erreur peut être personnalisé avec le paramètre <code class="docutils literal notranslate"><span class="pre">msg</span></code>.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.SimpleTestCase.assertInHTML">
<code class="descclassname">SimpleTestCase.</code><code class="descname">assertInHTML</code>(<em>needle</em>, <em>haystack</em>, <em>count=None</em>, <em>msg_prefix=''</em>)<a class="headerlink" href="#django.test.SimpleTestCase.assertInHTML" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Confirme que le fragment HTML <code class="docutils literal notranslate"><span class="pre">needle</span></code> est contenu dans le contenu <code class="docutils literal notranslate"><span class="pre">haystack</span></code>.</p>
<p>Si le paramètre nombre entier <code class="docutils literal notranslate"><span class="pre">count</span></code> est indiqué, un contrôle supplémentaire est effectué que le nombre d’occurrences de <code class="docutils literal notranslate"><span class="pre">needle</span></code> correspond à <code class="docutils literal notranslate"><span class="pre">count</span></code>.</p>
<p>Dans la plupart des cas, les blancs sont ignorés et l’ordre des attributs n’est pas pris en compte. Les paramètres transmis doivent être du code HTML valide.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.SimpleTestCase.assertJSONEqual">
<code class="descclassname">SimpleTestCase.</code><code class="descname">assertJSONEqual</code>(<em>raw</em>, <em>expected_data</em>, <em>msg=None</em>)<a class="headerlink" href="#django.test.SimpleTestCase.assertJSONEqual" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Confirme que les fragments JSON <code class="docutils literal notranslate"><span class="pre">raw</span></code> et <code class="docutils literal notranslate"><span class="pre">expected_data</span></code> sont égaux. Les règles habituelles de JSON concernant les blancs non significatifs s’appliquent, car le gros du travail est confié à la bibliothèque <a class="reference external" href="https://docs.python.org/3/library/json.html#module-json" title="(disponible dans Python v3.9)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">json</span></code></a>.</p>
<p>L’affichage en cas d’erreur peut être personnalisé avec le paramètre <code class="docutils literal notranslate"><span class="pre">msg</span></code>.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.SimpleTestCase.assertJSONNotEqual">
<code class="descclassname">SimpleTestCase.</code><code class="descname">assertJSONNotEqual</code>(<em>raw</em>, <em>expected_data</em>, <em>msg=None</em>)<a class="headerlink" href="#django.test.SimpleTestCase.assertJSONNotEqual" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Confirme que les fragments JSON <code class="docutils literal notranslate"><span class="pre">raw</span></code> et <code class="docutils literal notranslate"><span class="pre">expected_data</span></code> <em>ne sont pas</em> égaux. Voir <a class="reference internal" href="#django.test.SimpleTestCase.assertJSONEqual" title="django.test.SimpleTestCase.assertJSONEqual"><code class="xref py py-meth docutils literal notranslate"><span class="pre">assertJSONEqual()</span></code></a> pour plus de détails.</p>
<p>L’affichage en cas d’erreur peut être personnalisé avec le paramètre <code class="docutils literal notranslate"><span class="pre">msg</span></code>.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.TransactionTestCase.assertQuerysetEqual">
<code class="descclassname">TransactionTestCase.</code><code class="descname">assertQuerysetEqual</code>(<em>qs</em>, <em>values</em>, <em>transform=repr</em>, <em>ordered=True</em>, <em>msg=None</em>)<a class="headerlink" href="#django.test.TransactionTestCase.assertQuerysetEqual" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Confirme que le jeu de requête <code class="docutils literal notranslate"><span class="pre">qs</span></code> renvoie une liste particulière de valeurs <code class="docutils literal notranslate"><span class="pre">values</span></code>.</p>
<p>La comparaison des contenus de <code class="docutils literal notranslate"><span class="pre">qs</span></code> et de <code class="docutils literal notranslate"><span class="pre">values</span></code> se fait en appliquant la fonction <code class="docutils literal notranslate"><span class="pre">transform</span></code> sur <code class="docutils literal notranslate"><span class="pre">qs</span></code>. Cela signifie que par défaut, c’est la représentation <code class="docutils literal notranslate"><span class="pre">repr()</span></code> de chaque valeur qui est comparée à <code class="docutils literal notranslate"><span class="pre">values</span></code>. Tout autre exécutable peut être utilisé si <code class="docutils literal notranslate"><span class="pre">repr()</span></code> ne constitue pas un point de comparaison valable.</p>
<p>Par défaut, la comparaison dépend aussi de l’ordre de tri. Si <code class="docutils literal notranslate"><span class="pre">qs</span></code> ne comporte pas d’ordre de tri implicite, vous pouvez définir le paramètre <code class="docutils literal notranslate"><span class="pre">ordered</span></code> à <code class="docutils literal notranslate"><span class="pre">False</span></code>, ce qui provoquera une comparaison sur des objets <code class="docutils literal notranslate"><span class="pre">collections.Counter</span></code>. Si l’ordre est indéfini (si le paramètre <code class="docutils literal notranslate"><span class="pre">qs</span></code> n’est pas trié et que la comparaison se fait avec plus d’une valeur triée) une exception <code class="docutils literal notranslate"><span class="pre">ValueError</span></code> est générée.</p>
<p>L’affichage en cas d’erreur peut être personnalisé avec le paramètre <code class="docutils literal notranslate"><span class="pre">msg</span></code>.</p>
</dd></dl>

<dl class="method">
<dt id="django.test.TransactionTestCase.assertNumQueries">
<code class="descclassname">TransactionTestCase.</code><code class="descname">assertNumQueries</code>(<em>num</em>, <em>func</em>, <em>*args</em>, <em>**kwargs</em>)<a class="headerlink" href="#django.test.TransactionTestCase.assertNumQueries" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Confirme que lorsque <code class="docutils literal notranslate"><span class="pre">func</span></code> est appelée avec <code class="docutils literal notranslate"><span class="pre">*args</span></code> et <code class="docutils literal notranslate"><span class="pre">**kwargs</span></code>, <code class="docutils literal notranslate"><span class="pre">num</span></code> requêtes de base de données sont effectuées.</p>
<p>Si une clé <code class="docutils literal notranslate"><span class="pre">&quot;using&quot;</span></code> est présente dans <code class="docutils literal notranslate"><span class="pre">kwargs</span></code>, cette valeur est utilisée comme alias de base de données pour laquelle le nombre de requêtes sera contrôlé</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="s1">&#39;non_default_db&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Si vous souhaitez appeler une fonction avec un paramètre <code class="docutils literal notranslate"><span class="pre">using</span></code>, vous pouvez le faire en enveloppant l’appel dans une fonction <code class="docutils literal notranslate"><span class="pre">lambda</span></code> pour y ajouter un paramètre supplémentaire</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">my_function</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="mi">7</span><span class="p">))</span>
</pre></div>
</div>
<p>Vous pouvez également l’utiliser comme un gestionnaire de contexte&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Aaron&quot;</span><span class="p">)</span>
    <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Daniel&quot;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="s-tagging-tests">
<span id="s-topics-tagging-tests"></span><span id="tagging-tests"></span><span id="topics-tagging-tests"></span><h3>Étiquetage des tests<a class="headerlink" href="#tagging-tests" title="Lien permanent vers ce titre">¶</a></h3>
<p>Il est possible d’étiqueter les tests afin de pouvoir plus facilement lancer un sous-ensemble particulier. Par exemple, vous pourriez étiqueter les tests rapides ou lents&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.test</span> <span class="k">import</span> <span class="n">tag</span>

<span class="k">class</span> <span class="nc">SampleTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="nd">@tag</span><span class="p">(</span><span class="s1">&#39;fast&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_fast</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="nd">@tag</span><span class="p">(</span><span class="s1">&#39;slow&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_slow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="nd">@tag</span><span class="p">(</span><span class="s1">&#39;slow&#39;</span><span class="p">,</span> <span class="s1">&#39;core&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_slow_but_core</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>Il est aussi possible d’étiqueter un cas de test&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@tag</span><span class="p">(</span><span class="s1">&#39;slow&#39;</span><span class="p">,</span> <span class="s1">&#39;core&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SampleTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Les sous-classes héritent des classes parentes, et les méthodes héritent des étiquettes de leur classe. Par exemple</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@tag</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SampleTestCaseChild</span><span class="p">(</span><span class="n">SampleTestCase</span><span class="p">):</span>

    <span class="nd">@tag</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">SampleTestCaseChild.test</span></code> possédera les étiquettes <code class="docutils literal notranslate"><span class="pre">'slow'</span></code>, <code class="docutils literal notranslate"><span class="pre">'core'</span></code>, <code class="docutils literal notranslate"><span class="pre">'bar'</span></code> et <code class="docutils literal notranslate"><span class="pre">'foo'</span></code>.</p>
<p>Puis, vous pouvez choisir quels tests lancer. Par exemple, pour ne lancer que les tests rapides&nbsp;:</p>
<div class="console-block" id="console-block-2">
<input class="c-tab-unix" id="c-tab-2-unix" type="radio" name="console-2" checked>
<label for="c-tab-2-unix" title="Linux/macOS">&#xf17c/&#xf179</label>
<input class="c-tab-win" id="c-tab-2-win" type="radio" name="console-2">
<label for="c-tab-2-win" title="Windows">&#xf17a</label>
<section class="c-content-unix" id="c-content-2-unix">
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ./manage.py <span class="nb">test</span> --tag<span class="o">=</span>fast
</pre></div>
</div>
</section>
<section class="c-content-win" id="c-content-2-win">
<div class="highlight"><pre><span></span><span class="gp">...\&gt;</span> manage.py test --tag=fast
</pre></div>
</section>
</div>
<p>Ou pour lancer les tests rapides et les tests principaux (même s’ils sont lents)&nbsp;:</p>
<div class="console-block" id="console-block-3">
<input class="c-tab-unix" id="c-tab-3-unix" type="radio" name="console-3" checked>
<label for="c-tab-3-unix" title="Linux/macOS">&#xf17c/&#xf179</label>
<input class="c-tab-win" id="c-tab-3-win" type="radio" name="console-3">
<label for="c-tab-3-win" title="Windows">&#xf17a</label>
<section class="c-content-unix" id="c-content-3-unix">
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ./manage.py <span class="nb">test</span> --tag<span class="o">=</span>fast --tag<span class="o">=</span>core
</pre></div>
</div>
</section>
<section class="c-content-win" id="c-content-3-win">
<div class="highlight"><pre><span></span><span class="gp">...\&gt;</span> manage.py test --tag=fast --tag=core
</pre></div>
</section>
</div>
<p>Il est aussi possible d’exclure des tests par leur étiquette. Pour lancer les tests principaux qui ne sont pas lents&nbsp;:</p>
<div class="console-block" id="console-block-4">
<input class="c-tab-unix" id="c-tab-4-unix" type="radio" name="console-4" checked>
<label for="c-tab-4-unix" title="Linux/macOS">&#xf17c/&#xf179</label>
<input class="c-tab-win" id="c-tab-4-win" type="radio" name="console-4">
<label for="c-tab-4-win" title="Windows">&#xf17a</label>
<section class="c-content-unix" id="c-content-4-unix">
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ./manage.py <span class="nb">test</span> --tag<span class="o">=</span>core --exclude-tag<span class="o">=</span>slow
</pre></div>
</div>
</section>
<section class="c-content-win" id="c-content-4-win">
<div class="highlight"><pre><span></span><span class="gp">...\&gt;</span> manage.py test --tag=core --exclude-tag=slow
</pre></div>
</section>
</div>
<p><a class="reference internal" href="../../ref/django-admin.html#cmdoption-test-exclude-tag"><code class="xref std std-option docutils literal notranslate"><span class="pre">test</span> <span class="pre">--exclude-tag</span></code></a> a la priorité sur <a class="reference internal" href="../../ref/django-admin.html#cmdoption-test-tag"><code class="xref std std-option docutils literal notranslate"><span class="pre">test</span> <span class="pre">--tag</span></code></a>, si donc un test possède deux étiquettes et que vous choisissez l’une d’elle tout en excluant l’autre, le test ne sera pas lancé.</p>
</div>
</div>
<div class="section" id="s-testing-asynchronous-code">
<span id="s-async-tests"></span><span id="testing-asynchronous-code"></span><span id="async-tests"></span><h2>Test de code asynchrone<a class="headerlink" href="#testing-asynchronous-code" title="Lien permanent vers ce titre">¶</a></h2>
<div class="versionadded">
<span class="title">New in Django 3.1.</span> </div>
<p>Si vous souhaitez simplement tester le résultat de vues asynchrones, le client de test standard les lance dans une boucle asynchrone dédiée sans travail supplémentaire de votre part.</p>
<p>Cependant, si vous souhaitez écrire des tests pleinement asynchrones pour un projet Django, vous devrez prendre en compte plusieurs choses.</p>
<p>Tout d’abord, vos tests doivent être des méthodes <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">def</span></code> de la classe de test (afin de leur fournir un contexte asynchrone). Django détectera automatiquement tout test de type <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">def</span></code> et les enveloppera afin qu’ils s’exécutent dans leur propre boucle événementielle.</p>
<p>Si vous testez depuis une fonction asynchrone, vous devez éaglement utiliser le client de test asynchrone. Il est disponible comme <code class="docutils literal notranslate"><span class="pre">django.test.AsyncClient</span></code> ou comme <code class="docutils literal notranslate"><span class="pre">self.async_client</span></code> dans chaque test.</p>
<p>À l’exception du paramètre <code class="docutils literal notranslate"><span class="pre">follow</span></code> qui n’est pas pris en charge, <code class="docutils literal notranslate"><span class="pre">AsyncClient</span></code> possède les mêmes méthodes et signatures que le client de test synchrone (normal), mais toute méthode qui effectue une requête doit être appelée par <code class="docutils literal notranslate"><span class="pre">await</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">test_my_thing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/some-url/&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
<p>Le client asynchrone peut aussi appeler des vues synchrones ; il s’exécute au travers du <a class="reference internal" href="../async.html"><span class="doc">chemin de requête asynchrone</span></a> de Django, qui prend en charge les deux modes. Toute vue appelée par <code class="docutils literal notranslate"><span class="pre">AsyncClient</span></code> reçoit un objet <code class="docutils literal notranslate"><span class="pre">ASGIRequest</span></code> dans son attribut <code class="docutils literal notranslate"><span class="pre">request</span></code> au lieu de l’objet <code class="docutils literal notranslate"><span class="pre">WSGIRequest</span></code> créé par le client normal.</p>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p>Si vous utilisez des décorateurs de tests, ils doivent être compatibles avec l’asynchrone pour fonctionner correctement. Les décorateurs intégrés de Django se comporteront correctement, mais ceux de tierces parties peuvent sembler ne pas s’exécuter (ils « enveloppent » la mauvaise partie du flux d’exécution au lieu de votre test).</p>
<p>Si vous avez besoin d’utiliser ces décorateurs, vous devez alors plutôt décorer vos méthodes de test avec <a class="reference internal" href="../async.html#asgiref.sync.async_to_sync" title="asgiref.sync.async_to_sync"><code class="xref py py-func docutils literal notranslate"><span class="pre">async_to_sync()</span></code></a> <em>à l’intérieur</em> de celles-ci :</p>
<div class="last highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">asgiref.sync</span> <span class="k">import</span> <span class="n">async_to_sync</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="k">import</span> <span class="n">TestCase</span>

<span class="k">class</span> <span class="nc">MyTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="nd">@mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="nd">@async_to_sync</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">test_my_thing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="s-email-services">
<span id="s-topics-testing-email"></span><span id="email-services"></span><span id="topics-testing-email"></span><h2>Services de messagerie<a class="headerlink" href="#email-services" title="Lien permanent vers ce titre">¶</a></h2>
<p>Si l’une de vos vues Django envoie des courriels via la <a class="reference internal" href="../email.html"><span class="doc">fonctionnalité d’envoi de courriels de Django</span></a>, vous ne souhaiterez probablement pas réellement envoyer un courriel lors de chaque test de cette vue. C’est pour cette raison que le lanceur de tests de Django redirige automatiquement tous les courriels qu’il envoie dans une boîte artificielle. Cela vous permet aussi de tester chaque aspect de l’envoi de courriels, du nombre de messages envoyés jusqu’au contenu de chaque message, sans jamais envoyer réellement les messages.</p>
<p>Le lanceur de tests fait cela en remplaçant de manière transparente le moteur de messagerie normal par un moteur de test (n’ayez crainte, cela n’a aucun effet sur l’expédition de courriels en dehors de Django, comme un éventuel serveur de messagerie tournant sur votre machine).</p>
<dl class="data">
<dt id="django.core.mail.django.core.mail.outbox">
<code class="descclassname">django.core.mail.</code><code class="descname">outbox</code><a class="headerlink" href="#django.core.mail.django.core.mail.outbox" title="Lien permanent vers cette définition">¶</a></dt>
<dd></dd></dl>

<p>Durant le fonctionnement des tests, chaque courriel sortant est enregistré dans <code class="docutils literal notranslate"><span class="pre">django.core.mail.outbox</span></code>. Il s’agit d’une liste de toutes les instances de <a class="reference internal" href="../email.html#django.core.mail.EmailMessage" title="django.core.mail.EmailMessage"><code class="xref py py-class docutils literal notranslate"><span class="pre">EmailMessage</span></code></a> qui ont été envoyées. L’attribut <code class="docutils literal notranslate"><span class="pre">outbox</span></code> est un attribut spécial qui est <em>uniquement</em> créé lorsque le moteur de messagerie <code class="docutils literal notranslate"><span class="pre">locmem</span></code> est actif. Il ne fait normalement pas partie du module <a class="reference internal" href="../email.html#module-django.core.mail" title="django.core.mail: Helpers to easily send email."><code class="xref py py-mod docutils literal notranslate"><span class="pre">django.core.mail</span></code></a> et il ne peut être importé directement. Le code ci-dessous montre comment accéder correctement à cet attribut.</p>
<p>Voici un exemple de test qui examine la longueur et le contenu de <code class="docutils literal notranslate"><span class="pre">django.core.mail.outbox</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.core</span> <span class="k">import</span> <span class="n">mail</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="k">import</span> <span class="n">TestCase</span>

<span class="k">class</span> <span class="nc">EmailTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_send_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Send message.</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">send_mail</span><span class="p">(</span>
            <span class="s1">&#39;Subject here&#39;</span><span class="p">,</span> <span class="s1">&#39;Here is the message.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;to@example.com&#39;</span><span class="p">],</span>
            <span class="n">fail_silently</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Test that one message has been sent.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">outbox</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Verify that the subject of the first message is correct.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span> <span class="s1">&#39;Subject here&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Comme noté <a class="reference internal" href="#emptying-test-outbox"><span class="std std-ref">précédemment</span></a>, la boîte de messagerie de test est vidée au début de chaque test des classes Django <code class="docutils literal notranslate"><span class="pre">*TestCase</span></code>. Pour vider la boîte manuellement, attribuez une liste vide à <code class="docutils literal notranslate"><span class="pre">mail.outbox</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.core</span> <span class="k">import</span> <span class="n">mail</span>

<span class="c1"># Empty the test outbox</span>
<span class="n">mail</span><span class="o">.</span><span class="n">outbox</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
</div>
<div class="section" id="s-management-commands">
<span id="s-topics-testing-management-commands"></span><span id="management-commands"></span><span id="topics-testing-management-commands"></span><h2>Commandes d’administration<a class="headerlink" href="#management-commands" title="Lien permanent vers ce titre">¶</a></h2>
<p>Les commandes d’administration peuvent être testées avec la fonction <a class="reference internal" href="../../ref/django-admin.html#django.core.management.call_command" title="django.core.management.call_command"><code class="xref py py-func docutils literal notranslate"><span class="pre">call_command()</span></code></a>. La sortie peut être redirigée vers une instance de <code class="docutils literal notranslate"><span class="pre">StringIO</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">django.core.management</span> <span class="k">import</span> <span class="n">call_command</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="k">import</span> <span class="n">TestCase</span>

<span class="k">class</span> <span class="nc">ClosepollTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_command_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">call_command</span><span class="p">(</span><span class="s1">&#39;closepoll&#39;</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;Expected output&#39;</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="section" id="s-skipping-tests">
<span id="s-id3"></span><span id="skipping-tests"></span><span id="id3"></span><h2>Exclusion de tests<a class="headerlink" href="#skipping-tests" title="Lien permanent vers ce titre">¶</a></h2>
<p>La bibliothèque unittest fournit les décorateurs <a class="reference external" href="https://docs.python.org/3/library/unittest.html#unittest.skipIf" title="(disponible dans Python v3.9)"><code class="xref py py-func docutils literal notranslate"><span class="pre">&#64;skipIf</span></code></a> rz <a class="reference external" href="https://docs.python.org/3/library/unittest.html#unittest.skipUnless" title="(disponible dans Python v3.9)"><code class="xref py py-func docutils literal notranslate"><span class="pre">&#64;skipUnless</span></code></a> pour permettre d’exclure des tests si vous savez à l’avance que ces tests vont échouer dans certaines conditions.</p>
<p>Par exemple, si la réussite d’un test exige la présence d’une certaine bibliothèque, il est possible de décorer le cas de test avec  <a class="reference external" href="https://docs.python.org/3/library/unittest.html#unittest.skipIf" title="(disponible dans Python v3.9)"><code class="xref py py-func docutils literal notranslate"><span class="pre">&#64;skipIf</span></code></a>. Puis, le lanceur de tests signalera que le test n’a pas été exécuté ainsi que la raison, au lieu de laisser le test échouer ou d’ignorer totalement le test.</p>
<p>En plus de ces comportements d’exclusion de test, Django ajoute deux décorateurs de test supplémentaires. Au lieu de se baser sur une valeur booléenne générique, ces décorateurs contrôlent les capacités d’une base de données et excluent le test concerné si la base de données ne gère pas la capacité nommément indiquée.</p>
<p>Ces décorateurs utilisent un identifiant textuel pour désigner les capacités de base de données. Cet identifiant correspond à un attribut de la classe des capacités de connexion de base de données. Voir la classe <code class="docutils literal notranslate"><span class="pre">django.db.backends.BaseDatabaseFeatures</span></code> pour obtenir une liste complète des capacités de base de données pouvant être utilisées comme critères d’exclusion de tests.</p>
<dl class="function">
<dt id="django.test.skipIfDBFeature">
<code class="descname">skipIfDBFeature</code>(<em>*feature_name_strings</em>)<a class="headerlink" href="#django.test.skipIfDBFeature" title="Lien permanent vers cette définition">¶</a></dt>
<dd></dd></dl>

<p>Exclut le test ou la classe <code class="docutils literal notranslate"><span class="pre">TestCase</span></code> décorés si toutes les capacités de base de données indiquées sont prises en charge.</p>
<p>Par exemple, le test suivant ne sera pas exécuté si la base de données gère les transactions (par ex. il ne serait <em>pas</em> exécuté avec PostgreSQL, mais il le serait avec MySQL utilisant des tables MyISAM)&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="nd">@skipIfDBFeature</span><span class="p">(</span><span class="s1">&#39;supports_transactions&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_transaction_behavior</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># ... conditional test code</span>
        <span class="k">pass</span>
</pre></div>
</div>
<dl class="function">
<dt id="django.test.skipUnlessDBFeature">
<code class="descname">skipUnlessDBFeature</code>(<em>*feature_name_strings</em>)<a class="headerlink" href="#django.test.skipUnlessDBFeature" title="Lien permanent vers cette définition">¶</a></dt>
<dd></dd></dl>

<p>Exclut le test ou la classe <code class="docutils literal notranslate"><span class="pre">TestCase</span></code> décorés si au moins une des capacités de base de données indiquées <em>n’est pas</em> prise en charge.</p>
<p>Par exemple, le test suivant ne sera exécuté que si la base de données gère les transactions (par ex. il serait exécuté avec PostgreSQL, mais il ne le serait <em>pas</em> avec MySQL utilisant des tables MyISAM)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="nd">@skipUnlessDBFeature</span><span class="p">(</span><span class="s1">&#39;supports_transactions&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_transaction_behavior</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># ... conditional test code</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      
        
          <div class="yui-b" id="sidebar">
            
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../contents.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Outils de test</a><ul>
<li><a class="reference internal" href="#the-test-client">Le client de test</a><ul>
<li><a class="reference internal" href="#overview-and-a-quick-example">Aperçu et exemple rapide</a></li>
<li><a class="reference internal" href="#making-requests">Lancement de requêtes</a></li>
<li><a class="reference internal" href="#testing-responses">Test des réponses</a></li>
<li><a class="reference internal" href="#exceptions">Exceptions</a></li>
<li><a class="reference internal" href="#persistent-state">État persistant</a></li>
<li><a class="reference internal" href="#setting-the-language">Définition de la langue</a></li>
<li><a class="reference internal" href="#example">Exemple</a></li>
</ul>
</li>
<li><a class="reference internal" href="#provided-test-case-classes">Classes de cas de test disponibles</a><ul>
<li><a class="reference internal" href="#simpletestcase"><code class="docutils literal notranslate"><span class="pre">SimpleTestCase</span></code></a></li>
<li><a class="reference internal" href="#transactiontestcase"><code class="docutils literal notranslate"><span class="pre">TransactionTestCase</span></code></a></li>
<li><a class="reference internal" href="#testcase"><code class="docutils literal notranslate"><span class="pre">TestCase</span></code></a></li>
<li><a class="reference internal" href="#liveservertestcase"><code class="docutils literal notranslate"><span class="pre">LiveServerTestCase</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#test-cases-features">Fonctionnalités des cas de test</a><ul>
<li><a class="reference internal" href="#default-test-client">Client de test par défaut</a></li>
<li><a class="reference internal" href="#customizing-the-test-client">Personnalisation du client de test</a></li>
<li><a class="reference internal" href="#fixture-loading">Chargement des instantanés</a></li>
<li><a class="reference internal" href="#urlconf-configuration">Configuration des URL</a></li>
<li><a class="reference internal" href="#multi-database-support">Prise en charge de plusieurs bases de données</a></li>
<li><a class="reference internal" href="#overriding-settings">Surcharge des réglages</a></li>
<li><a class="reference internal" href="#emptying-the-test-outbox">Vidage de la boîte de messagerie de test</a></li>
<li><a class="reference internal" href="#assertions">Assertions</a></li>
<li><a class="reference internal" href="#tagging-tests">Étiquetage des tests</a></li>
</ul>
</li>
<li><a class="reference internal" href="#testing-asynchronous-code">Test de code asynchrone</a></li>
<li><a class="reference internal" href="#email-services">Services de messagerie</a></li>
<li><a class="reference internal" href="#management-commands">Commandes d’administration</a></li>
<li><a class="reference internal" href="#skipping-tests">Exclusion de tests</a></li>
</ul>
</li>
</ul>

  <h4>Sujet précédent</h4>
  <p class="topless"><a href="overview.html"
                        title="Chapitre précédent">Écriture et lancement de tests</a></p>
  <h4>Sujet suivant</h4>
  <p class="topless"><a href="advanced.html"
                        title="Chapitre suivant">Thématiques de tests avancées</a></p>
  <div role="note" aria-label="source link">
    <h3>Cette page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/topics/testing/tools.txt"
            rel="nofollow">Montrer le code source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Recherche rapide</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
              <h3>Last update:</h3>
              <p class="topless">oct. 29, 2020</p>
          </div>
        
      
    </div>

    <div id="ft">
      <div class="nav">
    &laquo; <a href="overview.html" title="Écriture et lancement de tests">previous</a>
     |
    <a href="../index.html" title="Utilisation de Django" accesskey="U">up</a>
   |
    <a href="advanced.html" title="Thématiques de tests avancées">next</a> &raquo;</div>
    </div>
  </div>

      <div class="clearer"></div>
    </div>
  </body>
</html>