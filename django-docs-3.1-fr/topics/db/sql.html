
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="fr">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Lancement de requêtes SQL brutes &#8212; Documentation Django 3.1.3.dev</title>
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Recherche" href="../../search.html" />
    <link rel="next" title="Transactions de base de données" href="transactions.html" />
    <link rel="prev" title="Gestionnaires" href="managers.html" />



 
<script src="../../templatebuiltins.js"></script>
<script>
(function($) {
    if (!django_template_builtins) {
       // templatebuiltins.js missing, do nothing.
       return;
    }
    $(document).ready(function() {
        // Hyperlink Django template tags and filters
        var base = "../../ref/templates/builtins.html";
        if (base == "#") {
            // Special case for builtins.html itself
            base = "";
        }
        // Tags are keywords, class '.k'
        $("div.highlight\\-html\\+django span.k").each(function(i, elem) {
             var tagname = $(elem).text();
             if ($.inArray(tagname, django_template_builtins.ttags) != -1) {
                 var fragment = tagname.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + tagname + "</a>");
             }
        });
        // Filters are functions, class '.nf'
        $("div.highlight\\-html\\+django span.nf").each(function(i, elem) {
             var filtername = $(elem).text();
             if ($.inArray(filtername, django_template_builtins.tfilters) != -1) {
                 var fragment = filtername.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + filtername + "</a>");
             }
        });
    });
})(jQuery);</script>

  </head><body>

    <div class="document">
  <div id="custom-doc" class="yui-t6">
    <div id="hd">
      <h1><a href="../../index.html">Documentation Django 3.1.3.dev</a></h1>
      <div id="global-nav">
        <a title="Home page" href="../../index.html">Home</a>  |
        <a title="Table of contents" href="../../contents.html">Table of contents</a>  |
        <a title="Global index" href="../../genindex.html">Index</a>  |
        <a title="Module index" href="../../py-modindex.html">Modules</a>
      </div>
      <div class="nav">
    &laquo; <a href="managers.html" title="Gestionnaires">previous</a>
     |
    <a href="../index.html" title="Utilisation de Django" accesskey="U">up</a>
   |
    <a href="transactions.html" title="Transactions de base de données">next</a> &raquo;</div>
    </div>

    <div id="bd">
      <div id="yui-main">
        <div class="yui-b">
          <div class="yui-g" id="topics-db-sql">
            
  <div class="section" id="s-performing-raw-sql-queries">
<span id="performing-raw-sql-queries"></span><h1>Lancement de requêtes SQL brutes<a class="headerlink" href="#performing-raw-sql-queries" title="Lien permanent vers ce titre">¶</a></h1>
<p>Django propose deux manières d’exécuter des requêtes SQL brutes&nbsp;: vous pouvez utiliser <a class="reference internal" href="#django.db.models.Manager.raw" title="django.db.models.Manager.raw"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Manager.raw()</span></code></a> pour <a class="reference internal" href="#performing-raw-queries">exécuter des requêtes brutes et renvoyer des instances de modèles</a> ou vous pouvez outrepasser complètement la couche des modèles et <a class="reference internal" href="#executing-custom-sql-directly">exécuter directement du code SQL personnalisé</a>.</p>
<div class="admonition-explore-the-orm-before-using-raw-sql admonition">
<p class="first admonition-title">Explorez les possibilités de l’ORM avant d’avoir recours à du code SQL brut !</p>
<p>L’ORM de Django fournit de nombreux outils pour formuler des requêtes sans recourir à du code SQL brut. Par exemple :</p>
<ul class="simple">
<li>L’API <a class="reference internal" href="../../ref/models/querysets.html"><span class="doc">QuerySet</span></a> est bien documentée.</li>
<li>Il est possible d”<a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.annotate" title="django.db.models.query.QuerySet.annotate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">annoter</span></code></a> et d”<a class="reference internal" href="aggregation.html"><span class="doc">agréger</span></a> en utilisant de nombreuses <a class="reference internal" href="../../ref/models/database-functions.html"><span class="doc">fonctions de base de données</span></a> intégrées. Au-delà de ça, il est possible de créer des <a class="reference internal" href="../../ref/models/expressions.html"><span class="doc">expressions de requête personnalisées</span></a>.</li>
</ul>
<p class="last">Avant de recourir à du code SQL brut, explorez <a class="reference internal" href="index.html"><span class="doc">l’ORM</span></a>. Posez vos questions sur les canaux IRC <a class="reference internal" href="../../internals/mailing-lists.html#django-users-mailing-list"><span class="std std-ref">django-users</span></a> ou <a class="reference external" href="https://webchat.freenode.net/#django">#django</a> pour savoir si l’ORM peut satisfaire votre cas de figure.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Vous devez être très prudent lors de l’écriture d’instructions SQL brutes. Lors de chaque utilisation, vous devez échapper correctement tout paramètre pouvant être contrôlé par les utilisateurs en employant <code class="docutils literal notranslate"><span class="pre">params</span></code> afin de vous protéger contre les attaques par injection SQL. Lisez attentivement les paragraphes sur la <a class="reference internal" href="../security.html#sql-injection-protection"><span class="std std-ref">protection contre les injections SQL</span></a>.</p>
</div>
<div class="section" id="s-performing-raw-queries">
<span id="s-executing-raw-queries"></span><span id="performing-raw-queries"></span><span id="executing-raw-queries"></span><h2>Lancement de requêtes brutes<a class="headerlink" href="#performing-raw-queries" title="Lien permanent vers ce titre">¶</a></h2>
<p>La méthode de gestionnaire <code class="docutils literal notranslate"><span class="pre">raw()</span></code> peut être utilisée pour exécuter des requêtes SQL brutes qui renvoient des instances de modèles&nbsp;:</p>
<dl class="method">
<dt id="django.db.models.Manager.raw">
<code class="descclassname">Manager.</code><code class="descname">raw</code>(<em>raw_query</em>, <em>params=None</em>, <em>translations=None</em>)<a class="headerlink" href="#django.db.models.Manager.raw" title="Lien permanent vers cette définition">¶</a></dt>
<dd></dd></dl>

<p>Cette méthode accepte une requête SQL brute, l’exécute et renvoie une instance <code class="docutils literal notranslate"><span class="pre">django.db.models.query.RawQuerySet</span></code>. Il est possible alors d’effectuer une boucle sur cette instance <code class="docutils literal notranslate"><span class="pre">RawQuerySet</span></code> comme pour un objet <a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet" title="django.db.models.query.QuerySet"><code class="xref py py-class docutils literal notranslate"><span class="pre">QuerySet</span></code></a> normal afin d’accéder aux instances d’objets.</p>
<p>Un exemple vaut mieux que mille mots. Supposons que vous ayez créé le modèle suivant&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="n">birth_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>Vous pouvez alors exécuter du code SQL personnalisé comme ceci&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM myapp_person&#39;</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="go">John Smith</span>
<span class="go">Jane Jones</span>
</pre></div>
</div>
<p>Cet exemple n’est pas des plus passionnants, car il correspond exactement à l’expression <code class="docutils literal notranslate"><span class="pre">Person.objects.all()</span></code>. Toutefois, <code class="docutils literal notranslate"><span class="pre">raw()</span></code> comporte quelques autres options qui en font un outil très puissant.</p>
<div class="admonition-model-table-names admonition">
<p class="first admonition-title">Noms de table des modèles</p>
<p>D’où vient le nom de la table `` Person`` dans cet exemple?</p>
<p>Par défaut, Django compose un nom de table de base de données en combinant l”«&nbsp;étiquette d’application&nbsp;» du modèle (le nom utilisé dans <code class="docutils literal notranslate"><span class="pre">manage.py</span> <span class="pre">startapp</span></code>) avec le nom de classe du modèle, séparés par un soulignement. Dans l’exemple, nous sommes partis du principe que le modèle <code class="docutils literal notranslate"><span class="pre">Person</span></code> se trouvait dans une application nommée <code class="docutils literal notranslate"><span class="pre">myapp</span></code>, et donc que le nom de la table était <code class="docutils literal notranslate"><span class="pre">myapp_person</span></code>.</p>
<p class="last">Pour plus de détails, consultez la documentation de l’option <a class="reference internal" href="../../ref/models/options.html#django.db.models.Options.db_table" title="django.db.models.Options.db_table"><code class="xref py py-attr docutils literal notranslate"><span class="pre">db_table</span></code></a> qui vous permet également de définir manuellement le nom de table de la base de données.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Aucune vérification n’est effectuée pour les instructions SQL transmises à <code class="docutils literal notranslate"><span class="pre">.raw()</span></code>. Django s’attend à ce que la requête renvoie un ensemble de lignes de la base de données, mais ne fait rien pour le vérifier a priori. Si la requête ne retourne pas de ligne, une erreur (potentiellement cryptique) sera générée.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Si vous effectuez des requêtes vers MySQL, notez que le forçage de type silencieux de MySQL peut produire des résultats inattendus lors du mélange de types. Si une requête porte sur une colonne de type chaîne mais contient une valeur nombre entier, MySQL transforme le type de toutes les valeurs de la table en nombre entier avant d’effectuer la comparaison. Par exemple, si la table contient les valeurs <code class="docutils literal notranslate"><span class="pre">'abc'</span></code>, <code class="docutils literal notranslate"><span class="pre">'def'</span></code> et que la requête contient <code class="docutils literal notranslate"><span class="pre">WHERE</span> <span class="pre">macolonne=0</span></code>, les deux lignes seront sélectionnées. Pour empêcher cela, effectuez les transformations de type avant d’utiliser une valeur dans une requête.</p>
</div>
<div class="section" id="s-mapping-query-fields-to-model-fields">
<span id="mapping-query-fields-to-model-fields"></span><h3>Correspondance entre champs de requête et champs de modèle<a class="headerlink" href="#mapping-query-fields-to-model-fields" title="Lien permanent vers ce titre">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">raw()</span></code> fait automatiquement correspondre les champs de la requête avec les champs du modèle.</p>
<p>L’ordre des champs dans la requête n’est pas important. En d’autres termes, les deux requêtes suivantes donneront le même résultat&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;SELECT id, first_name, last_name, birth_date FROM myapp_person&#39;</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;SELECT last_name, birth_date, first_name, id FROM myapp_person&#39;</span><span class="p">)</span>
<span class="gp">...</span>
</pre></div>
</div>
<p>La correspondance se fait sur le nom. Cela signifie que vous pouvez utiliser les clauses SQL <code class="docutils literal notranslate"><span class="pre">AS</span></code> pour faire correspondre les champs de la requête aux champs du modèle. Ainsi, si vous disposez d’une autre table contenant les données de <code class="docutils literal notranslate"><span class="pre">Person</span></code>, vous pouvez facilement faire correspondre ces données avec des instances de <code class="docutils literal notranslate"><span class="pre">Person</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;SELECT first AS first_name,</span>
<span class="gp">... </span><span class="s1">                             last AS last_name,</span>
<span class="gp">... </span><span class="s1">                             bd AS birth_date,</span>
<span class="gp">... </span><span class="s1">                             pk AS id,</span>
<span class="gp">... </span><span class="s1">                      FROM some_other_table&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Tant que les noms correspondent, les instances de modèle seront créées correctement.</p>
<p>Il est aussi possible de faire correspondre les champs de requête aux champs de modèle en utilisant le paramètre <code class="docutils literal notranslate"><span class="pre">translations</span></code> de <code class="docutils literal notranslate"><span class="pre">raw()</span></code>. Il s’agit d’un dictionnaire faisant correspondre les noms des champs de la requête aux noms des champs du modèle. Par exemple, la requête ci-dessus aurait aussi pu être écrite de cette manière&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">name_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;first&#39;</span><span class="p">:</span> <span class="s1">&#39;first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;last&#39;</span><span class="p">:</span> <span class="s1">&#39;last_name&#39;</span><span class="p">,</span> <span class="s1">&#39;bd&#39;</span><span class="p">:</span> <span class="s1">&#39;birth_date&#39;</span><span class="p">,</span> <span class="s1">&#39;pk&#39;</span><span class="p">:</span> <span class="s1">&#39;id&#39;</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM some_other_table&#39;</span><span class="p">,</span> <span class="n">translations</span><span class="o">=</span><span class="n">name_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="s-index-lookups">
<span id="index-lookups"></span><h3>Filtrage par index<a class="headerlink" href="#index-lookups" title="Lien permanent vers ce titre">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">raw()</span></code> autorise l’utilisation d’index&nbsp;; dans le cas où vous souhaitez obtenir uniquement le premier résultat, vous pouvez écrire&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">first_person</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM myapp_person&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>Cependant, l’indexation et la segmentation ne sont pas effectuées au niveau de la base de données. Si la base de données contient une grande quantité d’objets <code class="docutils literal notranslate"><span class="pre">Person</span></code>, il est plus efficace de limiter la requête au niveau SQL&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">first_person</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM myapp_person LIMIT 1&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="s-deferring-model-fields">
<span id="deferring-model-fields"></span><h3>Report des champs de modèle<a class="headerlink" href="#deferring-model-fields" title="Lien permanent vers ce titre">¶</a></h3>
<p>Il est aussi possible d’ignorer certains champs&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">people</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;SELECT id, first_name FROM myapp_person&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Les objets <code class="docutils literal notranslate"><span class="pre">Person</span></code> renvoyés par cette requête constitueront des instances de modèle différées (voir <a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.defer" title="django.db.models.query.QuerySet.defer"><code class="xref py py-meth docutils literal notranslate"><span class="pre">defer()</span></code></a>). Cela signifie que les champs omis dans la requête seront chargés à la demande. Par exemple&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;SELECT id, first_name FROM myapp_person&#39;</span><span class="p">):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="c1"># This will be retrieved by the original query</span>
<span class="gp">... </span>          <span class="n">p</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span> <span class="c1"># This will be retrieved on demand</span>
<span class="gp">...</span>
<span class="go">John Smith</span>
<span class="go">Jane Jones</span>
</pre></div>
</div>
<p>En apparence, il semble que la requête ait récupéré à la fois le prénom et le nom. Cependant, cet exemple effectue en réalité 3 requêtes. Seuls les prénoms (first_name) ont été obtenus par la requête <code class="docutils literal notranslate"><span class="pre">raw()</span></code>, les noms (last_name) ont été obtenus chacun à la demande au moment où ils ont été affichés.</p>
<p>Un seul champ ne peut pas être omis, c’est le champ clé primaire. Django utilise la clé primaire pour identifier les instances de modèle, elle doit donc être obligatoirement incluse dans la requête brute. Une exception <a class="reference internal" href="../../ref/exceptions.html#django.core.exceptions.FieldDoesNotExist" title="django.core.exceptions.FieldDoesNotExist"><code class="xref py py-class docutils literal notranslate"><span class="pre">FieldDoesNotExist</span></code></a> est générée si vous oubliez d’inclure la clé primaire.</p>
</div>
<div class="section" id="s-adding-annotations">
<span id="adding-annotations"></span><h3>Ajout d’annotations<a class="headerlink" href="#adding-annotations" title="Lien permanent vers ce titre">¶</a></h3>
<p>Vous pouvez aussi exécuter des requêtes contenant des champs qui ne sont pas définis dans le modèle. Par exemple, il serait possible d’utiliser la <a class="reference external" href="https://www.postgresql.org/docs/current/functions-datetime.html">fonction age() de PostgreSQL</a> pour obtenir une liste de personnes avec leur âge calculé par la base de données&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">people</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;SELECT *, age(birth_date) AS age FROM myapp_person&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">people</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">age</span><span class="p">))</span>
<span class="go">John is 37.</span>
<span class="go">Jane is 42.</span>
<span class="gp">...</span>
</pre></div>
</div>
<p>Il est souvent possible d’éviter de devoir utiliser du code SQL brut pour calculer des annotations en faisant plutôt appel à une <a class="reference internal" href="../../ref/models/expressions.html#func-expressions"><span class="std std-ref">expression Func()</span></a>.</p>
</div>
<div class="section" id="s-passing-parameters-into-raw">
<span id="passing-parameters-into-raw"></span><h3>Transmission de paramètres dans <code class="docutils literal notranslate"><span class="pre">raw()</span></code><a class="headerlink" href="#passing-parameters-into-raw" title="Lien permanent vers ce titre">¶</a></h3>
<p>S’il est nécessaire d’effectuer des requêtes paramétrées, il est possible d’utiliser le paramètre <code class="docutils literal notranslate"><span class="pre">params</span></code> de <code class="docutils literal notranslate"><span class="pre">raw()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">lname</span> <span class="o">=</span> <span class="s1">&#39;Doe&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM myapp_person WHERE last_name = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">lname</span><span class="p">])</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">params</span></code> est une liste ou un dictionnaire de paramètres. Dans la chaîne de requête, il faut alors inclure des substituants <code class="docutils literal notranslate"><span class="pre">%s</span></code> pour une liste ou des substituants``%(clé)s`` pour un dictionnaire (où <code class="docutils literal notranslate"><span class="pre">clé</span></code> est remplacé par une clé de dictionnaire), quel que soit le moteur de base de données. Ces substituants seront remplacés par le contenu du paramètre <code class="docutils literal notranslate"><span class="pre">params</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Les paramètres de type dictionnaire ne sont pas pris en charge par le moteur SQLite&nbsp;; avec ce moteur, vous devez transmettre les paramètres sous forme de liste.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p><strong>N’utilisez pas de formatage de chaîne dans les requêtes brutes, ni de substituants entre guillemets dans vos chaînes SQL !</strong></p>
<p>Il est tentant d’écrire la requête ci-dessus comme ceci&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT * FROM myapp_person WHERE last_name = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">lname</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</pre></div>
</div>
<p>Vous pourriez aussi imaginer devoir écrire votre requête comme ceci (avec des guillemets autour de <code class="docutils literal notranslate"><span class="pre">%s</span></code>)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM myapp_person WHERE last_name = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
</pre></div>
</div>
<p><strong>Ne faites aucune de ces erreurs.</strong></p>
<p class="last">Comme discuté dans <a class="reference internal" href="../security.html#sql-injection-protection"><span class="std std-ref">Protection contre l’injection SQL</span></a>, l’utilisation du paramètre <code class="docutils literal notranslate"><span class="pre">params</span></code> et le fait de laisser les substituants sans guillemets vous protègent contre les <a class="reference external" href="https://en.wikipedia.org/wiki/SQL_injection">attaques d’injection SQL</a>, une faille courante où un attaquant injecte du code SQL arbitraire dans votre base de données. Si vous utilisez l’interpolation de chaîne ou que vous placez les substituants entre guillemets, vous êtes exposé aux injections SQL.</p>
</div>
</div>
</div>
<div class="section" id="s-executing-custom-sql-directly">
<span id="s-executing-custom-sql"></span><span id="executing-custom-sql-directly"></span><span id="executing-custom-sql"></span><h2>Exécution directe de code SQL<a class="headerlink" href="#executing-custom-sql-directly" title="Lien permanent vers ce titre">¶</a></h2>
<p>Dans certains cas, même <a class="reference internal" href="#django.db.models.Manager.raw" title="django.db.models.Manager.raw"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Manager.raw()</span></code></a> ne suffit pas&nbsp;: il se peut que des requêtes doivent être effectuées sans correspondre proprement à des modèles ou que vous vouliez exécuter directement des requêtes <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code>, <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> ou <code class="docutils literal notranslate"><span class="pre">DELETE</span></code>.</p>
<p>Dans ces situations, vous pouvez toujours accéder directement à la base de données, outrepassant complètement la couche des modèles.</p>
<p>L’objet <code class="docutils literal notranslate"><span class="pre">django.db.connection</span></code> représente la connexion à la base de données par défaut. Pour utiliser la connexion à la base de données, appelez <code class="docutils literal notranslate"><span class="pre">connection.cursor()</span></code> pour obtenir un objet curseur. Puis, appelez <code class="docutils literal notranslate"><span class="pre">cursor.execute(sql,</span> <span class="pre">[params])</span></code> pour exécuter le code SQL et <code class="docutils literal notranslate"><span class="pre">cursor.fetchone()</span></code> ou <code class="docutils literal notranslate"><span class="pre">cursor.fetchall()</span></code> pour obtenir les lignes de résultat.</p>
<p>Par exemple&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">connection</span>

<span class="k">def</span> <span class="nf">my_custom_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE bar SET foo = 1 WHERE baz = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">baz</span><span class="p">])</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT foo FROM bar WHERE baz = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">baz</span><span class="p">])</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">row</span>
</pre></div>
</div>
<p>Pour se protéger des injections SQL, vous devez vous abstenir de placer des guillemets autour des substituants <code class="docutils literal notranslate"><span class="pre">%s</span></code> dans la chaîne SQL.</p>
<p>Notez que si vous voulez inclure des signes «&nbsp;pour cent&nbsp;» littéraux dans la requête, vous devez les doubler dans le cas où vous transmettez des paramètres&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT foo FROM bar WHERE baz = &#39;30%&#39;&quot;</span><span class="p">)</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT foo FROM bar WHERE baz = &#39;30</span><span class="si">%%</span><span class="s2">&#39; AND id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
</pre></div>
</div>
<p>Si vous utilisez <a class="reference internal" href="multi-db.html"><span class="doc">plus d’une base de données</span></a>, vous pouvez utiliser <code class="docutils literal notranslate"><span class="pre">django.db.connections</span></code> pour obtenir la connexion (et le curseur) pour une base de données spécifique. <code class="docutils literal notranslate"><span class="pre">django.db.connections</span></code> est un objet de type dictionnaire permettant de récupérer une connexion spécifique en employant son alias&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">connections</span>
<span class="k">with</span> <span class="n">connections</span><span class="p">[</span><span class="s1">&#39;my_db_alias&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
    <span class="c1"># Your code here...</span>
</pre></div>
</div>
<p>Par défaut, l’API de base de données de Python renvoie les résultats sans les noms de champs, ce qui signifie que vous vous retrouvez avec une liste de valeurs plutôt qu’un dictionnaire. Pour un faible coût en performances et en mémoire, vous pouvez obtenir les résultats sous forme de dictionnaire en écrivant quelque chose comme&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">dictfetchall</span><span class="p">(</span><span class="n">cursor</span><span class="p">):</span>
    <span class="s2">&quot;Return all rows from a cursor as a dict&quot;</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="p">]</span>
</pre></div>
</div>
<p>Une autre option est d’utiliser une structure <a class="reference external" href="https://docs.python.org/3/library/collections.html#collections.namedtuple" title="(disponible dans Python v3.9)"><code class="xref py py-func docutils literal notranslate"><span class="pre">collections.namedtuple()</span></code></a> de la bibliothèque Python standard. Un <code class="docutils literal notranslate"><span class="pre">namedtuple</span></code> est un objet de type tuple dont les champs sont accessibles sous forme d’attribut&nbsp;; l’accès par indice est aussi possible et l’objet est itérable. Les résultats sont immuables et accessibles par nom de champ ou par indice, ce qui pourrait être pratique&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span>

<span class="k">def</span> <span class="nf">namedtuplefetchall</span><span class="p">(</span><span class="n">cursor</span><span class="p">):</span>
    <span class="s2">&quot;Return all rows from a cursor as a namedtuple&quot;</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">description</span>
    <span class="n">nt_result</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Result&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">nt_result</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
</pre></div>
</div>
<p>Voici un exemple de la différence entre les trois&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id, parent_id FROM test LIMIT 2&quot;</span><span class="p">);</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="go">((54360982, None), (54360880, None))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id, parent_id FROM test LIMIT 2&quot;</span><span class="p">);</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dictfetchall</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
<span class="go">[{&#39;parent_id&#39;: None, &#39;id&#39;: 54360982}, {&#39;parent_id&#39;: None, &#39;id&#39;: 54360880}]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id, parent_id FROM test LIMIT 2&quot;</span><span class="p">);</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">results</span> <span class="o">=</span> <span class="n">namedtuplefetchall</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">results</span>
<span class="go">[Result(id=54360982, parent_id=None), Result(id=54360880, parent_id=None)]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
<span class="go">54360982</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="go">54360982</span>
</pre></div>
</div>
<div class="section" id="s-connections-and-cursors">
<span id="connections-and-cursors"></span><h3>Connexions et curseurs<a class="headerlink" href="#connections-and-cursors" title="Lien permanent vers ce titre">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">connection</span></code> et <code class="docutils literal notranslate"><span class="pre">cursor</span></code> implémentent essentiellement l’API de base de données standard de Python décrite dans la <span class="target" id="index-2"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0249"><strong>PEP 249</strong></a>, à l’exception de ce qui concerne la <a class="reference internal" href="transactions.html"><span class="doc">gestion des transactions</span></a>.</p>
<p>Si cette API DB de Python ne vous est pas familière, notez que l’instruction SQL dans <code class="docutils literal notranslate"><span class="pre">cursor.execute()</span></code> utilise des substituants, <code class="docutils literal notranslate"><span class="pre">&quot;%s&quot;</span></code>, plutôt que d’ajouter directement les paramètres dans la chaîne SQL. Si vous utilisez cette technique, la bibliothèque sous-jacente de base de données s’occupe automatiquement d’échapper vos paramètres au besoin.</p>
<p>Notez également que Django compte sur des substituants <code class="docutils literal notranslate"><span class="pre">&quot;%s&quot;</span></code>, <em>pas</em> de substituants <code class="docutils literal notranslate"><span class="pre">&quot;?&quot;</span></code> qui sont utilisés par la bibliothèque SQLite de Python, pour des raisons de cohérence et de bon sens.</p>
<p>L’utilisation d’un curseur en tant que gestionnaire de contexte&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>est équivalent à&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="s-calling-stored-procedures">
<span id="calling-stored-procedures"></span><h4>Appeler des procédures stockées<a class="headerlink" href="#calling-stored-procedures" title="Lien permanent vers ce titre">¶</a></h4>
<dl class="method">
<dt id="django.db.models.CursorWrapper.callproc">
<code class="descclassname">CursorWrapper.</code><code class="descname">callproc</code>(<em>procname</em>, <em>params=None</em>, <em>kparams=None</em>)<a class="headerlink" href="#django.db.models.CursorWrapper.callproc" title="Lien permanent vers cette définition">¶</a></dt>
<dd><p>Appelle une procédure stockée de base de données ayant le nom indiqué. Une liste (<code class="docutils literal notranslate"><span class="pre">params</span></code>) ou un dictionnaire (<code class="docutils literal notranslate"><span class="pre">kparams</span></code>) de paramètres d’entrée peuvent être fournis. La plupart des bases de données n’acceptent pas <code class="docutils literal notranslate"><span class="pre">kparams</span></code>. Parmi celles qui sont prises en charge nativement par Django, seule Oracle accepte <code class="docutils literal notranslate"><span class="pre">kparams</span></code>.</p>
<p>Par exemple, avec cette procédure stockée dans une base de données Oracle :</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="ss">&quot;TEST_PROCEDURE&quot;</span><span class="p">(</span><span class="n">v_i</span> <span class="nb">INTEGER</span><span class="p">,</span> <span class="n">v_text</span> <span class="n">NVARCHAR2</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="k">AS</span>
    <span class="n">p_i</span> <span class="nb">INTEGER</span><span class="p">;</span>
    <span class="n">p_text</span> <span class="n">NVARCHAR2</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="k">BEGIN</span>
    <span class="n">p_i</span> <span class="p">:</span><span class="o">=</span> <span class="n">v_i</span><span class="p">;</span>
    <span class="n">p_text</span> <span class="p">:</span><span class="o">=</span> <span class="n">v_text</span><span class="p">;</span>
    <span class="p">...</span>
<span class="k">END</span><span class="p">;</span>
</pre></div>
</div>
<p>Ceci l’appellera</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">callproc</span><span class="p">(</span><span class="s1">&#39;test_procedure&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">])</span>
</pre></div>
</div>
</dd></dl>

</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      
        
          <div class="yui-b" id="sidebar">
            
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../contents.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Lancement de requêtes SQL brutes</a><ul>
<li><a class="reference internal" href="#performing-raw-queries">Lancement de requêtes brutes</a><ul>
<li><a class="reference internal" href="#mapping-query-fields-to-model-fields">Correspondance entre champs de requête et champs de modèle</a></li>
<li><a class="reference internal" href="#index-lookups">Filtrage par index</a></li>
<li><a class="reference internal" href="#deferring-model-fields">Report des champs de modèle</a></li>
<li><a class="reference internal" href="#adding-annotations">Ajout d’annotations</a></li>
<li><a class="reference internal" href="#passing-parameters-into-raw">Transmission de paramètres dans <code class="docutils literal notranslate"><span class="pre">raw()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#executing-custom-sql-directly">Exécution directe de code SQL</a><ul>
<li><a class="reference internal" href="#connections-and-cursors">Connexions et curseurs</a><ul>
<li><a class="reference internal" href="#calling-stored-procedures">Appeler des procédures stockées</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Sujet précédent</h4>
  <p class="topless"><a href="managers.html"
                        title="Chapitre précédent">Gestionnaires</a></p>
  <h4>Sujet suivant</h4>
  <p class="topless"><a href="transactions.html"
                        title="Chapitre suivant">Transactions de base de données</a></p>
  <div role="note" aria-label="source link">
    <h3>Cette page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/topics/db/sql.txt"
            rel="nofollow">Montrer le code source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Recherche rapide</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
              <h3>Last update:</h3>
              <p class="topless">oct. 29, 2020</p>
          </div>
        
      
    </div>

    <div id="ft">
      <div class="nav">
    &laquo; <a href="managers.html" title="Gestionnaires">previous</a>
     |
    <a href="../index.html" title="Utilisation de Django" accesskey="U">up</a>
   |
    <a href="transactions.html" title="Transactions de base de données">next</a> &raquo;</div>
    </div>
  </div>

      <div class="clearer"></div>
    </div>
  </body>
</html>