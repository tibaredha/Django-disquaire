
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="fr">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Écriture de votre première application Django, 4ème partie &#8212; Documentation Django 3.1.3.dev</title>
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" />
    <link rel="next" title="Écriture de votre première application Django, 5ème partie" href="tutorial05.html" />
    <link rel="prev" title="Écriture de votre première application Django, 3ème partie" href="tutorial03.html" />



 
<script src="../templatebuiltins.js"></script>
<script>
(function($) {
    if (!django_template_builtins) {
       // templatebuiltins.js missing, do nothing.
       return;
    }
    $(document).ready(function() {
        // Hyperlink Django template tags and filters
        var base = "../ref/templates/builtins.html";
        if (base == "#") {
            // Special case for builtins.html itself
            base = "";
        }
        // Tags are keywords, class '.k'
        $("div.highlight\\-html\\+django span.k").each(function(i, elem) {
             var tagname = $(elem).text();
             if ($.inArray(tagname, django_template_builtins.ttags) != -1) {
                 var fragment = tagname.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + tagname + "</a>");
             }
        });
        // Filters are functions, class '.nf'
        $("div.highlight\\-html\\+django span.nf").each(function(i, elem) {
             var filtername = $(elem).text();
             if ($.inArray(filtername, django_template_builtins.tfilters) != -1) {
                 var fragment = filtername.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + filtername + "</a>");
             }
        });
    });
})(jQuery);</script>

  </head><body>

    <div class="document">
  <div id="custom-doc" class="yui-t6">
    <div id="hd">
      <h1><a href="../index.html">Documentation Django 3.1.3.dev</a></h1>
      <div id="global-nav">
        <a title="Home page" href="../index.html">Home</a>  |
        <a title="Table of contents" href="../contents.html">Table of contents</a>  |
        <a title="Global index" href="../genindex.html">Index</a>  |
        <a title="Module index" href="../py-modindex.html">Modules</a>
      </div>
      <div class="nav">
    &laquo; <a href="tutorial03.html" title="Écriture de votre première application Django, 3ème partie">previous</a>
     |
    <a href="index.html" title="Premiers pas" accesskey="U">up</a>
   |
    <a href="tutorial05.html" title="Écriture de votre première application Django, 5ème partie">next</a> &raquo;</div>
    </div>

    <div id="bd">
      <div id="yui-main">
        <div class="yui-b">
          <div class="yui-g" id="intro-tutorial04">
            
  <div class="section" id="s-writing-your-first-django-app-part-4">
<span id="writing-your-first-django-app-part-4"></span><h1>Écriture de votre première application Django, 4ème partie<a class="headerlink" href="#writing-your-first-django-app-part-4" title="Lien permanent vers ce titre">¶</a></h1>
<p>Ce tutoriel commence là où le <a class="reference internal" href="tutorial03.html"><span class="doc">tutoriel 3</span></a> s’achève. Nous continuons l’application de sondage Web et allons nous focaliser sur la gestion de formulaire et sur la réduction du code.</p>
<div class="admonition-where-to-get-help admonition">
<p class="first admonition-title">Où obtenir de l’aide&nbsp;:</p>
<p class="last">Si vous rencontrez des problèmes dans le parcours de ce tutoriel, rendez-vous dans la section <a class="reference internal" href="../faq/help.html"><span class="doc">Obtenir de l’aide</span></a> de la FAQ.</p>
</div>
<div class="section" id="s-write-a-minimal-form">
<span id="write-a-minimal-form"></span><h2>Écriture d’un formulaire minimal<a class="headerlink" href="#write-a-minimal-form" title="Lien permanent vers ce titre">¶</a></h2>
<p>Nous allons mettre à jour le gabarit de la page de détail («&nbsp;polls/details.html&nbsp;») du tutoriel précédent, de manière à ce que le gabarit contienne une balise HTML <code class="docutils literal notranslate"><span class="pre">&lt;form&gt;</span></code> :</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">polls/templates/polls/detail.html</span><a class="headerlink" href="#id1" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-html+django notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">question.question_text</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

<span class="cp">{%</span> <span class="k">if</span> <span class="nv">error_message</span> <span class="cp">%}</span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">strong</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">error_message</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>

<span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;polls:vote&#39;</span> <span class="nv">question.id</span> <span class="cp">%}</span><span class="s">&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span><span class="p">&gt;</span>
<span class="cp">{%</span> <span class="k">csrf_token</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">choice</span> <span class="k">in</span> <span class="nv">question.choice_set.all</span> <span class="cp">%}</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;radio&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;choice&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;choice</span><span class="cp">{{</span> <span class="nb">forloop</span><span class="nv">.counter</span> <span class="cp">}}</span><span class="s">&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">choice.id</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;choice</span><span class="cp">{{</span> <span class="nb">forloop</span><span class="nv">.counter</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">choice.choice_text</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Vote&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
</div>
</div>
<p>Un résumé rapide&nbsp;:</p>
<ul class="simple">
<li>Ce gabarit affiche un bouton radio pour chaque choix de question. L’attribut <code class="docutils literal notranslate"><span class="pre">value</span></code> de chaque bouton radio correspond à l’ID du vote choisi. Le nom (<code class="docutils literal notranslate"><span class="pre">name</span></code>) de chaque bouton radio est <code class="docutils literal notranslate"><span class="pre">&quot;choice&quot;</span></code>. Cela signifie que lorsque quelqu’un sélectionne l’un des boutons radio et valide le formulaire, les données POST <code class="docutils literal notranslate"><span class="pre">choice=#</span></code> (où # est l’identifiant du choix sélectionné) seront envoyées. Ce sont les concepts de base des formulaires HTML.</li>
<li>Nous avons défini <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">url</span> <span class="pre">'polls:vote'</span> <span class="pre">question.id</span> <span class="pre">%}</span></code> comme attribut <code class="docutils literal notranslate"><span class="pre">action</span></code> du formulaire, et nous avons précisé <code class="docutils literal notranslate"><span class="pre">method=&quot;post&quot;</span></code>. L’utilisation de <code class="docutils literal notranslate"><span class="pre">method=&quot;post&quot;</span></code> (par opposition à <code class="docutils literal notranslate"><span class="pre">method=&quot;get&quot;</span></code>) est très importante, puisque le fait de valider ce formulaire va entraîner des modifications de données sur le serveur. À chaque fois qu’un formulaire modifie des données sur le serveur, vous devez utiliser <code class="docutils literal notranslate"><span class="pre">method=&quot;post&quot;</span></code>. Cela ne concerne pas uniquement Django&nbsp;; c’est une bonne pratique à adopter en tant que développeur Web.</li>
<li><code class="docutils literal notranslate"><span class="pre">forloop.counter</span></code> indique combien de fois la balise <a class="reference internal" href="../ref/templates/builtins.html#std:templatetag-for"><code class="xref std std-ttag docutils literal notranslate"><span class="pre">for</span></code></a> a exécuté sa boucle.</li>
<li>Comme nous créons un formulaire POST (qui modifie potentiellement des données), il faut se préoccuper des attaques inter-sites. Heureusement, vous ne devez pas réfléchir trop longtemps car Django offre un moyen pratique à utiliser pour s’en protéger. En bref, tous les formulaires POST destinés à des URL internes doivent utiliser la balise de gabarit <a class="reference internal" href="../ref/templates/builtins.html#std:templatetag-csrf_token"><code class="xref std std-ttag docutils literal notranslate"><span class="pre">{%</span> <span class="pre">csrf_token</span> <span class="pre">%}</span></code></a>.</li>
</ul>
<p>Maintenant, nous allons créer une vue Django qui récupère les données envoyées pour nous permettre de les exploiter. Souvenez-vous, dans le <a class="reference internal" href="tutorial03.html"><span class="doc">tutoriel 3</span></a>, nous avons créé un URLconf pour l’application de sondage contenant cette ligne&nbsp;:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">polls/urls.py</span><a class="headerlink" href="#id2" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">path</span><span class="p">(</span><span class="s1">&#39;&lt;int:question_id&gt;/vote/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">vote</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;vote&#39;</span><span class="p">),</span>
</pre></div>
</div>
</div>
<p>Nous avions également créé une implémentation rudimentaire de la fonction <code class="docutils literal notranslate"><span class="pre">vote()</span></code>. Créons maintenant une version fonctionnelle. Ajoutez ce qui suit dans le fichier <code class="docutils literal notranslate"><span class="pre">polls/views.py</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">polls/views.py</span><a class="headerlink" href="#id3" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Choice</span><span class="p">,</span> <span class="n">Question</span>
<span class="c1"># ...</span>
<span class="k">def</span> <span class="nf">vote</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">question_id</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">selected_choice</span> <span class="o">=</span> <span class="n">question</span><span class="o">.</span><span class="n">choice_set</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;choice&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">Choice</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="c1"># Redisplay the question voting form.</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;polls/detail.html&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="n">question</span><span class="p">,</span>
            <span class="s1">&#39;error_message&#39;</span><span class="p">:</span> <span class="s2">&quot;You didn&#39;t select a choice.&quot;</span><span class="p">,</span>
        <span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">selected_choice</span><span class="o">.</span><span class="n">votes</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">selected_choice</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c1"># Always return an HttpResponseRedirect after successfully dealing</span>
        <span class="c1"># with POST data. This prevents data from being posted twice if a</span>
        <span class="c1"># user hits the Back button.</span>
        <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;polls:results&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">question</span><span class="o">.</span><span class="n">id</span><span class="p">,)))</span>
</pre></div>
</div>
</div>
<p>Ce code contient quelques points encore non abordés dans ce tutoriel&nbsp;:</p>
<ul>
<li><p class="first"><a class="reference internal" href="../ref/request-response.html#django.http.HttpRequest.POST" title="django.http.HttpRequest.POST"><code class="xref py py-attr docutils literal notranslate"><span class="pre">request.POST</span></code></a> est un objet similaire à un dictionnaire qui vous permet d’accéder aux données envoyées par leurs clés. Dans ce cas, <code class="docutils literal notranslate"><span class="pre">request.POST['choice']</span></code> renvoie l’ID du choix sélectionné, sous forme d’une chaîne de caractères. Les valeurs dans <a class="reference internal" href="../ref/request-response.html#django.http.HttpRequest.POST" title="django.http.HttpRequest.POST"><code class="xref py py-attr docutils literal notranslate"><span class="pre">request.POST</span></code></a> sont toujours des chaînes de caractères.</p>
<p>Notez que Django dispose aussi de <a class="reference internal" href="../ref/request-response.html#django.http.HttpRequest.GET" title="django.http.HttpRequest.GET"><code class="xref py py-attr docutils literal notranslate"><span class="pre">request.GET</span></code></a> pour accéder aux données GET de la même manière – mais nous utilisons explicitement <a class="reference internal" href="../ref/request-response.html#django.http.HttpRequest.POST" title="django.http.HttpRequest.POST"><code class="xref py py-attr docutils literal notranslate"><span class="pre">request.POST</span></code></a> dans notre code, pour s’assurer que les données ne sont modifiées que par des requêtes POST.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">request.POST['choice']</span></code> lèvera une exception <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#KeyError" title="(disponible dans Python v3.9)"><code class="xref py py-exc docutils literal notranslate"><span class="pre">KeyError</span></code></a> si <code class="docutils literal notranslate"><span class="pre">choice</span></code> n’est pas spécifié dans les données POST. Le code ci-dessus vérifie qu’une exception <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#KeyError" title="(disponible dans Python v3.9)"><code class="xref py py-exc docutils literal notranslate"><span class="pre">KeyError</span></code></a> n’est pas levée et réaffiche le formulaire de question avec un message d’erreur si <code class="docutils literal notranslate"><span class="pre">choice</span></code> n’est pas rempli.</p>
</li>
<li><p class="first">Après l’incrémentation du nombre de votes du choix, le code renvoie une <a class="reference internal" href="../ref/request-response.html#django.http.HttpResponseRedirect" title="django.http.HttpResponseRedirect"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpResponseRedirect</span></code></a> plutôt qu’une <a class="reference internal" href="../ref/request-response.html#django.http.HttpResponse" title="django.http.HttpResponse"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpResponse</span></code></a> normale. <a class="reference internal" href="../ref/request-response.html#django.http.HttpResponseRedirect" title="django.http.HttpResponseRedirect"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpResponseRedirect</span></code></a> prend un seul paramètre&nbsp;: l’URL vers laquelle l’utilisateur va être redirigé (voir le point suivant pour la manière de construire cette URL dans ce cas).</p>
<p>Comme le commentaire Python l’indique, vous devez systématiquement renvoyer une <a class="reference internal" href="../ref/request-response.html#django.http.HttpResponseRedirect" title="django.http.HttpResponseRedirect"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpResponseRedirect</span></code></a> après avoir correctement traité les données POST. Ceci n’est pas valable uniquement avec Django, c’est une bonne pratique du développement Web.</p>
</li>
<li><p class="first">Dans cet exemple, nous utilisons la fonction <a class="reference internal" href="../ref/urlresolvers.html#django.urls.reverse" title="django.urls.reverse"><code class="xref py py-func docutils literal notranslate"><span class="pre">reverse()</span></code></a> dans le constructeur de <a class="reference internal" href="../ref/request-response.html#django.http.HttpResponseRedirect" title="django.http.HttpResponseRedirect"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpResponseRedirect</span></code></a>. Cette fonction nous évite de coder en dur une URL dans une vue. On lui donne en paramètre la vue vers laquelle nous voulons rediriger ainsi que la partie variable de l’URL qui pointe vers cette vue. Dans ce cas, en utilisant l’URLconf défini dans la <a class="reference internal" href="tutorial03.html"><span class="doc">partie 3 de ce tutoriel</span></a>, l’appel de la fonction <a class="reference internal" href="../ref/urlresolvers.html#django.urls.reverse" title="django.urls.reverse"><code class="xref py py-func docutils literal notranslate"><span class="pre">reverse()</span></code></a> va renvoyer la chaîne de caractères&nbsp;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;/polls/3/results/&#39;</span>
</pre></div>
</div>
<p>où <code class="docutils literal notranslate"><span class="pre">3</span></code> est la valeur de <code class="docutils literal notranslate"><span class="pre">question.id</span></code>. Cette URL de redirection va ensuite appeler la vue <code class="docutils literal notranslate"><span class="pre">'results'</span></code> pour afficher la page finale.</p>
</li>
</ul>
<p>Comme expliqué dans la <a class="reference internal" href="tutorial03.html"><span class="doc">partie 3 de ce tutoriel</span></a>, <code class="docutils literal notranslate"><span class="pre">request</span></code> est un objet <a class="reference internal" href="../ref/request-response.html#django.http.HttpRequest" title="django.http.HttpRequest"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpRequest</span></code></a>. Pour plus d’informations sur les objets <a class="reference internal" href="../ref/request-response.html#django.http.HttpRequest" title="django.http.HttpRequest"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpRequest</span></code></a>, voir la <a class="reference internal" href="../ref/request-response.html"><span class="doc">documentation des requêtes et réponses</span></a>.</p>
<p>Après le vote d’une personne dans une question, la vue <code class="docutils literal notranslate"><span class="pre">vote()</span></code> redirige vers la page de résultats de la question. Écrivons cette vue&nbsp;:</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">polls/views.py</span><a class="headerlink" href="#id4" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render</span>


<span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">question_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;polls/results.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="n">question</span><span class="p">})</span>
</pre></div>
</div>
</div>
<p>C’est presque exactement la même que la vue <code class="docutils literal notranslate"><span class="pre">detail()</span></code> du <a class="reference internal" href="tutorial03.html"><span class="doc">tutoriel 3</span></a>. La seule différence est le nom du gabarit. Nous éliminerons cette redondance plus tard.</p>
<p>Écrivons maintenant le gabarit <code class="docutils literal notranslate"><span class="pre">polls/results.html</span></code> :</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">polls/templates/polls/results.html</span><a class="headerlink" href="#id5" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-html+django notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">question.question_text</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">choice</span> <span class="k">in</span> <span class="nv">question.choice_set.all</span> <span class="cp">%}</span>
    <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">choice.choice_text</span> <span class="cp">}}</span> -- <span class="cp">{{</span> <span class="nv">choice.votes</span> <span class="cp">}}</span> vote<span class="cp">{{</span> <span class="nv">choice.votes</span><span class="o">|</span><span class="nf">pluralize</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;polls:detail&#39;</span> <span class="nv">question.id</span> <span class="cp">%}</span><span class="s">&quot;</span><span class="p">&gt;</span>Vote again?<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</pre></div>
</div>
</div>
<p>Maintenant, rendez-vous à la page <code class="docutils literal notranslate"><span class="pre">/polls/1/</span></code> avec votre navigateur et votez pour la question proposée. Vous devriez voir une page de résultats qui sera mise à jour à chaque fois que vous voterez. Si vous validez le formulaire sans avoir coché votre choix, vous devriez voir le message d’erreur.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Le code de notre vue <code class="docutils literal notranslate"><span class="pre">vote()</span></code> présente un petit problème. Il obtient d’abord l’objet <code class="docutils literal notranslate"><span class="pre">selected_choice</span></code> depuis la base de données, puis calcule la nouvelle valeur de <code class="docutils literal notranslate"><span class="pre">votes</span></code>, et enregistre ensuite le résultat dans la base de données. Si deux utilisateurs du site Web essaient de voter <em>exactement au même moment</em>, cela peut mal se passer&nbsp;: la même valeur, disons 42, sera obtenue pour <code class="docutils literal notranslate"><span class="pre">votes</span></code>. Puis, la nouvelle valeur calculée sera de 43 pour les deux utilisateurs qui enregistreront cette valeur, alors qu’elle devrait être de 44 au final.</p>
<p class="last">On appelle cela une <em>situation de compétition</em>. Si cela vous intéresse, vous pouvez lire <a class="reference internal" href="../ref/models/expressions.html#avoiding-race-conditions-using-f"><span class="std std-ref">Prévention des conflits de concurrence avec F()</span></a> pour savoir comment il est possible d’éviter ce genre de situations.</p>
</div>
</div>
<div class="section" id="s-use-generic-views-less-code-is-better">
<span id="use-generic-views-less-code-is-better"></span><h2>Utilisation des vues génériques&nbsp;: moins de code, c’est mieux<a class="headerlink" href="#use-generic-views-less-code-is-better" title="Lien permanent vers ce titre">¶</a></h2>
<p>Les vues <code class="docutils literal notranslate"><span class="pre">detail()</span></code> (cf. <a class="reference internal" href="tutorial03.html"><span class="doc">tutoriel 3</span></a>) et <code class="docutils literal notranslate"><span class="pre">results()</span></code> sont très courtes – et comme mentionné précédemment, redondantes. La vue <code class="docutils literal notranslate"><span class="pre">index()</span></code> qui affiche une liste de sondages est similaire.</p>
<p>Ces vues représentent un cas classique du développement Web&nbsp;: récupérer les données depuis la base de données suivant un paramètre contenu dans l’URL, charger un gabarit et renvoyer le gabarit interprété. Ce cas est tellement classique que Django propose un raccourci, appelé le système de «&nbsp;vues génériques&nbsp;».</p>
<p>Les vues génériques permettent l’abstraction de pratiques communes, à un tel point que vous n’avez pas à écrire de code Python pour écrire une application.</p>
<p>Nous allons convertir notre application de sondage pour qu’elle utilise le système de vues génériques. Nous pourrons ainsi supprimer une partie de notre code. Nous avons quelques pas à faire pour effectuer cette conversion. Nous allons&nbsp;:</p>
<ol class="arabic simple">
<li>Convertir l’URLconf.</li>
<li>Supprimer quelques anciennes vues désormais inutiles.</li>
<li>Introduire de nouvelles vues basées sur les vues génériques de Django.</li>
</ol>
<p>Lisez la suite pour plus de détails.</p>
<div class="admonition-why-the-code-shuffle admonition">
<p class="first admonition-title">Pourquoi ces changements de code&nbsp;?</p>
<p>En général, lorsque vous écrivez une application Django, vous devez estimer si les vues génériques correspondent bien à vos besoins et, le cas échéant, vous les utiliserez dès le début, plutôt que de réarranger votre code à mi-chemin. Mais ce tutoriel s’est concentré intentionnellement sur l’écriture des vues «&nbsp;à la dure&nbsp;» jusqu’à ce point, pour mettre l’accent sur les concepts de base.</p>
<p class="last">Tout comme vous devez posséder des bases de maths avant de commencer à utiliser une calculatrice.</p>
</div>
<div class="section" id="s-amend-urlconf">
<span id="amend-urlconf"></span><h3>Correction de l’URLconf<a class="headerlink" href="#amend-urlconf" title="Lien permanent vers ce titre">¶</a></h3>
<p>Tout d’abord, ouvrez la configuration d’URL <code class="docutils literal notranslate"><span class="pre">polls/urls.py</span></code> et modifiez-la ainsi&nbsp;:</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">polls/urls.py</span><a class="headerlink" href="#id6" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">app_name</span> <span class="o">=</span> <span class="s1">&#39;polls&#39;</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">IndexView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;&lt;int:pk&gt;/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">DetailView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;detail&#39;</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;&lt;int:pk&gt;/results/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">ResultsView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;results&#39;</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;&lt;int:question_id&gt;/vote/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">vote</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;vote&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<p>Notez que le nom du motif correspondant dans les chaînes de chemin des deuxième et troisième motifs a été modifié de <code class="docutils literal notranslate"><span class="pre">&lt;question_id&gt;</span></code> en <code class="docutils literal notranslate"><span class="pre">&lt;pk&gt;</span></code>.</p>
</div>
<div class="section" id="s-amend-views">
<span id="amend-views"></span><h3>Correction des vues<a class="headerlink" href="#amend-views" title="Lien permanent vers ce titre">¶</a></h3>
<p>Ensuite, nous allons enlever les anciennes vues <code class="docutils literal notranslate"><span class="pre">index</span></code>, <code class="docutils literal notranslate"><span class="pre">detail</span></code> et <code class="docutils literal notranslate"><span class="pre">results</span></code> et utiliser à la place des vues génériques de Django. Pour cela, ouvrez le fichier <code class="docutils literal notranslate"><span class="pre">polls/views.py</span></code> et modifiez-le de cette façon&nbsp;:</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">polls/views.py</span><a class="headerlink" href="#id7" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.views</span> <span class="kn">import</span> <span class="n">generic</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Choice</span><span class="p">,</span> <span class="n">Question</span>


<span class="k">class</span> <span class="nc">IndexView</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">ListView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;polls/index.html&#39;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;latest_question_list&#39;</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the last five published questions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-pub_date&#39;</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">DetailView</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Question</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;polls/detail.html&#39;</span>


<span class="k">class</span> <span class="nc">ResultsView</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Question</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;polls/results.html&#39;</span>


<span class="k">def</span> <span class="nf">vote</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="o">...</span> <span class="c1"># same as above, no changes needed.</span>
</pre></div>
</div>
</div>
<p>Nous utilisons ici deux vues génériques&nbsp;: <a class="reference internal" href="../ref/class-based-views/generic-display.html#django.views.generic.list.ListView" title="django.views.generic.list.ListView"><code class="xref py py-class docutils literal notranslate"><span class="pre">ListView</span></code></a> et <a class="reference internal" href="../ref/class-based-views/generic-display.html#django.views.generic.detail.DetailView" title="django.views.generic.detail.DetailView"><code class="xref py py-class docutils literal notranslate"><span class="pre">DetailView</span></code></a>. Respectivement, ces deux vues permettent l’abstraction des concepts «&nbsp;afficher une liste d’objets&nbsp;» et «&nbsp;afficher une page détaillée pour un type particulier d’objet&nbsp;».</p>
<ul class="simple">
<li>Chaque vue générique a besoin de connaître le modèle sur lequel elle va agir. Cette information est fournie par l’attribut <code class="docutils literal notranslate"><span class="pre">model</span></code>.</li>
<li>La vue générique <a class="reference internal" href="../ref/class-based-views/generic-display.html#django.views.generic.detail.DetailView" title="django.views.generic.detail.DetailView"><code class="xref py py-class docutils literal notranslate"><span class="pre">DetailView</span></code></a> s’attend à ce que la clé primaire capturée dans l’URL s’appelle <code class="docutils literal notranslate"><span class="pre">&quot;pk&quot;</span></code>, nous avons donc changé <code class="docutils literal notranslate"><span class="pre">question_id</span></code> en <code class="docutils literal notranslate"><span class="pre">pk</span></code> pour les vues génériques.</li>
</ul>
<p>Par défaut, la vue générique <a class="reference internal" href="../ref/class-based-views/generic-display.html#django.views.generic.detail.DetailView" title="django.views.generic.detail.DetailView"><code class="xref py py-class docutils literal notranslate"><span class="pre">DetailView</span></code></a> utilise un gabarit appelé <code class="docutils literal notranslate"><span class="pre">&lt;nom</span> <span class="pre">app&gt;/&lt;nom</span> <span class="pre">modèle&gt;_detail.html</span></code>. Dans notre cas, elle utiliserait le gabarit <code class="docutils literal notranslate"><span class="pre">&quot;polls/question_detail.html&quot;</span></code>. L’attribut <code class="docutils literal notranslate"><span class="pre">template_name</span></code> est utilisé pour signifier à Django d’utiliser un nom de gabarit spécifique plutôt que le nom de gabarit par défaut. Nous avons aussi indiqué le paramètre <code class="docutils literal notranslate"><span class="pre">template_name</span></code> pour la vue de liste <code class="docutils literal notranslate"><span class="pre">results</span></code>, ce qui permet de différencier l’apparence du rendu des vues «&nbsp;results&nbsp;» et «&nbsp;detail&nbsp;», même s’il s’agit dans les deux cas de vues <a class="reference internal" href="../ref/class-based-views/generic-display.html#django.views.generic.detail.DetailView" title="django.views.generic.detail.DetailView"><code class="xref py py-class docutils literal notranslate"><span class="pre">DetailView</span></code></a> à la base.</p>
<p>De la même façon, la vue générique <a class="reference internal" href="../ref/class-based-views/generic-display.html#django.views.generic.list.ListView" title="django.views.generic.list.ListView"><code class="xref py py-class docutils literal notranslate"><span class="pre">ListView</span></code></a> utilise par défaut un gabarit appelé <code class="docutils literal notranslate"><span class="pre">&lt;nom</span> <span class="pre">app&gt;/&lt;nom</span> <span class="pre">modèle&gt;_list.html</span></code>&nbsp;; nous utilisons  <code class="docutils literal notranslate"><span class="pre">template_name</span></code> pour indiquer à <a class="reference internal" href="../ref/class-based-views/generic-display.html#django.views.generic.list.ListView" title="django.views.generic.list.ListView"><code class="xref py py-class docutils literal notranslate"><span class="pre">ListView</span></code></a> d’utiliser notre gabarit existant <code class="docutils literal notranslate"><span class="pre">&quot;polls/index.html&quot;</span></code>.</p>
<p>Dans les parties précédentes de ce tutoriel, les templates ont été renseignés avec un contexte qui contenait les variables de contexte <code class="docutils literal notranslate"><span class="pre">question</span></code> et <code class="docutils literal notranslate"><span class="pre">latest_question_list</span></code>. Pour <code class="docutils literal notranslate"><span class="pre">DetailView</span></code>, la variable <code class="docutils literal notranslate"><span class="pre">question</span></code> est fournie automatiquement&nbsp;; comme nous utilisons un modèle nommé <code class="docutils literal notranslate"><span class="pre">Question</span></code>, Django sait donner un nom approprié à la variable de contexte. Cependant, pour <code class="docutils literal notranslate"><span class="pre">ListView</span></code>, la variable de contexte générée automatiquement s’appelle <code class="docutils literal notranslate"><span class="pre">question_list</span></code>. Pour changer cela, nous fournissons l’attribut <code class="docutils literal notranslate"><span class="pre">context_object_name</span></code> pour indiquer que nous souhaitons plutôt la nommer <code class="docutils literal notranslate"><span class="pre">latest_question_list</span></code>. Il serait aussi possible de modifier les templates en utilisant les nouveaux nom de variables par défaut, mais il est beaucoup plus simple d’indiquer à Django les noms de variables que nous souhaitons.</p>
<p>Lancez le serveur et utilisez votre nouvelle application de sondage basée sur les vues génériques.</p>
<p>Pour plus de détails sur les vues génériques, voir la <a class="reference internal" href="../topics/class-based-views/index.html"><span class="doc">documentation des vues génériques</span></a>.</p>
<p>Lorsque vous êtes à l’aise avec les formulaires et les vues génériques, lisez la <a class="reference internal" href="tutorial05.html"><span class="doc">5ème partie de ce tutoriel</span></a> pour apprendre comment tester notre application de sondage.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      
        
          <div class="yui-b" id="sidebar">
            
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../contents.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Écriture de votre première application Django, 4ème partie</a><ul>
<li><a class="reference internal" href="#write-a-minimal-form">Écriture d’un formulaire minimal</a></li>
<li><a class="reference internal" href="#use-generic-views-less-code-is-better">Utilisation des vues génériques&nbsp;: moins de code, c’est mieux</a><ul>
<li><a class="reference internal" href="#amend-urlconf">Correction de l’URLconf</a></li>
<li><a class="reference internal" href="#amend-views">Correction des vues</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Sujet précédent</h4>
  <p class="topless"><a href="tutorial03.html"
                        title="Chapitre précédent">Écriture de votre première application Django, 3ème partie</a></p>
  <h4>Sujet suivant</h4>
  <p class="topless"><a href="tutorial05.html"
                        title="Chapitre suivant">Écriture de votre première application Django, 5ème partie</a></p>
  <div role="note" aria-label="source link">
    <h3>Cette page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/intro/tutorial04.txt"
            rel="nofollow">Montrer le code source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Recherche rapide</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
              <h3>Last update:</h3>
              <p class="topless">oct. 29, 2020</p>
          </div>
        
      
    </div>

    <div id="ft">
      <div class="nav">
    &laquo; <a href="tutorial03.html" title="Écriture de votre première application Django, 3ème partie">previous</a>
     |
    <a href="index.html" title="Premiers pas" accesskey="U">up</a>
   |
    <a href="tutorial05.html" title="Écriture de votre première application Django, 5ème partie">next</a> &raquo;</div>
    </div>
  </div>

      <div class="clearer"></div>
    </div>
  </body>
</html>